================================================================
FILE: api/gdoc-proxy.js
================================================================
export default async function handler(req, res) {
  const docUrl = 'https://docs.google.com/document/d/e/2PACX-1vRON0qRusw-ReJWYTqB9M1rJK_9_QP8KYLBs81ZJXHw5rzySrEnQeF6zXr2OZMfwPe8P8zsJIKUOS8D/pub';

  try {
    const response = await fetch(docUrl);
    if (!response.ok) throw new Error(`Google Docs fetch failed: ${response.status}`);
    const html = await response.text();

    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Cache-Control', 's-maxage=300, stale-while-revalidate=600');
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.status(200).send(html);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}


================================================================
FILE: api/gdoc-proxy-user.js
================================================================
export default async function handler(req, res) {
  const docUrl = 'https://docs.google.com/document/d/e/2PACX-1vQgPFWcyRsN8wdXgYFNVyoLgKpaH05WnBgFkXYuJR-aN3UVUz5VwThGp4ORinzC-Am24VruwdN3jr2Z/pub';

  try {
    const response = await fetch(docUrl);
    if (!response.ok) throw new Error(`Google Docs fetch failed: ${response.status}`);
    const html = await response.text();

    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Cache-Control', 's-maxage=300, stale-while-revalidate=600');
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.status(200).send(html);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}


================================================================
FILE: api/gemini-proxy.js
================================================================
export default async function handler(req, res) {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const API_KEY = process.env.GEMINI_API_KEY;

  if (!API_KEY) {
    return res.status(500).json({ error: 'GEMINI_API_KEY is not configured' });
  }

  try {
    const body = req.body;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }
    );

    const data = await response.json();

    if (!response.ok) {
      return res.status(response.status).json(data);
    }

    res.status(200).json(data);
  } catch (error) {
    console.error('Gemini proxy error:', error);
    res.status(500).json({ error: error.message });
  }
}


================================================================
FILE: public/manual/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="0; url=/manual/videos/">
    <title>パートナー様向けマニュアル | BakuApo</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/bakuapo-logo.svg" type="image/svg+xml">
</head>
<body>
    <p>リダイレクト中... <a href="/manual/videos/">こちら</a></p>
    <script>window.location.replace('/manual/videos/');</script>
</body>
</html>


================================================================
FILE: public/user-guide/contact-form/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カスタマーサポートへのお問い合わせ — BakuApo ユーザーガイド</title>
    <meta name="description" content="BakuApoカスタマーサポートへのお問い合わせページです。">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 58px; }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 640px;
            margin: 0 auto;
            padding: 16px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
            width: 100%;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { color: var(--border); user-select: none; }

        /* --- Main Content --- */
        .main-content {
            max-width: 640px;
            margin: 0 auto;
            padding: 48px 24px 60px;
            width: 100%;
            flex: 1;
        }

        .page-hero {
            text-align: center;
            margin-bottom: 40px;
        }
        .page-hero-icon {
            width: 64px;
            height: 64px;
            background: var(--accent-light);
            border-radius: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .page-hero-icon svg {
            width: 32px;
            height: 32px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .page-hero h1 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
        }
        .page-hero p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        /* --- Contact Card --- */
        .contact-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 36px 32px;
            text-align: center;
            box-shadow: 0 2px 16px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }
        .contact-card h2 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        .contact-card p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 8px;
        }
        .email-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
            font-weight: 700;
            color: var(--accent);
            margin: 16px 0 24px;
            word-break: break-all;
        }
        .email-display svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .btn-email {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            background: var(--accent);
            padding: 16px 40px;
            border-radius: 14px;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(8,82,255,0.18);
            font-family: inherit;
        }
        .btn-email:hover {
            background: #063FCC;
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(8,82,255,0.25);
        }
        .btn-email svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #fff;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- Footer Links --- */
        .footer-links {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }
        .footer-link-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .footer-link-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(8,82,255,0.08);
        }
        .footer-link-card svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .footer-link-card .link-text {
            font-size: 14px;
            font-weight: 600;
        }
        .footer-link-card .link-url {
            font-size: 12px;
            color: var(--text-muted);
        }
        .footer-link-card .link-arrow {
            margin-left: auto;
            color: var(--text-muted);
        }

        /* --- Site Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            font-size: 13px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
        }

        @media (max-width: 640px) {
            .header-logo img { height: 40px; }
            .main-content { padding: 32px 16px 48px; }
            .page-hero h1 { font-size: 22px; }
            .contact-card { padding: 28px 20px; }
            .btn-email { padding: 14px 32px; font-size: 15px; }
        }
    </style>
</head>
<body>

    <!-- ======== Header ======== -->
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">ご利用ユーザー様専用ページ</span>
        </div>
    </header>

    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <span>カスタマーサポート</span>
    </nav>

    <div class="main-content">
        <!-- Hero -->
        <div class="page-hero">
            <div class="page-hero-icon">
                <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <h1>カスタマーサポートへの<br>お問い合わせ</h1>
            <p>カスタマーサポートへの直接のご連絡は、<br>お手数ですが、メールにてお問い合わせください。</p>
        </div>

        <!-- Contact Card -->
        <div class="contact-card">
            <h2>メールでのお問い合わせ</h2>
            <p>下記メールアドレス宛にお問い合わせ内容をお送りください。<br>担当者より折り返しご連絡いたします。</p>
            <div class="email-display">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                info@chainsoda.world
            </div>
            <br>
            <a href="mailto:info@chainsoda.world" class="btn-email">
                <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                メールでのお問い合わせ
            </a>
        </div>

        <!-- Footer Links -->
        <div class="footer-links">
            <a href="/user-guide/contact-chat/" class="footer-link-card">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                <div>
                    <div class="link-text">AIチャットでのお問い合わせはこちら</div>
                    <div class="link-url">partner.bakuapo.com/user-guide/contact-chat/</div>
                </div>
                <span class="link-arrow">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </a>
            <a href="/user-guide/" class="footer-link-card">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <div>
                    <div class="link-text">ユーザーガイドTOPはこちら</div>
                    <div class="link-url">partner.bakuapo.com/user-guide/</div>
                </div>
                <span class="link-arrow">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                </span>
            </a>
        </div>
    </div>

    <footer class="site-footer">
        <p>&copy; 2026 BakuApo &amp; CHAINSODA Co., Ltd. — All rights reserved.</p>
    </footer>
</body>
</html>


================================================================
FILE: public/user-guide/news/260223/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows版アップデート時の不具合について — BakuApo</title>
    <meta name="description" content="旧BakuApoがインストールされているWindows PCで最新版へアップグレードする際に発生する「NSIS Error」についての情報と解消方法をご案内します。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="Windows版アップデート時の不具合について — BakuApo">
    <meta property="og:description" content="旧BakuApoアップデート時に発生する「NSIS Error」の解消方法をご案内します。">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="BakuApo">
    <meta property="og:locale" content="ja_JP">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-logo img { height: 58px; }
        .header-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 780px;
            margin: 0 auto;
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep {
            color: var(--border);
            user-select: none;
        }

        /* --- Article --- */
        .article {
            max-width: 780px;
            margin: 0 auto;
            padding: 32px 24px 100px;
        }

        /* --- Article Header --- */
        .article-header {
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
        }
        .article-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .article-date {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            font-family: 'Inter', monospace;
        }
        .article-tag {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.03em;
            padding: 4px 12px;
            border-radius: 100px;
            white-space: nowrap;
        }
        .article-tag.bug {
            background: rgba(239,68,68,0.08);
            color: #EF4444;
        }
        .article-tag.update {
            background: rgba(8,82,255,0.08);
            color: #0852FF;
        }
        .article-tag.info {
            background: rgba(16,185,129,0.08);
            color: #10B981;
        }
        .article-tag.maintenance {
            background: rgba(245,158,11,0.08);
            color: #D97706;
        }

        .article-header h1 {
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1.3;
            color: var(--text-primary);
        }

        /* --- Article Body --- */
        .article-body h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.4;
            color: var(--text-primary);
            margin: 48px 0 16px;
            padding-left: 16px;
            border-left: 3px solid var(--accent);
        }
        .article-body h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 32px 0 12px;
        }
        .article-body p {
            margin-bottom: 16px;
            color: var(--text-primary);
            line-height: 1.9;
        }
        .article-body ul, .article-body ol {
            margin: 12px 0 20px 24px;
            color: var(--text-primary);
        }
        .article-body li {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        .article-body a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .article-body a:hover {
            text-decoration-thickness: 2px;
        }

        /* --- Callout --- */
        .callout {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px 28px;
            margin: 24px 0;
        }
        .callout.danger {
            border-left: 4px solid var(--danger);
            background: rgba(239,68,68,0.03);
        }
        .callout.warning {
            border-left: 4px solid var(--warning);
            background: rgba(245,158,11,0.03);
        }
        .callout.info {
            border-left: 4px solid var(--accent);
            background: rgba(8,82,255,0.03);
        }
        .callout.success {
            border-left: 4px solid var(--success);
            background: rgba(16,185,129,0.03);
        }
        .callout-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .callout-title svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .callout p {
            font-size: 14px;
            margin-bottom: 0;
            color: var(--text-secondary);
        }
        .callout p + p {
            margin-top: 8px;
        }

        /* --- Steps --- */
        .article-body .steps {
            margin: 20px 0 28px 0;
            padding: 0;
            list-style: none;
            counter-reset: step-counter;
        }
        .steps li {
            counter-increment: step-counter;
            position: relative;
            padding: 16px 20px 16px 56px;
            margin-bottom: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            width: 100%;
        }
        .steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 16px;
            top: 16px;
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
        }

        /* --- Divider --- */
        .article-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 40px 0;
        }

        /* --- Back link --- */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 48px;
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-decoration: none;
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .back-link:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(8,82,255,0.08);
            transform: translateY(-1px);
        }
        .back-link svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.2s ease;
        }
        .back-link:hover svg {
            transform: translateX(-3px);
        }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
        }
        .site-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .article { padding: 24px 16px 60px; }
            .breadcrumb { padding: 16px 16px 0; }
            .header-inner { padding: 14px 16px; }
            .callout { padding: 20px; }
            .steps li { padding: 14px 16px 14px 50px; }
            .steps li::before { left: 12px; top: 14px; }
        }
        @media (max-width: 480px) {
            .header-logo img { height: 40px; }
            .article-header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>

    <!-- ======== Header ======== -->
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">ご利用ユーザー様専用ページ</span>
        </div>
    </header>

    <!-- ======== Breadcrumb ======== -->
    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <a href="/user-guide/">最新情報</a>
        <span class="sep">›</span>
        <span>Windows版アップデート時の不具合について</span>
    </nav>

    <!-- ======== Article ======== -->
    <article class="article">

        <!-- Header -->
        <header class="article-header">
            <div class="article-meta">
                <span class="article-date">2026.02.23</span>
                <span class="article-tag bug">不具合情報</span>
            </div>
            <h1>Windows版アップデート時の不具合について</h1>
        </header>

        <!-- Body -->
        <div class="article-body">

            <p>旧BakuApoがインストールされているWindows PCで最新版へアップグレードしようとすると、</p>

            <div class="callout danger">
                <div class="callout-title" style="color:var(--danger);">
                    <svg stroke="var(--danger)" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    発生する症状
                </div>
                <p>・旧版のアンインストール時に<strong>「NSIS Error」</strong>が発生</p>
                <p>・その結果、新版のインストールも開始できない</p>
            </div>

            <p>というループが発生する場合があります。</p>

            <hr class="article-divider">

            <!-- ───── 解消方法 ───── -->
            <h2>解消方法（暫定対応）</h2>

            <p>Windowsの「設定」→「アプリ」からの通常アンインストールではエラーが出るため、<strong>IObit社の無料アンインストーラー</strong>などのツールを使用します。</p>

            <div class="callout info">
                <div class="callout-title" style="color:var(--accent);">
                    <svg stroke="var(--accent)" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    使用ツール
                </div>
                <p><strong>IObit Uninstaller（無料版）</strong></p>
                <img src="/IObit-Uninstaller.webp" alt="IObit Uninstaller" style="display:block;width:200px;margin:12px 0 16px;border-radius:12px;">
                <p><a href="https://jp.iobit.com/pc-optimization-software/iobit-uninstaller-free.html" target="_blank" rel="noopener noreferrer">https://jp.iobit.com/pc-optimization-software/iobit-uninstaller-free.html</a></p>
                <p style="margin-top:12px;"><a href="https://jp.iobit.com/pc-optimization-software/iobit-uninstaller-free.html" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:var(--bg-alt);border:1px solid var(--border);border-radius:8px;font-size:13px;font-weight:600;color:var(--text-primary);text-decoration:none;transition:all .2s ease;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-primary)';">IObit Uninstaller（無料版）のダウンロードはこちら <svg width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M7 17L17 7'/><path d='M7 7h10v10'/></svg></a></p>
            </div>

            <h3>手順</h3>

            <ol class="steps">
                <li>上記サイトより<strong>「IObit Uninstaller（無料版）」</strong>をダウンロード</li>
                <li><strong>IObit Uninstaller</strong>を起動</li>
                <li>一覧より<strong>旧BakuApo</strong>を選択し、残存ファイル含むすべてをアンインストール
                    <img src="/news_260223-1.png" alt="IObit Uninstallerで旧BakuApoをアンインストール" style="display:block;width:100%;margin-top:14px;border-radius:14px;">
                </li>
                <li>削除完了後、<strong>最新版BakuApo</strong>を起動</li>
            </ol>

            <p>これにより、通常どおりインストールが開始されます。</p>

            <hr class="article-divider">

            <!-- ───── 原因 ───── -->
            <h2>原因</h2>

            <p>旧BakuApoのアンインストーラーが正常に動作せず、システム上に削除しきれていない情報が残ることで、新版のインストールがブロックされる状態です。</p>

            <hr class="article-divider">

            <!-- ───── 今後について ───── -->
            <h2>今後について</h2>

            <div class="callout success">
                <div class="callout-title" style="color:var(--success);">
                    <svg stroke="var(--success)" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    対応予定
                </div>
                <p>現在、根本原因を調査中です。</p>
                <p><strong>2026年2月23日以降にリリース予定の、BakuApo ver 2にて解消予定</strong>です。</p>
            </div>

            <!-- Back link -->
            <a href="/user-guide/" class="back-link">
                <svg viewBox="0 0 24 24"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                ユーザーガイドに戻る
            </a>

        </div>
    </article>

    <!-- ======== Footer ======== -->
    <footer class="site-footer">
        <p>&copy; 2026 BakuApo — All rights reserved.</p>
    </footer>

</body>
</html>


================================================================
FILE: public/user-guide/news/260224/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakuApoツール Ver. 1.2.0 リリースのお知らせ — BakuApo</title>
    <meta name="description" content="2026年2月24日、BakuApoツール Ver. 1.2.0 をリリースいたしました。最新版のダウンロード方法やアップデート時のご注意事項をご案内いたします。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="BakuApoツール Ver. 1.2.0 リリースのお知らせ — BakuApo">
    <meta property="og:description" content="BakuApoツール Ver. 1.2.0 をリリースいたしました。最新版のダウンロード方法をご案内いたします。">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="BakuApo">
    <meta property="og:locale" content="ja_JP">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-logo img { height: 58px; }
        .header-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 780px;
            margin: 0 auto;
            padding: 20px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep {
            color: var(--border);
            user-select: none;
        }

        /* --- Article --- */
        .article {
            max-width: 780px;
            margin: 0 auto;
            padding: 32px 24px 100px;
        }

        /* --- Article Header --- */
        .article-header {
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
        }
        .article-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .article-date {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            font-family: 'Inter', monospace;
        }
        .article-tag {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.03em;
            padding: 4px 12px;
            border-radius: 100px;
            white-space: nowrap;
        }
        .article-tag.bug {
            background: rgba(239,68,68,0.08);
            color: #EF4444;
        }
        .article-tag.update {
            background: rgba(8,82,255,0.08);
            color: #0852FF;
        }
        .article-tag.info {
            background: rgba(16,185,129,0.08);
            color: #10B981;
        }
        .article-tag.maintenance {
            background: rgba(245,158,11,0.08);
            color: #D97706;
        }

        .article-header h1 {
            font-size: clamp(24px, 4vw, 32px);
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1.3;
            color: var(--text-primary);
        }

        /* --- Article Body --- */
        .article-body h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.4;
            color: var(--text-primary);
            margin: 48px 0 16px;
            padding-left: 16px;
            border-left: 3px solid var(--accent);
        }
        .article-body h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 32px 0 12px;
        }
        .article-body p {
            margin-bottom: 16px;
            color: var(--text-primary);
            line-height: 1.9;
        }
        .article-body ul, .article-body ol {
            margin: 12px 0 20px 24px;
            color: var(--text-primary);
        }
        .article-body li {
            margin-bottom: 8px;
            line-height: 1.8;
        }
        .article-body a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .article-body a:hover {
            text-decoration-thickness: 2px;
        }

        /* --- Callout --- */
        .callout {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px 28px;
            margin: 24px 0;
        }
        .callout.danger {
            border-left: 4px solid var(--danger);
            background: rgba(239,68,68,0.03);
        }
        .callout.warning {
            border-left: 4px solid var(--warning);
            background: rgba(245,158,11,0.03);
        }
        .callout.info {
            border-left: 4px solid var(--accent);
            background: rgba(8,82,255,0.03);
        }
        .callout.success {
            border-left: 4px solid var(--success);
            background: rgba(16,185,129,0.03);
        }
        .callout-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .callout-title svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .callout p {
            font-size: 14px;
            margin-bottom: 0;
            color: var(--text-secondary);
        }
        .callout p + p {
            margin-top: 8px;
        }

        /* --- Download CTA --- */
        .dl-cta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 28px 0;
            padding: 20px 24px;
            background: var(--accent-light);
            border: 1px solid rgba(8,82,255,0.15);
            border-radius: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .dl-cta:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 16px rgba(8,82,255,0.12);
            transform: translateY(-1px);
        }
        .dl-cta-icon {
            width: 44px;
            height: 44px;
            background: var(--accent);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .dl-cta-icon svg {
            width: 22px;
            height: 22px;
            stroke: #fff;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .dl-cta-text {
            flex: 1;
        }
        .dl-cta-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1.4;
        }
        .dl-cta-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .dl-cta-arrow {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }
        .dl-cta:hover .dl-cta-arrow {
            transform: translateX(3px);
        }
        .article-body .dl-cta {
            text-decoration: none;
        }
        .article-body .dl-cta:hover {
            text-decoration: none;
        }

        /* --- Divider --- */
        .article-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 40px 0;
        }

        /* --- Back link --- */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 48px;
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-decoration: none;
            color: var(--accent);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .back-link:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(8,82,255,0.08);
            transform: translateY(-1px);
        }
        .back-link svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.2s ease;
        }
        .back-link:hover svg {
            transform: translateX(-3px);
        }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
        }
        .site-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .article { padding: 24px 16px 60px; }
            .breadcrumb { padding: 16px 16px 0; }
            .header-inner { padding: 14px 16px; }
            .callout { padding: 20px; }
            .dl-cta { padding: 16px 18px; flex-wrap: wrap; }
        }
        @media (max-width: 480px) {
            .header-logo img { height: 40px; }
            .article-header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>

    <!-- ======== Header ======== -->
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">ご利用ユーザー様専用ページ</span>
        </div>
    </header>

    <!-- ======== Breadcrumb ======== -->
    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <a href="/user-guide/">最新情報</a>
        <span class="sep">›</span>
        <span>BakuApoツール Ver. 1.2.0 リリースのお知らせ</span>
    </nav>

    <!-- ======== Article ======== -->
    <article class="article">

        <!-- Header -->
        <header class="article-header">
            <div class="article-meta">
                <span class="article-date">2026.02.24</span>
                <span class="article-tag update">アップデート</span>
            </div>
            <h1>BakuApoツール Ver. 1.2.0 リリースのお知らせ</h1>
        </header>

        <!-- Body -->
        <div class="article-body">

            <p>平素よりBakuApo（バクアポ）をご利用いただき、誠にありがとうございます。</p>

            <p>2026年2月24日付で、BakuApoツールの最新バージョン <strong>Ver. 1.2.0</strong> をリリースいたしましたことをお知らせいたします。</p>

            <hr class="article-divider">

            <!-- ───── ダウンロード ───── -->
            <h2>最新バージョンのダウンロード</h2>

            <p>過去バージョンをご利用中のお客様は、下記のダウンロードページより最新版を取得のうえ、アップデートをお願いいたします。</p>

            <a href="/user-guide/download/" class="dl-cta">
                <div class="dl-cta-icon">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </div>
                <div class="dl-cta-text">
                    <div class="dl-cta-title">BakuApo Ver. 1.2.0 をダウンロード</div>
                    <div class="dl-cta-sub">Windows（.exe）・macOS（.dmg）対応</div>
                </div>
                <svg class="dl-cta-arrow" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>
            </a>

            <hr class="article-divider">

            <!-- ───── 注意事項 ───── -->
            <h2>アップデート時のご注意（Windows版）</h2>

            <div class="callout warning">
                <div class="callout-title" style="color:#D97706;">
                    <svg stroke="#D97706" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Windows版をご利用のお客様へ
                </div>
                <p>現在、Windows版の一部のバージョンにおいて、過去バージョンのアンインストール時に<strong>「NSIS Error」</strong>が発生し、最新版のインストールが正常に行えない事象を確認しております。</p>
            </div>

            <p>上記の症状が発生した場合は、以下の記事にてご案内しております手順に従い、旧バージョンをアンインストールしたうえで、最新版のインストールをお試しくださいますようお願いいたします。</p>

            <a href="/user-guide/news/260223/" class="dl-cta" style="background:rgba(245,158,11,0.06);border-color:rgba(245,158,11,0.2);">
                <div class="dl-cta-icon" style="background:#D97706;">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <div class="dl-cta-text">
                    <div class="dl-cta-title" style="color:#D97706;">Windows版アップデート時の不具合について</div>
                    <div class="dl-cta-sub">アンインストールエラーの解消方法をご案内しています</div>
                </div>
                <svg class="dl-cta-arrow" style="stroke:#D97706;" viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>
            </a>

            <hr class="article-divider">

            <!-- ───── お問い合わせ ───── -->
            <h2>お困りの場合</h2>

            <p>アップデートに関してご不明な点やお困りのことがございましたら、お気軽にお問い合わせくださいませ。</p>

            <div class="callout info">
                <div class="callout-title" style="color:var(--accent);">
                    <svg stroke="var(--accent)" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    サポート窓口
                </div>
                <p><a href="/user-guide/contact-chat/">AIチャットサポート</a>にて、24時間いつでもご相談いただけます。</p>
            </div>

            <p>今後とも、BakuApoをご愛顧くださいますようよろしくお願い申し上げます。</p>

            <!-- Back link -->
            <a href="/user-guide/" class="back-link">
                <svg viewBox="0 0 24 24"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                ユーザーガイドに戻る
            </a>

        </div>
    </article>

    <!-- ======== Footer ======== -->
    <footer class="site-footer">
        <p>&copy; 2026 BakuApo — All rights reserved.</p>
    </footer>

</body>
</html>


================================================================
FILE: public/user-guide/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakuApo ユーザーガイド</title>
    <meta name="description" content="BakuApoご利用ユーザー様専用のユーザーガイドです。クイックスタート、ダウンロード、最新情報をご確認いただけます。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="BakuApo ユーザーガイド">
    <meta property="og:description" content="BakuApoご利用ユーザー様専用のユーザーガイドです。">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="BakuApo">
    <meta property="og:locale" content="ja_JP">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F5F7FA;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* --- Ambient Background --- */
        .ambient-glow {
            position: fixed;
            top: -20%;
            left: 50%;
            transform: translateX(-50%);
            width: 900px;
            height: 600px;
            background: radial-gradient(ellipse, rgba(8,82,255,0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 58px; }
        .header-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }

        /* --- Main Content --- */
        .main-content {
            position: relative;
            z-index: 1;
            max-width: 1080px;
            margin: 0 auto;
            padding: 0 24px 100px;
        }

        /* --- Hero --- */
        .hero {
            padding: 72px 0 56px;
            text-align: center;
        }
        .hero-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--accent-light);
            padding: 6px 16px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .hero h1 {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1.2;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .hero-sub {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 520px;
            margin: 0 auto;
        }
        .hero-divider {
            width: 48px;
            height: 2px;
            background: var(--accent);
            margin: 40px auto 0;
            border-radius: 1px;
        }

        /* ============================================================
           Quick Links Section
           ============================================================ */
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .section-title h2 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }
        .section-title .section-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .section-title .section-icon svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .quick-link-card {
            position: relative;
            display: flex;
            align-items: center;
            gap: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            overflow: hidden;
        }
        .quick-link-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(8,82,255,0.08), 0 0 0 1px var(--accent);
        }
        .quick-link-card:active {
            transform: translateY(0);
        }

        .ql-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .ql-icon svg {
            width: 26px;
            height: 26px;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
        }
        .ql-icon.blue { background: rgba(8,82,255,0.08); }
        .ql-icon.blue svg { stroke: #0852FF; }
        .ql-icon.green { background: rgba(16,185,129,0.08); }
        .ql-icon.green svg { stroke: #10B981; }

        .ql-text { flex: 1; min-width: 0; }
        .ql-text h3 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.01em;
            line-height: 1.3;
            margin-bottom: 6px;
            color: var(--text-primary);
        }
        .ql-text p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.55;
        }
        .ql-arrow {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-light);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .quick-link-card:hover .ql-arrow {
            background: var(--accent);
            border-color: var(--accent);
        }
        .ql-arrow svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
        }
        .quick-link-card:hover .ql-arrow svg {
            stroke: #fff;
            transform: translate(1px, -1px);
        }

        /* ============================================================
           News / Articles Section
           ============================================================ */
        .news-section { margin-bottom: 48px; }
        .news-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .news-card {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .news-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(8,82,255,0.08), 0 0 0 1px var(--accent);
        }
        .news-card:active { transform: translateY(0); }

        .news-card-body {
            padding: 24px 24px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .news-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .news-date {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            font-family: 'Inter', monospace;
        }
        .news-tag {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.03em;
            padding: 3px 10px;
            border-radius: 100px;
            white-space: nowrap;
        }
        .news-tag.update {
            background: rgba(8,82,255,0.08);
            color: #0852FF;
        }
        .news-tag.bug {
            background: rgba(239,68,68,0.08);
            color: #EF4444;
        }
        .news-tag.info {
            background: rgba(16,185,129,0.08);
            color: #10B981;
        }
        .news-tag.maintenance {
            background: rgba(245,158,11,0.08);
            color: #D97706;
        }

        .news-card-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
            line-height: 1.4;
            color: var(--text-primary);
        }
        .news-card-excerpt {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 24px;
            border-top: 1px solid var(--border);
            margin-top: auto;
        }
        .news-read-more {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .news-read-more svg {
            width: 14px;
            height: 14px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.2s ease;
        }
        .news-card:hover .news-read-more svg {
            transform: translateX(3px);
        }

        /* ============================================================
           Pagination
           ============================================================ */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 40px;
        }
        .pagination-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            padding: 0 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .pagination-btn:hover:not(.disabled):not(.active) {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-subtle);
        }
        .pagination-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            cursor: default;
        }
        .pagination-btn.disabled {
            opacity: 0.35;
            cursor: not-allowed;
            pointer-events: none;
        }
        .pagination-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .pagination-info {
            font-size: 13px;
            color: var(--text-muted);
            margin-left: 12px;
        }

        /* --- Empty State --- */
        .news-empty {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-muted);
        }
        .news-empty svg {
            width: 48px;
            height: 48px;
            stroke: var(--border);
            fill: none;
            stroke-width: 1.5;
            margin-bottom: 16px;
        }
        .news-empty p { font-size: 14px; }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
        }
        .site-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ============================================================
           Responsive
           ============================================================ */
        @media (max-width: 768px) {
            .quick-links {
                grid-template-columns: 1fr;
                gap: 14px;
            }
            .news-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }
            .hero { padding: 48px 0 40px; }
            .hero h1 { font-size: 26px; }
            .quick-link-card {
                padding: 20px;
                gap: 16px;
            }
            .ql-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
            }
            .ql-icon svg { width: 22px; height: 22px; }
            .main-content { padding: 0 16px 60px; }
            .header-inner { padding: 14px 16px; }
        }

        @media (max-width: 480px) {
            .header-logo img { height: 40px; }
            .news-card-body { padding: 18px 18px 16px; }
            .news-card-footer { padding: 12px 18px; }
            .ql-text h3 { font-size: 15px; }
            .ql-text p { font-size: 12px; }
        }

        /* --- Fade-in animation --- */
        .fade-up {
            opacity: 0;
            transform: translateY(16px);
            animation: fadeUp 0.5s ease forwards;
        }
        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="ambient-glow"></div>

    <!-- ======== Header ======== -->
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/" style="display:flex;align-items:center;text-decoration:none;">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">ご利用ユーザー様専用ページ</span>
        </div>
    </header>

    <main class="main-content">

        <!-- ======== Hero ======== -->
        <section class="hero">
            <p class="hero-eyebrow">User Guide</p>
            <h1>BakuApo ユーザーガイド</h1>
            <p class="hero-sub">ご利用いただきありがとうございます。<br>こちらのページでは、各種ガイドや最新情報をお届けしています。</p>
            <div class="hero-divider"></div>
        </section>

        <!-- ======== Quick Links ======== -->
        <section style="margin-bottom:64px;">
            <div class="section-title">
                <div class="section-icon" style="background:var(--accent-light);">
                    <svg stroke="#0852FF" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                </div>
                <h2>クイックアクセス</h2>
            </div>
            <div class="quick-links">
                <!-- Quick Start Guide -->
                <a href="/user-guide/quick-start/" class="quick-link-card fade-up" style="animation-delay:.1s">
                    <div class="ql-icon blue">
                        <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                    </div>
                    <div class="ql-text">
                        <h3>クイックスタートガイド</h3>
                        <p>BakuApoのインストールから初期設定まで、ステップバイステップでご案内いたします。</p>
                    </div>
                    <div class="ql-arrow">
                        <svg viewBox="0 0 24 24"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>
                    </div>
                </a>
                <!-- Download -->
                <a href="/user-guide/download/" class="quick-link-card fade-up" style="animation-delay:.2s">
                    <div class="ql-icon green">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </div>
                    <div class="ql-text">
                        <h3>ダウンロード</h3>
                        <p>Windows / Mac 対応の最新版インストーラーをこちらからダウンロードいただけます。</p>
                    </div>
                    <div class="ql-arrow">
                        <svg viewBox="0 0 24 24"><path d="M7 17L17 7M17 7H7M17 7V17"/></svg>
                    </div>
                </a>
            </div>
        </section>

        <!-- ======== News / Articles ======== -->
        <section class="news-section">
            <div class="section-title">
                <div class="section-icon" style="background:rgba(245,158,11,0.08);">
                    <svg stroke="#D97706" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <h2>最新情報</h2>
            </div>

            <div class="news-grid" id="newsGrid"></div>

            <div class="pagination" id="pagination" style="display:none;"></div>
        </section>

    </main>

    <!-- ======== Footer ======== -->
    <footer class="site-footer">
        <p>&copy; 2026 BakuApo — All rights reserved.</p>
    </footer>

    <script>
    /* =================================================================
       NEWS_ARTICLES — 記事データ
       =================================================================
       tag の種類: "update" | "bug" | "info" | "maintenance"
       新しい記事を配列の先頭に追加してください。
    */
    const NEWS_ARTICLES = [
        {
            date:     '2026.02.24',
            tag:      'update',
            tagLabel: 'アップデート',
            title:    'BakuApoツール Ver. 1.2.0 リリースのお知らせ',
            excerpt:  'BakuApoツール最新バージョン Ver. 1.2.0 をリリースいたしました。過去バージョンをご利用のお客様は、ダウンロードページより最新版へのアップデートをお願いいたします。',
            url:      '/user-guide/news/260224/'
        },
        {
            date:     '2026.02.23',
            tag:      'bug',
            tagLabel: '不具合情報',
            title:    'Windows版アップデート時の不具合について',
            excerpt:  '旧BakuApoがインストールされているWindows PCで最新版へアップグレードしようとすると、旧版のアンインストール時に「NSIS Error」が発生し、新版のインストールが開始できない場合があります。暫定的な解消方法をご案内しています。',
            url:      '/user-guide/news/260223/'
        }
        // ── 記事を追加する場合はここに追加（新しい記事を上に） ──
        // {
        //     date:     '2026.XX.XX',
        //     tag:      'update',        // update | bug | info | maintenance
        //     tagLabel: 'アップデート',
        //     title:    '記事タイトル',
        //     excerpt:  '記事の概要テキスト...',
        //     url:      '/user-guide/news/XXXXXX/'
        // },
    ];

    /* =================================================================
       Pagination & Rendering
       ================================================================= */
    const PER_PAGE = 6;
    let currentPage = 1;

    function getTotalPages() {
        return Math.max(1, Math.ceil(NEWS_ARTICLES.length / PER_PAGE));
    }
    function getPageArticles(page) {
        const start = (page - 1) * PER_PAGE;
        return NEWS_ARTICLES.slice(start, start + PER_PAGE);
    }

    /* --- 記事カード描画 --- */
    function renderNews(page) {
        const grid = document.getElementById('newsGrid');
        const articles = getPageArticles(page);
        currentPage = page;

        if (articles.length === 0) {
            grid.innerHTML = '<div class="news-empty" style="grid-column:1/-1;">' +
                '<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">' +
                '<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>' +
                '<polyline points="14 2 14 8 20 8"/></svg>' +
                '<p>現在、記事はありません。</p></div>';
            document.getElementById('pagination').style.display = 'none';
            return;
        }

        grid.innerHTML = articles.map(function(a, i) {
            return '<a href="' + a.url + '" class="news-card fade-up" style="animation-delay:' + (i * 0.06) + 's">' +
                '<div class="news-card-body">' +
                    '<div class="news-meta">' +
                        '<span class="news-date">' + a.date + '</span>' +
                        '<span class="news-tag ' + a.tag + '">' + a.tagLabel + '</span>' +
                    '</div>' +
                    '<h3 class="news-card-title">' + a.title + '</h3>' +
                    '<p class="news-card-excerpt">' + a.excerpt + '</p>' +
                '</div>' +
                '<div class="news-card-footer">' +
                    '<span class="news-read-more">' +
                        '続きを読む' +
                        '<svg viewBox="0 0 24 24"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>' +
                    '</span>' +
                '</div>' +
            '</a>';
        }).join('');

        renderPagination();
    }

    /* --- ページネーション描画 --- */
    function renderPagination() {
        var totalPages = getTotalPages();
        var pag = document.getElementById('pagination');

        if (totalPages <= 1) { pag.style.display = 'none'; return; }
        pag.style.display = 'flex';

        var html = '';
        // Prev
        html += '<button class="pagination-btn' + (currentPage <= 1 ? ' disabled' : '') + '" onclick="goPage(' + (currentPage - 1) + ')"' + (currentPage <= 1 ? ' disabled' : '') + '>' +
            '<svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>';

        // Page numbers
        for (var p = 1; p <= totalPages; p++) {
            if (totalPages > 7) {
                if (p === 1 || p === totalPages || (p >= currentPage - 1 && p <= currentPage + 1)) {
                    html += '<button class="pagination-btn' + (p === currentPage ? ' active' : '') + '" onclick="goPage(' + p + ')">' + p + '</button>';
                } else if (p === currentPage - 2 || p === currentPage + 2) {
                    html += '<span class="pagination-btn disabled" style="border:none;background:none;">…</span>';
                }
            } else {
                html += '<button class="pagination-btn' + (p === currentPage ? ' active' : '') + '" onclick="goPage(' + p + ')">' + p + '</button>';
            }
        }

        // Next
        html += '<button class="pagination-btn' + (currentPage >= totalPages ? ' disabled' : '') + '" onclick="goPage(' + (currentPage + 1) + ')"' + (currentPage >= totalPages ? ' disabled' : '') + '>' +
            '<svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></button>';

        // Info
        html += '<span class="pagination-info">' + currentPage + ' / ' + totalPages + ' ページ</span>';
        pag.innerHTML = html;
    }

    function goPage(page) {
        var totalPages = getTotalPages();
        if (page < 1 || page > totalPages) return;
        renderNews(page);
        document.querySelector('.news-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* --- 起動 --- */
    document.addEventListener('DOMContentLoaded', function() { renderNews(1); });
    </script>
</body>
</html>


================================================================
FILE: public/user-guide/download/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakuApo（バクアポ）ダウンロード</title>
    <meta name="description" content="BakuApoご購入者様専用のダウンロードページです。Windows / Mac 対応のインストーラーをこちらからダウンロードいただけます。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="BakuApo（バクアポ）ダウンロード">
    <meta property="og:description" content="BakuApoご購入者様専用のダウンロードページです。Windows / Mac 対応のインストーラーをこちらからダウンロードいただけます。">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 58px; }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: -0.01em;
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 780px;
            margin: 0 auto;
            padding: 16px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep {
            color: var(--border);
            user-select: none;
        }

        /* --- Main --- */
        .main {
            max-width: 780px;
            margin: 0 auto;
            padding: 0 24px 100px;
        }

        /* --- Hero --- */
        .hero {
            padding: 64px 0 48px;
            text-align: center;
        }
        .hero-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--accent-light);
            padding: 6px 16px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .hero h1 {
            font-size: clamp(26px, 4.5vw, 38px);
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1.25;
            margin-bottom: 16px;
        }
        .hero-sub {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 520px;
            margin: 0 auto;
            line-height: 1.8;
        }

        /* --- Download Card --- */
        .dl-hero {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dl-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--success);
            background: rgba(16,185,129,0.08);
            padding: 5px 14px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .dl-hero-badge svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        .dl-hero h3 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }
        .dl-hero .dl-version {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 28px;
        }
        .dl-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .dl-option {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 28px 24px;
            text-decoration: none;
            color: inherit;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }
        .dl-option:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(8,82,255,0.1);
        }
        .dl-option-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dl-option-icon.windows { background: rgba(0,120,215,0.1); }
        .dl-option-icon.mac { background: rgba(0,0,0,0.06); }
        .dl-option-icon svg { width: 28px; height: 28px; }
        .dl-option-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        .dl-option-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .dl-option-file {
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--text-muted);
            background: var(--bg-alt);
            padding: 3px 10px;
            border-radius: 6px;
        }
        .dl-option-size {
            font-size: 12px;
            color: var(--text-muted);
        }
        .dl-option-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            background: var(--accent);
            padding: 10px 24px;
            border-radius: 10px;
            transition: background 0.2s;
            width: 100%;
            justify-content: center;
        }
        .dl-option:hover .dl-option-btn { background: #063FCC; }
        .dl-option-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }
        .dl-trust {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .dl-trust-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .dl-trust-item svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2; flex-shrink: 0; }
        .dl-auto-detect {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .dl-auto-detect strong { color: var(--accent); font-weight: 600; }

        /* --- Callout --- */
        .callout {
            display: flex;
            gap: 14px;
            padding: 20px 24px;
            border-radius: 12px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.7;
        }
        .callout-icon {
            flex-shrink: 0;
            font-size: 20px;
            width: 22px;
            text-align: center;
            margin-top: 2px;
            line-height: 1;
        }
        .callout-info {
            background: var(--accent-light);
            border: 1px solid rgba(8,82,255,0.15);
            color: var(--text-primary);
        }
        .callout-info .callout-icon { color: var(--accent); }
        .callout-warning {
            background: rgba(245,158,11,0.08);
            border: 1px solid rgba(245,158,11,0.2);
            color: var(--text-primary);
        }
        .callout-warning .callout-icon { color: var(--warning); }
        .callout a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .callout a:hover { text-decoration: none; }

        /* --- Guide Link Card --- */
        .guide-link-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            margin-top: 32px;
            transition: box-shadow 0.2s;
        }
        .guide-link-card:hover {
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
        }
        .guide-link-card h3 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guide-link-card h3 svg {
            width: 22px;
            height: 22px;
            color: var(--accent);
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .guide-link-card p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
        }
        .guide-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            color: #fff;
            background: var(--accent);
            padding: 12px 28px;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(8,82,255,0.2);
        }
        .guide-link-btn:hover {
            background: #063FCC;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(8,82,255,0.3);
        }
        .guide-link-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
        }
        .site-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Responsive --- */
        @media (max-width: 640px) {
            .dl-options { grid-template-columns: 1fr; }
            .dl-hero { padding: 28px 20px; }
            .main { padding: 0 16px 80px; }
            .guide-link-card { padding: 24px 20px; }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">BakuApoご購入者様専用｜ダウンロード</span>
        </div>
    </header>

    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <span>ダウンロード</span>
    </nav>

    <main class="main">
        <!-- Hero -->
        <section class="hero">
            <span class="hero-eyebrow">Download</span>
            <h1>BakuApo ダウンロード</h1>
            <p class="hero-sub">
                お使いのOS（Windows / Mac）に合わせて、<br>
                以下よりインストーラーをダウンロードしてください。
            </p>
        </section>

        <!-- Download Card -->
        <div class="dl-hero">
            <span class="dl-hero-badge">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                最新バージョンをダウンロード
            </span>
            <h3>BakuApo（バクアポ）</h3>
            <p class="dl-version">Version 1.2.0</p>
            <p class="dl-auto-detect" id="osDetect"></p>

            <div class="dl-options">
                <!-- Windows -->
                <a href="https://pub-f05486cd473b432092da184cec71eb70.r2.dev/bakuapo/app-download/BakuApo_1.2.0.exe" download class="dl-option" id="dlWindows">
                    <div class="dl-option-icon windows">
                        <svg viewBox="0 0 24 24" fill="#0078D7"><path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg>
                    </div>
                    <span class="dl-option-title">Windows</span>
                    <div class="dl-option-meta">
                        <span class="dl-option-file">.exe インストーラー</span>
                        <span class="dl-option-size">290 MB</span>
                    </div>
                    <span class="dl-option-btn">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        ダウンロード
                    </span>
                </a>
                <!-- Mac -->
                <a href="https://pub-f05486cd473b432092da184cec71eb70.r2.dev/bakuapo/app-download/BakuApo_1.2.0.dmg" download class="dl-option" id="dlMac">
                    <div class="dl-option-icon mac">
                        <svg viewBox="0 0 24 24" fill="#000"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                    </div>
                    <span class="dl-option-title">macOS</span>
                    <div class="dl-option-meta">
                        <span class="dl-option-file">.dmg ディスクイメージ</span>
                        <span class="dl-option-size">199 MB（Apple Silicon）</span>
                    </div>
                    <span class="dl-option-btn">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        ダウンロード
                    </span>
                </a>
            </div>

            <div class="dl-trust">
                <span class="dl-trust-item">
                    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    安全なサーバーから配信
                </span>
                <span class="dl-trust-item">
                    <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    ウイルスチェック済み
                </span>
                <span class="dl-trust-item">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    ワンクリックで即時ダウンロード
                </span>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 16px; line-height: 1.6; max-width: 480px; margin-left: auto; margin-right: auto;">
                本ツールは Cloudflare のグローバルネットワーク上で<br>ホスティングされており、安全に配信されています。
            </p>
        </div>

        <!-- Callout -->
        <div class="callout callout-warning">
            <i class="fa-solid fa-triangle-exclamation callout-icon" style="color:var(--warning);"></i>
            <div>
                ダウンロード後のインストール時に、WindowsやmacOSのセキュリティ警告が表示される場合があります。<br>
                詳しい対処方法は、下記の<strong>クイックスタートガイド</strong>をご参照ください。
            </div>
        </div>

        <div class="callout callout-info">
            <i class="fa-solid fa-circle-info callout-icon" style="color:var(--accent);"></i>
            <div>
                <strong>お困りの場合</strong><br>
                アップデートやインストールに関してご不明な点がございましたら、お気軽にお問い合わせくださいませ。<br>
                <a href="/user-guide/contact-chat/">AIチャットサポート</a>にて、24時間いつでもご相談いただけます。
            </div>
        </div>

        <!-- Guide Link Card -->
        <div class="guide-link-card">
            <h3>
                <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>
                詳細なインストール方法はこちら
            </h3>
            <p>
                インストール手順・セキュリティ設定の解除方法・初回起動の手順など、<br>
                画像付きでわかりやすく解説しています。
            </p>
            <a href="/user-guide/quick-start/" class="guide-link-btn">
                <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
                クイックスタートガイドを見る
            </a>
        </div>
    </main>

    <footer class="site-footer">
        <p>&copy; 2026 BakuApo &amp; CHAINSODA Co., Ltd. — All rights reserved.</p>
    </footer>

    <script>
    (function(){
        var ua = navigator.userAgent;
        var el = document.getElementById('osDetect');
        if (!el) return;
        if (/Windows/i.test(ua)) {
            el.innerHTML = 'お使いのOSは <strong>Windows</strong> です';
            var w = document.getElementById('dlWindows');
            if (w) w.style.borderColor = 'var(--accent)';
        } else if (/Mac/i.test(ua)) {
            el.innerHTML = 'お使いのOSは <strong>macOS</strong> です';
            var m = document.getElementById('dlMac');
            if (m) m.style.borderColor = 'var(--accent)';
        }
    })();
    </script>
</body>
</html>


================================================================
FILE: public/user-guide/contact-chat/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIチャットサポート — BakuApo ユーザーガイド</title>
    <meta name="description" content="BakuApoに関するご質問にAIチャットがお答えいたします。">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 58px; }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
            width: 100%;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep { color: var(--border); user-select: none; }

        /* --- Main Content --- */
        .main-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 32px 24px 60px;
            width: 100%;
            flex: 1;
        }

        .page-hero {
            text-align: center;
            margin-bottom: 32px;
        }
        .page-hero-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-light);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .page-hero-icon svg {
            width: 28px;
            height: 28px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .page-hero h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }
        .page-hero p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* --- Chat Container --- */
        .chat-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 16px rgba(0,0,0,0.04);
        }
        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-alt);
        }
        .chat-header-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .chat-header-avatar svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }
        .chat-header-info h3 {
            font-size: 14px;
            font-weight: 700;
        }
        .chat-header-info p {
            font-size: 12px;
            color: var(--text-muted);
        }
        .chat-status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            font-size: 12px;
            color: var(--success);
            font-weight: 600;
        }
        .chat-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* --- Messages --- */
        .chat-messages {
            height: 420px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 3px; }

        .msg {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: msg-in 0.3s ease;
        }
        @keyframes msg-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg.bot { align-self: flex-start; }
        .msg.user { align-self: flex-end; flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .msg.bot .msg-avatar {
            background: var(--accent-light);
        }
        .msg.bot .msg-avatar svg {
            width: 18px;
            height: 18px;
            fill: var(--accent);
        }
        .msg.user .msg-avatar {
            background: var(--bg-alt);
        }
        .msg.user .msg-avatar svg {
            width: 18px;
            height: 18px;
            fill: var(--text-muted);
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.8;
        }
        .msg.bot .msg-bubble {
            background: var(--bg-alt);
            color: var(--text-primary);
            border-top-left-radius: 4px;
        }
        .msg.user .msg-bubble {
            background: var(--accent);
            color: #fff;
            border-top-right-radius: 4px;
        }
        .msg-bubble a {
            color: var(--accent);
            text-decoration: underline;
            word-break: break-all;
        }
        .msg.user .msg-bubble a {
            color: #fff;
        }

        /* --- Typing indicator --- */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            gap: 10px;
            max-width: 85%;
        }
        .typing-indicator.visible { display: flex; }
        .typing-dots {
            padding: 14px 18px;
            background: var(--bg-alt);
            border-radius: 14px;
            border-top-left-radius: 4px;
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .typing-dots span {
            width: 7px;
            height: 7px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* --- Resolution prompt --- */
        .resolution-prompt {
            align-self: center;
            text-align: center;
            animation: msg-in 0.3s ease;
        }
        .resolution-btn {
            display: inline-block;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px;
            font-family: inherit;
        }
        .resolution-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-light);
        }
        .resolution-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        /* --- Input --- */
        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: var(--bg-card);
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            color: var(--text-primary);
            background: var(--bg);
            resize: none;
            line-height: 1.6;
            max-height: 120px;
            transition: border-color 0.2s;
        }
        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .chat-input::placeholder { color: var(--text-muted); }
        .chat-send-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--accent);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .chat-send-btn:hover { background: #063FCC; }
        .chat-send-btn:disabled { background: var(--border); cursor: not-allowed; }
        .chat-send-btn svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        /* --- Footer Links --- */
        .footer-links {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 24px 60px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .footer-link-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .footer-link-card:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(8,82,255,0.08);
        }
        .footer-link-card svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .footer-link-card .link-text {
            font-size: 14px;
            font-weight: 600;
        }
        .footer-link-card .link-url {
            font-size: 12px;
            color: var(--text-muted);
        }
        .footer-link-card .link-arrow {
            margin-left: auto;
            color: var(--text-muted);
        }

        /* --- Site Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            font-size: 13px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
        }

        @media (max-width: 640px) {
            .header-logo img { height: 40px; }
            .main-content { padding: 24px 16px 48px; }
            .page-hero h1 { font-size: 20px; }
            .chat-messages { height: 360px; padding: 16px; }
            .msg { max-width: 92%; }
            .footer-links { padding: 0 16px 48px; }
        }
    </style>
</head>
<body>

    <!-- ======== Header ======== -->
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">ご利用ユーザー様専用ページ</span>
        </div>
    </header>

    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <span>AIチャットサポート</span>
    </nav>

    <div class="main-content">
        <!-- Hero -->
        <div class="page-hero">
            <div class="page-hero-icon">
                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
            </div>
            <h1>ご質問内容をご入力ください</h1>
            <p>チャットでAIがお答えいたします</p>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-avatar">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z"/></svg>
                </div>
                <div class="chat-header-info">
                    <h3>BakuApo サポート</h3>
                    <p>AIアシスタント</p>
                </div>
                <div class="chat-status">オンライン</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Initial bot message -->
                <div class="msg bot">
                    <div class="msg-avatar">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z"/></svg>
                    </div>
                    <div class="msg-bubble">
                        BakuApoサポートへようこそ。<br>ご質問やお困りのことがございましたら、お気軽にお聞きください。
                    </div>
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="msg-avatar">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z"/></svg>
                    </div>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <textarea class="chat-input" id="chatInput" rows="1" placeholder="メッセージを入力..."></textarea>
                <button class="chat-send-btn" id="sendBtn" disabled>
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer Links -->
    <div class="footer-links">
        <a href="/user-guide/quick-start/" class="footer-link-card">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            <div>
                <div class="link-text">クイックスタートガイドはこちら</div>
                <div class="link-url">partner.bakuapo.com/user-guide/quick-start/</div>
            </div>
            <span class="link-arrow">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
            </span>
        </a>
        <a href="/user-guide/" class="footer-link-card">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <div>
                <div class="link-text">ユーザーガイドTOPはこちら</div>
                <div class="link-url">partner.bakuapo.com/user-guide/</div>
            </div>
            <span class="link-arrow">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" fill="none" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
            </span>
        </a>
    </div>

    <footer class="site-footer">
        <p>&copy; 2026 BakuApo &amp; CHAINSODA Co., Ltd. — All rights reserved.</p>
    </footer>

    <script>
    const GEMINI_PROXY_URL = '/api/gemini-proxy';

    const SYSTEM_PROMPT = `あなたは、BakuApo（バクアポ）運営事務局のカスタマーサポートです。BakuApoツールをご利用いただいているお客様に対して、課題解決のお手伝いをします。
丁寧な言葉遣いを心がけ、嘘はつかず、お客様に対してストレスを与えない言葉遣いで答えてください。
お客様の文句や汚い言葉遣いに対しては、紳士的かつプライドを持って対応しましょう。
あまり長い返答はせず、過不足ない簡潔な回答を心がけてください。

以下はサイト内の主要な情報です。回答に活用してください。

【ダウンロード】
- Windows: BakuApo_1.2.0.exe（290MB）
  ダウンロードページ: https://partner.bakuapo.com/user-guide/quick-start/#download
- Mac (Apple Silicon): BakuApo_1.2.0.dmg（199MB）
  ダウンロードページ: https://partner.bakuapo.com/user-guide/quick-start/#download
- 現在のバージョン: 1.2.0

【Windowsセットアップ】
1. BakuApo_1.2.0.exeをダブルクリックして実行
2. Windows SmartScreen警告 → 「詳細情報」→「実行」で進める
3. Edge「一般的にダウンロードされていません」→ 「…」→「保存」
セットアップ詳細: https://partner.bakuapo.com/user-guide/quick-start/#setup-windows

【Macセットアップ】
1. BakuApo_1.2.0.dmgをダブルクリック
2. BakuApo Simpleを「アプリケーション」フォルダにドラッグ
3. Finderで確認してダブルクリックで起動
⚠️「壊れているため開けません」エラー → 「キャンセル」→ ターミナルで以下を実行:
xattr -cr /Applications/BAKUAPO\\ Simple.app
セットアップ詳細: https://partner.bakuapo.com/user-guide/quick-start/#setup-mac

【NSIS Error（Windows旧版アップデート時）】
旧BakuApoインストール済みPCで最新版にアップグレード時に「NSIS Error」が発生する場合:
→ IObit Uninstaller（無料版）で旧BakuApoを完全削除してから再インストール
詳細: https://partner.bakuapo.com/user-guide/news/260223/

【料金・決済】
- 価格: ¥550,000（税込）買い切り
- 支払方法: クレジットカード（Stripe）または銀行振込
- 決済ページ: https://partner.bakuapo.com/checkout/

【銀行振込先】
GMOあおぞらネット銀行 法人第二営業部 普通 1389280 カ)チェインソーダ

【お問い合わせ先】
メール: info@chainsoda.world
カスタマーサポートページ: https://partner.bakuapo.com/user-guide/contact-form/

【関連ページ】
- ユーザーガイドTOP: https://partner.bakuapo.com/user-guide/
- クイックスタートガイド: https://partner.bakuapo.com/user-guide/quick-start/
- アプリ操作方法（動画）: https://partner.bakuapo.com/user-guide/quick-start/#usage

やり取りの中で「会話が一段落した」と判断した場合（お客様が「ありがとう」「わかりました」等で締めた場合や、解決策を提示し終えた場合）、返答の最後に必ず以下のタグを含めてください:
[RESOLUTION_CHECK]
このタグはシステムが検知して「問題は解決しましたか？」ボタンを表示するために使います。お客様には見えません。`;

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    let conversationHistory = [];
    let resolutionShown = false;
    let messageCount = 0;

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        sendBtn.disabled = !chatInput.value.trim();
    });

    // Cmd+Enter (Mac) / Ctrl+Enter (Win) to send
    chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
            e.preventDefault();
            if (chatInput.value.trim()) sendMessage();
        }
    });

    sendBtn.addEventListener('click', () => {
        if (chatInput.value.trim()) sendMessage();
    });

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendMessage(role, html) {
        const avatarSvg = role === 'bot'
            ? '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z"/></svg>'
            : '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';

        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${role}`;
        msgDiv.innerHTML = `
            <div class="msg-avatar">${avatarSvg}</div>
            <div class="msg-bubble">${html}</div>
        `;
        // Insert before typing indicator
        chatMessages.insertBefore(msgDiv, typingIndicator);
        scrollToBottom();
    }

    function showResolutionPrompt() {
        if (resolutionShown) return;
        resolutionShown = true;

        const div = document.createElement('div');
        div.className = 'resolution-prompt';
        div.innerHTML = `
            <p class="resolution-label">問題は解決しましたか？</p>
            <button class="resolution-btn" onclick="handleResolution(true)">解決した</button>
            <button class="resolution-btn" onclick="handleResolution(false)">解決していない</button>
        `;
        chatMessages.insertBefore(div, typingIndicator);
        scrollToBottom();
    }

    function handleResolution(resolved) {
        // Remove the prompt
        const prompt = chatMessages.querySelector('.resolution-prompt');
        if (prompt) prompt.remove();

        if (resolved) {
            appendMessage('bot', 'フィードバックをいただきありがとうございます。<br>他にご不明な点がございましたら、いつでもお気軽にお聞きください。');
        } else {
            appendMessage('bot', 'ご迷惑をおかけしております。<br>カスタマーサポートへの連絡は<a href="/user-guide/contact-form/">こちら</a>よりお願いいたします。');
        }
        resolutionShown = false;
    }

    function formatResponse(text) {
        // Remove the resolution check tag
        const hasResolution = text.includes('[RESOLUTION_CHECK]');
        text = text.replace(/\[RESOLUTION_CHECK\]/g, '').trim();

        // Convert Markdown links [text](url) to HTML links
        text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        // Convert remaining bare URLs to links
        text = text.replace(/(?<!href="|">)(https?:\/\/[^\s<\)]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
        // Bold **text**
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Inline code `text`
        text = text.replace(/`([^`]+)`/g, '<code style="background:rgba(0,0,0,.06);padding:2px 6px;border-radius:4px;font-size:13px;font-family:monospace">$1</code>');
        // Bullet points: lines starting with * or -
        text = text.replace(/^[\*\-]\s+(.+)/gm, '<li>$1</li>');
        text = text.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul style="margin:8px 0;padding-left:20px;list-style:disc">$1</ul>');
        // Numbered list: lines starting with 1. 2. etc
        text = text.replace(/^\d+\.\s+(.+)/gm, '<li>$1</li>');
        // Convert newlines to <br> (but not inside <ul>)
        text = text.replace(/\n/g, '<br>');
        // Clean up excessive <br> around block elements
        text = text.replace(/<br>\s*(<ul)/g, '$1');
        text = text.replace(/(<\/ul>)\s*<br>/g, '$1');
        text = text.replace(/<br>\s*<br>\s*<br>/g, '<br><br>');

        return { html: text, shouldShowResolution: hasResolution };
    }

    async function sendMessage() {
        const userText = chatInput.value.trim();
        if (!userText) return;

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;

        // Show user message
        appendMessage('user', userText.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'));

        // Add to history
        conversationHistory.push({ role: 'user', parts: [{ text: userText }] });
        messageCount++;

        // Show typing
        typingIndicator.classList.add('visible');
        scrollToBottom();

        try {
            const contents = [
                { role: 'user', parts: [{ text: SYSTEM_PROMPT }] },
                { role: 'model', parts: [{ text: '承知いたしました。BakuApo運営事務局のカスタマーサポートとして、お客様のご質問に丁寧にお答えいたします。' }] },
                ...conversationHistory
            ];

            const res = await fetch(GEMINI_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents,
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 500,
                        topP: 0.9
                    }
                })
            });

            if (!res.ok) throw new Error('API error');
            const data = await res.json();
            const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || 'すみません、うまく応答できませんでした。もう一度お試しください。';

            // Add to history
            conversationHistory.push({ role: 'model', parts: [{ text: rawText }] });

            const { html, shouldShowResolution } = formatResponse(rawText);

            typingIndicator.classList.remove('visible');
            appendMessage('bot', html);

            if (shouldShowResolution) {
                setTimeout(() => showResolutionPrompt(), 1200);
            }

        } catch (err) {
            console.error('Chat error:', err);
            typingIndicator.classList.remove('visible');
            appendMessage('bot', 'ネットワークエラーが発生しました。お手数ですが、もう一度お試しください。');
        }
    }
    </script>
</body>
</html>


================================================================
FILE: public/user-guide/quick-start/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BakuApo（バクアポ）クイックスタートガイド</title>
    <meta name="description" content="BakuApoご購入者様専用ページです。アプリケーションのインストールと初期設定方法をご案内しています。">
    <meta name="robots" content="noindex, nofollow">
    <!-- OGP -->
    <meta property="og:title" content="BakuApo（バクアポ）クイックスタートガイド">
    <meta property="og:description" content="BakuApoご購入者様専用ページです。アプリケーションのインストールと初期設定方法をご案内しています。">
    <meta property="og:image" content="/quiq-start-ogp.webp">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="BakuApo（バクアポ）クイックスタートガイド">
    <meta name="twitter:description" content="BakuApoご購入者様専用ページです。アプリケーションのインストールと初期設定方法をご案内しています。">
    <meta name="twitter:image" content="/quiq-start-ogp.webp">
    <link rel="icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        :root {
            --bg: #FAFAFA;
            --bg-card: #FFFFFF;
            --bg-alt: #F3F4F6;
            --border: #E5E7EB;
            --border-hover: #D1D5DB;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #7C8290;
            --accent: #0852FF;
            --accent-light: rgba(8,82,255,0.08);
            --accent-subtle: rgba(8,82,255,0.04);
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 15px;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* --- Header --- */
        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255,255,255,0.85);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-logo img { height: 58px; }
        .header-logo a { display: flex; align-items: center; text-decoration: none; }
        .header-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: -0.01em;
        }

        /* --- Breadcrumb --- */
        .breadcrumb {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-muted);
            flex-wrap: wrap;
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .sep {
            color: var(--border);
            user-select: none;
        }

        /* --- Article --- */
        .article {
            flex: 1;
            min-width: 0;
            max-width: 780px;
            padding: 40px 24px 100px 40px;
        }

        /* --- Hero --- */
        .hero {
            padding: 64px 0 48px;
            text-align: center;
        }
        .hero-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--accent-light);
            padding: 6px 16px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .hero h1 {
            font-size: clamp(26px, 4.5vw, 38px);
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1.25;
            margin-bottom: 16px;
        }
        .hero-sub {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 520px;
            margin: 0 auto;
        }

        /* --- TOC --- */
        .toc {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px 32px;
            margin-bottom: 56px;
        }
        .toc-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        .toc ol {
            list-style: none;
            counter-reset: toc-counter;
        }
        .toc ol li {
            counter-increment: toc-counter;
            margin-bottom: 8px;
        }
        .toc ol li a {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.15s;
        }
        .toc ol li a:hover {
            background: var(--accent-subtle);
            color: var(--accent);
        }
        .toc ol li a::before {
            content: counter(toc-counter);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: var(--accent-light);
            color: var(--accent);
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* --- Section --- */
        .guide-section {
            margin-bottom: 64px;
            scroll-margin-top: 80px;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--accent);
        }
        .section-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--accent);
            color: #fff;
            font-size: 16px;
            font-weight: 800;
            flex-shrink: 0;
        }
        .section-title {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .section-intro {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 28px;
            line-height: 1.8;
        }

        /* --- Step --- */
        .step {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s;
        }
        .step:hover {
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
        }
        .step-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--accent-light);
            padding: 4px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .step h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }
        .step p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.75;
            margin-bottom: 16px;
        }
        .step p:last-child { margin-bottom: 0; }

        .step-img {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .step-img-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        .step-img-row img {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        /* --- Download Button --- */
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 700;
            font-family: inherit;
            color: #fff;
            background: var(--accent);
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            transition: all 0.2s ease;
            margin: 8px 0;
            box-shadow: 0 4px 16px rgba(8,82,255,0.2);
        }
        .download-btn:hover {
            background: #063FCC;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(8,82,255,0.3);
        }
        .download-btn svg {
            width: 18px; height: 18px;
            stroke: currentColor; fill: none;
            stroke-width: 2;
        }

        /* --- Alert / Callout --- */
        .callout {
            display: flex;
            gap: 14px;
            padding: 20px 24px;
            border-radius: 12px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.7;
        }
        .callout-icon {
            flex-shrink: 0;
            font-size: 20px;
            width: 22px;
            text-align: center;
            margin-top: 2px;
            line-height: 1;
        }
        .callout-info {
            background: var(--accent-light);
            border: 1px solid rgba(8,82,255,0.15);
            color: var(--text-primary);
        }
        .callout-info .callout-icon { color: var(--accent); }
        .callout-warning {
            background: rgba(245,158,11,0.08);
            border: 1px solid rgba(245,158,11,0.2);
            color: var(--text-primary);
        }
        .callout-warning .callout-icon { color: var(--warning); }
        .callout-danger {
            background: rgba(239,68,68,0.06);
            border: 1px solid rgba(239,68,68,0.15);
            color: var(--text-primary);
        }
        .callout-danger .callout-icon { color: var(--danger); }
        .callout-success {
            background: rgba(16,185,129,0.06);
            border: 1px solid rgba(16,185,129,0.15);
            color: var(--text-primary);
        }
        .callout-success .callout-icon { color: var(--success); }

        .callout a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 3px;
        }
        .callout a:hover { text-decoration: none; }

        /* --- Code Block --- */
        .code-section {
            background: var(--bg-card);
            border: 2px solid var(--accent);
            border-radius: 14px;
            padding: 24px;
            margin: 16px 0;
        }
        .code-section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 12px;
        }
        .code-section-label svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            flex-shrink: 0;
        }
        .code-section-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 14px;
        }
        .code-block {
            background: #1E293B;
            color: #E2E8F0;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            padding: 18px 20px;
            border-radius: 10px;
            margin: 0 0 14px;
            overflow-x: auto;
            position: relative;
            letter-spacing: 0.02em;
            line-height: 1.6;
        }
        .code-copy-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .code-copy-btn:hover {
            background: #063FCC;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(8,82,255,0.25);
        }
        .code-copy-btn.copied {
            background: var(--success);
        }
        .code-copy-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* --- OS Tab --- */
        .os-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
        }
        .os-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            color: var(--text-secondary);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px 22px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .os-tab:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
        }
        .os-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }
        .os-tab svg { width: 18px; height: 18px; }
        .os-content { display: none; }
        .os-content.active { display: block; }

        /* --- Video Section --- */
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: #000;
            margin: 16px 0;
        }
        .video-container video {
            width: 100%;
            display: block;
        }

        /* --- Coming Soon --- */
        .coming-soon {
            text-align: center;
            padding: 48px 32px;
            background: var(--bg-card);
            border: 1px dashed var(--border);
            border-radius: 16px;
            margin-top: 24px;
        }
        .coming-soon-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            background: var(--accent-light);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .coming-soon-icon svg { width: 28px; height: 28px; color: var(--accent); stroke: currentColor; fill: none; stroke-width: 1.5; }
        .coming-soon h3 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .coming-soon p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.7;
        }

        /* --- Footer --- */
        .site-footer {
            text-align: center;
            padding: 32px 24px;
            border-top: 1px solid var(--border);
        }
        .site-footer p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Page Layout --- */
        .page-layout {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            flex-shrink: 0;
            border-right: 1px solid var(--border);
        }
        .sidebar-nav {
            position: sticky;
            top: 57px;
            padding: 32px 16px;
            max-height: calc(100vh - 57px);
            overflow-y: auto;
        }
        .sidebar-title {
            font-size: 13px;
            font-weight: 800;
            letter-spacing: -0.01em;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding: 0 12px;
        }
        .sidebar-nav ul {
            list-style: none;
        }
        .sidebar-nav li {
            margin-bottom: 2px;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.15s;
            border-left: 3px solid transparent;
            margin-left: -3px;
        }
        .sidebar-link:hover {
            color: var(--text-primary);
            background: var(--bg-alt);
        }
        .sidebar-link.active {
            color: var(--accent);
            background: var(--accent-light);
            border-left-color: var(--accent);
            font-weight: 600;
        }
        .sidebar-link .link-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
            background: var(--bg-alt);
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .sidebar-link.active .link-num {
            background: var(--accent);
            color: #fff;
        }

        /* --- Page Title --- */
        .page-title {
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid var(--border);
        }
        .page-title-img {
            width: 100%;
            border-radius: 16px;
            display: block;
        }

        /* --- Download Card --- */
        .dl-hero {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 20px;
            text-align: center;
        }
        .dl-hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: var(--success);
            background: rgba(16,185,129,0.08);
            padding: 5px 14px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .dl-hero-badge svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2.5; }
        .dl-hero h3 {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }
        .dl-hero .dl-version {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 28px;
        }
        .dl-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto;
        }
        .dl-option {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 28px 24px;
            text-decoration: none;
            color: inherit;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }
        .dl-option:hover {
            border-color: var(--accent);
            background: var(--accent-subtle);
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(8,82,255,0.1);
        }
        .dl-option-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dl-option-icon.windows { background: rgba(0,120,215,0.1); }
        .dl-option-icon.mac { background: rgba(0,0,0,0.06); }
        .dl-option-icon svg { width: 28px; height: 28px; }
        .dl-option-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        .dl-option-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .dl-option-file {
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--text-muted);
            background: var(--bg-alt);
            padding: 3px 10px;
            border-radius: 6px;
        }
        .dl-option-size {
            font-size: 12px;
            color: var(--text-muted);
        }
        .dl-option-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            background: var(--accent);
            padding: 10px 24px;
            border-radius: 10px;
            transition: background 0.2s;
            width: 100%;
            justify-content: center;
        }
        .dl-option:hover .dl-option-btn { background: #063FCC; }
        .dl-option-btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; }
        .dl-trust {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        .dl-trust-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .dl-trust-item svg { width: 14px; height: 14px; stroke: currentColor; fill: none; stroke-width: 2; flex-shrink: 0; }
        .dl-auto-detect {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .dl-auto-detect strong { color: var(--accent); font-weight: 600; }

        /* --- Responsive --- */
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .page-layout { display: block; }
            .article { padding: 32px 24px 80px; max-width: 100%; }
        }
        @media (max-width: 640px) {
            .dl-options { grid-template-columns: 1fr; }
            .dl-hero { padding: 28px 20px; }
            .article { padding: 24px 16px 80px; }
            .step { padding: 20px; }
            .os-tabs { flex-direction: column; }
            .section-header { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-inner">
            <div class="header-logo">
                <a href="/user-guide/">
                    <img src="/bakuapo-logo-useer.svg" alt="BakuApo">
                </a>
            </div>
            <span class="header-label">BakuApoご購入者様専用｜クイックスタートガイド</span>
        </div>
    </header>

    <nav class="breadcrumb">
        <a href="/user-guide/">ユーザーガイド</a>
        <span class="sep">›</span>
        <span>クイックスタートガイド</span>
    </nav>

    <div class="page-layout">
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <p class="sidebar-title">クイックスタートガイド</p>
            <ul>
                <li><a href="#intro" class="sidebar-link active" data-section="intro"><span class="link-num">1</span>はじめに</a></li>
                <li><a href="#download" class="sidebar-link" data-section="download"><span class="link-num">2</span>アプリをダウンロード</a></li>
                <li><a href="#setup-windows" class="sidebar-link" data-section="setup-windows"><span class="link-num">3</span>セットアップ（Win）</a></li>
                <li><a href="#setup-mac" class="sidebar-link" data-section="setup-mac"><span class="link-num">4</span>セットアップ（Mac）</a></li>
                <li><a href="#usage" class="sidebar-link" data-section="usage"><span class="link-num">5</span>アプリ操作方法</a></li>
                <li><a href="#contact" class="sidebar-link" data-section="contact"><span class="link-num">6</span>お問い合わせ</a></li>
            </ul>
        </nav>
    </aside>
    <main class="article">
        <div class="page-title">
            <img class="page-title-img" src="/quiq-start-ogp.webp" alt="クイックスタートガイド">
        </div>

        <!-- ========================================== -->
        <!-- 1. はじめに -->
        <!-- ========================================== -->
        <section class="guide-section" id="intro">
            <div class="section-header">
                <span class="section-number">1</span>
                <h2 class="section-title">はじめに</h2>
            </div>
            <p class="section-intro">
                BakuApoをお選びいただきまして、誠にありがとうございます。<br>
                本ガイドでは、BakuApoのダウンロードからインストール、起動までの手順を、
                お使いのOS（Windows / Mac）別にご案内いたします。<br>
                それぞれ数分程度で完了いたしますので、以下の手順に沿ってお進めくださいませ。
            </p>
            <div class="callout callout-info">
                <i class="fa-solid fa-circle-info callout-icon" style="color:var(--accent);"></i>
                <div>
                    ご不明な点がございましたら、<a href="/user-guide/contact-chat/">こちら</a>にて、解決をお手伝いいたします。
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- 2. アプリをダウンロード -->
        <!-- ========================================== -->
        <section class="guide-section" id="download">
            <div class="section-header">
                <span class="section-number">2</span>
                <h2 class="section-title">アプリをダウンロード</h2>
            </div>
            <p class="section-intro">
                お使いのOSに合わせて、以下よりインストーラーをダウンロードしてください。<br>
                ボタンをクリックすると、すぐにダウンロードが開始されます。
            </p>

            <div class="dl-hero">
                <span class="dl-hero-badge">
                    <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    最新バージョンをダウンロード
                </span>
                <h3>BakuApo（バクアポ）</h3>
                <p class="dl-version">Version 1.2.0</p>
                <p class="dl-auto-detect" id="osDetect"></p>

                <div class="dl-options">
                    <!-- Windows -->
                    <a href="https://pub-f05486cd473b432092da184cec71eb70.r2.dev/bakuapo/app-download/BakuApo_1.2.0.exe" download class="dl-option" id="dlWindows">
                        <div class="dl-option-icon windows">
                            <svg viewBox="0 0 24 24" fill="#0078D7"><path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg>
                        </div>
                        <span class="dl-option-title">Windows</span>
                        <div class="dl-option-meta">
                            <span class="dl-option-file">.exe インストーラー</span>
                            <span class="dl-option-size">290 MB</span>
                        </div>
                        <span class="dl-option-btn">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ダウンロード
                        </span>
                    </a>
                    <!-- Mac -->
                    <a href="https://pub-f05486cd473b432092da184cec71eb70.r2.dev/bakuapo/app-download/BakuApo_1.2.0.dmg" download class="dl-option" id="dlMac">
                        <div class="dl-option-icon mac">
                            <svg viewBox="0 0 24 24" fill="#000"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                        </div>
                        <span class="dl-option-title">macOS</span>
                        <div class="dl-option-meta">
                            <span class="dl-option-file">.dmg ディスクイメージ</span>
                            <span class="dl-option-size">199 MB（Apple Silicon）</span>
                        </div>
                        <span class="dl-option-btn">
                            <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ダウンロード
                        </span>
                    </a>
                </div>

                <div class="dl-trust">
                    <span class="dl-trust-item">
                        <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        安全なサーバーから配信
                    </span>
                    <span class="dl-trust-item">
                        <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        ウイルスチェック済み
                    </span>
                    <span class="dl-trust-item">
                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        ワンクリックで即時ダウンロード
                    </span>
                </div>
                <p style="font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 16px; line-height: 1.6; max-width: 480px; margin-left: auto; margin-right: auto;">
                    本アプリケーションは Cloudflare のグローバルネットワーク上で<br>ホスティングされており、安全に配信されています。
                </p>
            </div>

            <div class="callout callout-info">
                <i class="fa-solid fa-circle-info callout-icon" style="color:var(--accent);"></i>
                <div>
                    ダウンロード完了後は、お使いのOSに合わせて<a href="#setup-windows">Windows版</a>または<a href="#setup-mac">Mac版</a>のセットアップ手順にお進みください。
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- 3. セットアップ方法 (Windows) -->
        <!-- ========================================== -->
        <section class="guide-section" id="setup-windows">
            <div class="section-header">
                <span class="section-number">3</span>
                <h2 class="section-title">セットアップ方法（Windows）</h2>
            </div>
            <p class="section-intro">
                ダウンロードしたインストーラー（.exe）を実行し、画面の指示に沿ってセットアップを行います。
            </p>

            <!-- Step 1 -->
            <div class="step">
                <span class="step-label">Step 1</span>
                <h3>インストーラーを実行する</h3>
                <p>ダウンロードした「<strong>BakuApo_1.2.0.exe</strong>」をダブルクリックして実行してください。<br>
                ブラウザの下部やダウンロードフォルダからお開きいただけます。</p>
                <div class="callout callout-warning">
                    <i class="fa-solid fa-triangle-exclamation callout-icon" style="color:var(--warning);"></i>
                    <div>
                        Windows SmartScreenの警告が表示される場合がございます。<br>
                        「<strong>詳細情報</strong>」をクリックし、「<strong>実行</strong>」を選択してください。安全にインストールいただけます。
                    </div>
                </div>
            </div>

            <!-- Edge Download Warning -->
            <div class="step" style="border-color: var(--warning); border-width: 1px;">
                <span class="step-label" style="background: rgba(245,158,11,0.08); color: var(--warning);">エラーが出た場合</span>
                <h3>「一般的にダウンロードされていません」と表示される場合</h3>
                <p>Microsoft Edgeをお使いの場合、ダウンロード時に以下のようなメッセージが表示されることがございます。<br>
                これはEdgeのセキュリティ機能によるもので、ファイル自体に問題はございませんのでご安心ください。</p>
                <p>下の画像の赤枠で示している「<strong>…</strong>」の部分をクリックして、出てくる「<strong>保存</strong>」をクリックしてください。</p>
                <img class="step-img" src="/error-01.webp" alt="Edge ダウンロード警告" loading="lazy">
                <p>クリック後の操作手順は、以下のリンク先にすべて記載されておりますので、同じように作業をお進めください。</p>
                <div class="callout callout-info">
                    <i class="fa-solid fa-circle-info callout-icon" style="color:var(--accent);"></i>
                    <div>
                        詳しい手順はこちら → <a href="https://www.systemgear.com/spt/info/info_dl_edge.html" target="_blank" rel="noopener">Microsoft Edge でダウンロードできない場合の対処法</a>
                    </div>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="step">
                <span class="step-label">Step 2</span>
                <h3>セットアップ完了</h3>
                <p>インストーラーの指示に沿って操作すると、自動的にセットアップが完了します。<br>
                以下のような画面が表示されましたら、BakuApoが正常にインストールされています。</p>
                <img class="step-img" src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUdXN9wIPPo5CtjlyBILRDh60hS5j2YQRqWpx3WmjT-HywRSJyn1sGLLMTZKNpCwJmA0gl7qohm0Nj-59ye3miAkl-tcYGOMw7pRLQC1XuldlYPXGlI3r6Acgtm5QOka5GXwv9XB_VF2sxJN=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="BakuApo起動成功画面" loading="lazy">
                <div class="callout callout-success">
                    <i class="fa-solid fa-circle-check callout-icon" style="color:var(--success);"></i>
                    <div>セットアップ完了です！BakuApoをご活用くださいませ。</div>
                </div>
            </div>

            <!-- アップデート時の不具合案内 -->
            <div class="step" style="border-left:3px solid var(--danger);padding-left:24px;">
                <h3 style="display:flex;align-items:center;gap:8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Windows版アップデート時の不具合について
                </h3>
                <p>旧BakuApoがインストールされているWindows PCで最新版へアップグレードしようとすると、旧BakuApoをアンインストールできない例がございます。その場合は下記手順でアンインストール後に再度インストールを行なっていただきますようお願いいたします。</p>
                <a href="https://partner.bakuapo.com/user-guide/news/260223/" target="_blank" rel="noopener noreferrer" style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:10px 20px;background:var(--bg);border:1px solid var(--border);border-radius:10px;font-size:13px;font-weight:600;color:var(--danger);text-decoration:none;transition:all .2s ease;" onmouseover="this.style.borderColor='var(--danger)';this.style.boxShadow='0 4px 12px rgba(239,68,68,0.1)';" onmouseout="this.style.borderColor='var(--border)';this.style.boxShadow='none';">
                    詳細はこちら
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17L17 7"/><path d="M7 7h10v10"/></svg>
                </a>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- 4. セットアップ方法 (Mac) -->
        <!-- ========================================== -->
        <section class="guide-section" id="setup-mac">
            <div class="section-header">
                <span class="section-number">4</span>
                <h2 class="section-title">セットアップ方法（Mac）</h2>
            </div>
            <p class="section-intro">
                ダウンロードしたディスクイメージ（.dmg）を開き、アプリケーションフォルダにインストールします。
            </p>

            <!-- Step 1 -->
            <div class="step">
                <span class="step-label">Step 1</span>
                <h3>ディスクイメージを開く</h3>
                <p>ダウンロードした「<strong>BakuApo_1.2.0.dmg</strong>」をダブルクリックして開いてください。<br>
                以下のような画面が表示されます。</p>
                <div class="callout callout-info">
                    <i class="fa-solid fa-circle-info callout-icon" style="color:var(--accent);"></i>
                    <div>ファイルの展開に少しお時間がかかる場合がございます。焦らずお待ちくださいませ。</div>
                </div>
            </div>

            <!-- Step 2 -->
            <div class="step">
                <span class="step-label">Step 2</span>
                <h3>アプリケーションフォルダにインストール</h3>
                <p>表示された画面で、左側の「<strong>BakuApo Simple</strong>」を、右側の「<strong>アプリケーション</strong>」フォルダにドラッグしてください。</p>
                <img class="step-img" src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfsiW30Y1YFgmL51xJJn2Ve-gGItzPSaMagMNoBVUs5y8vk7YKKPa2ldFMpARRKTzADk82C4HAQINgGK0bSGnAesA_6fp6S2u1VhvsLwF-ZKjUWHSD0SR-81kqR8V9-S1v-fJp7avC0nnol=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="アプリケーションフォルダにドラッグ" loading="lazy">
                <p>これで「アプリケーション」の中に正しく「BakuApo Simple」がインストールされます。</p>
                <img class="step-img" src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfIQIc9WBYj7Q-0xo1DUn2dYcCci-dxzL_25_FHwSqdGzDuByuCRV7_lufezVLQo8xucXIvQHjn_OrZVEpyz652q54IIUoYmDRlDfpLTt7EOjjLsey35PyFSodPlkvendUGAI_Bsag92anB=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="インストール完了" loading="lazy">
            </div>

            <!-- Step 3 -->
            <div class="step">
                <span class="step-label">Step 3</span>
                <h3>インストール完了を確認</h3>
                <p>ディスクイメージの画面を閉じて、Finderの「<strong>アプリケーション</strong>」フォルダを確認してください。<br>
                「<strong>BakuApo Simple</strong>」が表示されていればインストール完了です。ダブルクリックでBakuApoが起動します。</p>
                <img class="step-img" src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUeqMfVdtwwVTYUjFUi3XThpQXHhzRY9wBstG7OGbZfY0OOxejc9d406_6HpptruYgqcYH-z8Lp0eOTbA3C6ErvNAv8IRRpyNettx-MZCm4kQ8uytXw6UKrcSsotbbl-20Tclo0oOxG-joXo=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="Finderでアプリケーション確認" loading="lazy">
                <div class="callout callout-warning">
                    <i class="fa-solid fa-triangle-exclamation callout-icon" style="color:var(--warning);"></i>
                    <div>起動時にエラーが表示される場合は、以下の「エラーが出た場合」の手順をご参照ください。</div>
                </div>
            </div>

            <!-- Troubleshooting -->
            <div class="step" style="border-color: var(--danger); border-width: 1px;">
                <span class="step-label" style="background: rgba(239,68,68,0.08); color: var(--danger);">エラーが出た場合</span>
                <h3>「壊れているため開けません」エラーが出た場合</h3>
                <p>Macのセキュリティ機能により、以下のようなエラーが表示される場合がございます。<br>
                マークの見た目が異なっていても、すべて同じ原因ですのでご安心ください。</p>
                <img class="step-img" src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUckvBSa00cZ8bNLxEfPo_H_QoWwtWMfZboyPDoxwIFy51Aaz5fp9TWe_wvyxF2Po9J3f1lGLglZe-URt68Y26lR_sQhpNorvkeL1FfcQNO7gXcIPQRgP0GFRqclClaNGQH-WurFO0sT0tc=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="壊れているため開けませんエラー" loading="lazy">
                <div class="callout callout-danger">
                    <i class="fa-solid fa-circle-xmark callout-icon" style="color:var(--danger);"></i>
                    <div>
                        <strong>「ゴミ箱に入れる」は押さないでください。</strong><br>
                        まずは「<strong>キャンセル</strong>」を押してください。「ゴミ箱に入れる」を押すとアプリが削除されてしまいます。
                    </div>
                </div>

                <h3 style="margin-top: 24px;">解決手順</h3>
                <p><strong>① ターミナルを開く</strong><br>
                画面右上の 🔍（Spotlight検索）をクリックし、「<strong>ターミナル</strong>」と入力してEnterを押します。</p>
                <div class="step-img-row">
                    <img src="/terminal.webp" alt="ターミナルを開く" loading="lazy">
                </div>

                <p style="margin-top: 16px;"><strong>② コマンドをコピー＆実行する</strong><br>
                ターミナルが開きましたら、下のボタンでコマンドをコピーし、ターミナルに貼り付けて <strong>Enter</strong> キーを押してください。</p>

                <div class="code-section">
                    <div class="code-section-label">
                        <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        コピーして貼り付けるコマンド
                    </div>
                    <p class="code-section-desc">下の黒いエリアに表示されている文字列が、貼り付けるコマンドです。<br>「コマンドをコピー」ボタンを押すとコピーされます。</p>
                    <div class="code-block">
                        <code id="terminalCmd">xattr -cr /Applications/BAKUAPO\ Simple.app</code>
                    </div>
                    <button class="code-copy-btn" onclick="copyCommand(this)">
                        <svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                        コマンドをコピー
                    </button>
                </div>
                <div class="step-img-row">
                    <img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfawIAb6IvuZEUByjzlGMBmiEpjs6WBRnQJgj2U7EknLxigvXWtaXZWah1Z6UcT2FcWRGGq-m6B-xug54DtkkRU95MJKYisLWE24YAAaRSNwKewP1nlI9IophrK3zQRdwqgSl_HsmBkl4oy=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="コマンド入力前" loading="lazy">
                    <img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUe1mHssl-ICKEzfIixJ0G6luf0KxwagStUQ4ZlUM-iqzN3xxG4ucOksnyszmLvFVusui-g-j7cCLo4489Qgn8vJ9_w1GRi0jzXdRDj3XHI3aMgZhyjotNB2UkwiqCyhc6XAWBIy9UtkJPQc=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="コマンド入力後" loading="lazy">
                </div>

                <p style="margin-top: 16px;"><strong>③ 再度BakuApoを起動する</strong><br>
                これで解決です！もう一度「BakuApo Simple」をダブルクリックし、以下の画面が表示されれば成功です。</p>
                <div class="step-img-row">
                    <img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUfV84Ob1ZX24OUPUbokinFiw1ZTq9B__8eJRWb7iSthWZMK04uLwg5uurO6FPM2JV6H5-fMuWCQzkiqC_1px-qgTqF53ZNKea_XYfaiqy2ANq8FC3VKDnC-f4R_5D5CdIIFvPA5aYe44bEM=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="BakuApo起動成功（Mac）" loading="lazy">
                    <img src="https://lh7-rt.googleusercontent.com/slidesz/AGV_vUcg6JBjcHz7MYjjUHCZBY47Q2EDgvieNDivnVS38MvwvKgHOJ1qJwzJCvWlAFrk3S4AC4ET6VaCel-OnoVLURulzCBAWD8UKn_OifluebiuUQ3vGLIw8g_eARL5asNH59pgqRNdMrCf_1Y=s2048?key=ZaCEKR0s8BNmrUGtKyTnUA" alt="BakuApoメイン画面" loading="lazy">
                </div>
                <div class="callout callout-success">
                    <i class="fa-solid fa-circle-check callout-icon" style="color:var(--success);"></i>
                    <div>セットアップ完了です！BakuApoをご活用くださいませ。</div>
                </div>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- 4. アプリ操作方法 -->
        <!-- ========================================== -->
        <section class="guide-section" id="usage">
            <div class="section-header">
                <span class="section-number">5</span>
                <h2 class="section-title">アプリ操作方法</h2>
            </div>
            <p class="section-intro">
                BakuApoの基本的な操作方法をご紹介いたします。<br>
                まずは以下のサービス紹介動画をご覧くださいませ。
            </p>

            <div class="step">
                <span class="step-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    サービス紹介動画
                </span>
                <h3>BakuApo（バクアポ）の使い方</h3>
                <p>動画は音声オフで自動再生されます。音声をお聞きになりたい場合は、プレーヤーのミュートボタンを解除してください。</p>
                <div class="video-container">
                    <video
                        autoplay
                        muted
                        loop
                        playsinline
                        controls
                        preload="metadata"
                        src="/BakuApo%EF%BC%88%E3%83%90%E3%82%AF%E3%82%A2%E3%83%9D%EF%BC%89%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E7%B4%B9%E4%BB%8B%E5%8B%95%E7%94%BB_250216.mp4"
                    >
                        お使いのブラウザは動画の再生に対応しておりません。
                    </video>
                </div>
            </div>

            <div class="coming-soon">
                <div class="coming-soon-icon">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <h3>詳細な操作マニュアルを準備中です</h3>
                <p>現在、より詳しい操作マニュアルの作成を進めております。<br>完成次第、こちらのページに掲載いたしますので、<br>もうしばらくお待ちくださいませ。</p>
            </div>
        </section>

        <!-- ========================================== -->
        <!-- 6. お問い合わせ -->
        <!-- ========================================== -->
        <section class="guide-section" id="contact">
            <div class="section-header">
                <span class="section-number">6</span>
                <h2 class="section-title">お問い合わせ</h2>
            </div>
            <p class="section-intro">
                上記の内容で実行しても、どうしてもインストールが完了しない場合は、<br>
                お手数ですが下記よりお問い合わせください。
            </p>

            <div style="text-align:center;margin-top:28px;">
                <a href="/user-guide/contact-chat/" style="display:inline-flex;align-items:center;gap:10px;font-size:16px;font-weight:700;color:#fff;background:var(--accent);padding:16px 40px;border-radius:14px;text-decoration:none;transition:all .2s;box-shadow:0 4px 20px rgba(8,82,255,.18);">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                    お問い合わせに進む
                </a>
            </div>
        </section>
    </main>
    </div><!-- /.page-layout -->

    <footer class="site-footer">
        <p>&copy; 2026 BakuApo &amp; CHAINSODA Co., Ltd. — All rights reserved.</p>
    </footer>

    <script>
        // --- Copy command button ---
        function copyCommand(btn) {
            const code = document.getElementById('terminalCmd').textContent;
            navigator.clipboard.writeText(code).then(() => {
                btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> コピーしました！';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg> コマンドをコピー';
                    btn.classList.remove('copied');
                }, 2500);
            });
        }

        // --- OS auto-detect ---
        (function() {
            const ua = navigator.userAgent || navigator.platform || '';
            const detect = document.getElementById('osDetect');
            const dlWin = document.getElementById('dlWindows');
            const dlMac = document.getElementById('dlMac');
            if (/Mac|iPhone|iPad/.test(ua)) {
                if (detect) detect.innerHTML = 'お使いの環境: <strong>macOS</strong> が検出されました';
                if (dlMac) dlMac.style.borderColor = 'var(--accent)';
            } else if (/Win/.test(ua)) {
                if (detect) detect.innerHTML = 'お使いの環境: <strong>Windows</strong> が検出されました';
                if (dlWin) dlWin.style.borderColor = 'var(--accent)';
            }
        })();

        // --- Smooth scroll with header offset ---
        var _scrollingTo = null;
        var _scrollTimer = null;
        var HEADER_OFFSET = 90;

        document.querySelectorAll('a[href^="#"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
                var href = link.getAttribute('href');
                var target = document.querySelector(href);
                if (!target) return;
                e.preventDefault();

                var sectionId = href.substring(1);
                _scrollingTo = sectionId;

                // Calculate exact scroll position accounting for sticky header
                var top = target.getBoundingClientRect().top + window.pageYOffset - HEADER_OFFSET;
                window.scrollTo({ top: top, behavior: 'smooth' });

                // Immediately update sidebar active state
                document.querySelectorAll('.sidebar-link[data-section]').forEach(function(sLink) {
                    sLink.classList.toggle('active', sLink.dataset.section === sectionId);
                });

                // Re-enable scroll spy after animation completes
                clearTimeout(_scrollTimer);
                _scrollTimer = setTimeout(function() { _scrollingTo = null; }, 1000);
            });
        });

        // --- Scroll spy for sidebar ---
        (function() {
            var sections = document.querySelectorAll('.guide-section[id]');
            var links = document.querySelectorAll('.sidebar-link[data-section]');
            if (!links.length) return;

            function updateActive() {
                // Skip during programmatic scroll to prevent flickering
                if (_scrollingTo) return;

                var current = '';
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                var windowHeight = window.innerHeight;
                var docHeight = document.documentElement.scrollHeight;

                // If near bottom of page, activate the last section
                if (scrollTop + windowHeight >= docHeight - 60) {
                    current = sections[sections.length - 1].id;
                } else {
                    // Find the last section whose top has scrolled past the threshold
                    for (var i = 0; i < sections.length; i++) {
                        if (sections[i].getBoundingClientRect().top <= HEADER_OFFSET + 30) {
                            current = sections[i].id;
                        }
                    }
                }
                if (!current && sections.length) current = sections[0].id;

                links.forEach(function(link) {
                    link.classList.toggle('active', link.dataset.section === current);
                });
            }
            window.addEventListener('scroll', updateActive, { passive: true });
            updateActive();
        })();
    </script>
</body>
</html>


================================================================
FILE: public/manual/faq/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&A｜パートナー様向けマニュアル｜営業革命｜BakuApo</title>
    <meta name="description" content="パートナー（正規代理店）様向けのQ&Aです。よくある質問と回答をまとめています。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="Q&A｜パートナー様向けマニュアル｜営業革命｜BakuApo">
    <meta property="og:description" content="パートナー（正規代理店）様向けのQ&Aです。よくある質問と回答をまとめています。">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/ogp-manual.png">
    <meta property="og:site_name" content="営業革命｜BakuApo">
    <link rel="icon" href="/bakuapo-logo.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #F7F7F5; --card-bg: #FFFFFF; --text-main: #1A1A1A; --text-sub: #787774;
            --border-color: #E9E9E7; --border-subtle: #F3F4F6; --accent-color: #2383E2;
            --star-color-on: #F2C94C; --check-color-on: #27AE60; --link-color: #2563EB;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
            --sidebar-width: 220px; --max-width: 1200px;
            --chat-primary: #2383E2; --chat-bg: #fff; --chat-bubble-bot: #F7F7F5;
            --chat-bubble-user: #2383E2; --chat-text-bot: #1A1A1A; --chat-text-user: #FFFFFF;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; -webkit-font-smoothing: antialiased; }
        .container { max-width: var(--max-width); margin: 0 auto; padding: 0 24px; }
        header { position: sticky; top: 0; z-index: 100; padding: 16px 0 12px; background: rgba(250, 250, 250, 0.88); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--border-color); }
        .header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .logo-group { display: flex; align-items: center; gap: 10px; }
        .logo-group img { height: 26px; }
        .logo-divider { width: 1px; height: 20px; background-color: var(--border-color); }
        .header-title { font-size: 12px; font-weight: 600; color: var(--text-sub); letter-spacing: 0.02em; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; overflow-x: auto; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-sub); border-bottom: 3px solid transparent; transition: all 0.2s; font-family: inherit; background: none; border-top: none; border-left: none; border-right: none; text-decoration: none; display: inline-block; text-align: center; white-space: nowrap; }
        .tab-btn:hover { background-color: rgba(0,0,0,0.03); color: var(--text-main); }
        .tab-btn.active { color: var(--text-main); border-bottom-color: var(--text-main); }
        .controls-wrapper { display: flex; flex-direction: column; gap: 8px; }
        .search-container { position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none; }
        .search-input { width: 100%; padding: 10px 14px 10px 38px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px; outline: none; transition: all 0.2s; font-family: inherit; background-color: var(--card-bg); }
        .search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .status-bar { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-sub); padding-left: 2px; }
        .loading-indicator { display: none; align-items: center; gap: 6px; font-size: 12px; color: var(--text-sub); }
        .loading-indicator.active { display: inline-flex; }
        .spinner { width: 14px; height: 14px; border: 2px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-ref-links { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
        .chat-ref-btn { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--border-subtle); border-radius: var(--radius-sm); text-decoration: none; color: var(--text-main); font-size: 12px; cursor: pointer; transition: background 0.15s; border: 1px solid var(--border-color); }
        .chat-ref-btn:hover { background: #E5E7EB; }
        .ref-icon { width: 14px; height: 14px; flex-shrink: 0; }
        .ref-badge { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }
        .badge-video { background: #DBEAFE; color: #1D4ED8; }
        .badge-drive { background: #D1FAE5; color: #065F46; }
        .badge-qa { background: #FEF3C7; color: #92400E; }
        .badge-rebuttal { background: #FCE7F3; color: #9D174D; }
        .initial-loading { display: flex; flex-direction: column; align-items: center; padding: 48px 0; gap: 16px; }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.7s linear infinite; }
        .loading-text { font-size: 13px; color: var(--text-sub); }
        .skeleton-list { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
        .skeleton-card { background: var(--card-bg); border-radius: var(--radius-md); padding: 20px; border: 1px solid var(--border-color); }
        .skeleton-line { height: 12px; border-radius: 6px; background: linear-gradient(90deg, var(--border-subtle) 25%, #e5e7eb 50%, var(--border-subtle) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .skeleton-line.title { width: 40%; height: 14px; margin-bottom: 12px; }
        .skeleton-line.long { width: 90%; margin-bottom: 8px; }
        .skeleton-line.medium { width: 70%; margin-bottom: 8px; }
        .skeleton-line.short { width: 50%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .main-layout { display: flex; gap: 24px; padding-top: 20px; padding-bottom: 80px; }
        .sidebar { position: sticky; width: var(--sidebar-width); flex-shrink: 0; max-height: calc(100vh - 200px); overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .filter-section { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .filter-btn { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: var(--text-main); transition: all 0.2s; user-select: none; width: 100%; }
        .filter-btn:hover { background: #F0F0EF; }
        .filter-icon { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }
        i.filter-icon { width: auto; height: auto; font-size: 14px; color: currentColor; fill: none; }
        .filter-btn.active-star { background: #FFF9E6; border-color: var(--star-color-on); color: #946F00; }
        .filter-btn.active-star .filter-icon { fill: var(--star-color-on); }
        .filter-btn.active-unwatched { background: #E8F5E9; border-color: var(--check-color-on); color: #1E8449; }
        .sidebar-title { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; padding-left: 4px; }
        .category-nav-list { list-style: none; display: flex; flex-direction: column; gap: 1px; }
        .category-nav-item { font-size: 13px; padding: 7px 10px; border-radius: var(--radius-sm); cursor: pointer; color: var(--text-sub); transition: all 0.15s; font-weight: 500; }
        .category-nav-item:hover { background-color: var(--border-subtle); color: var(--text-main); }
        .content-area { flex: 1; min-width: 0; }
        .drive-category-group { margin-bottom: 24px; }
        .drive-category-title { font-size: 22px; font-weight: 700; margin-bottom: 24px; padding-bottom: 8px; border-bottom: 2px solid var(--border-color); color: var(--text-main); }
        .action-buttons { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--text-sub); }
        .icon-btn:hover { background-color: var(--border-subtle); }
        .icon-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
        .star-btn.active { color: var(--star-color-on); }
        .star-btn.active svg { fill: var(--star-color-on); stroke: var(--star-color-on); }
        .check-btn.active { color: var(--check-color-on); }
        .check-btn.active svg { fill: var(--check-color-on); stroke: var(--check-color-on); }
        .qa-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: 0; margin-bottom: 12px; overflow: hidden; transition: box-shadow 0.2s; }
        .qa-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .qa-question { display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px; font-weight: 600; font-size: 14px; line-height: 1.6; background-color: var(--border-subtle); border-bottom: 1px solid var(--border-color); position: relative; }
        .qa-question .action-buttons { position: absolute; top: 14px; right: 14px; }
        .qa-answer { display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px; font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-main); }
        .qa-badge { flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; font-size: 13px; font-weight: 700; margin-top: 1px; }
        .qa-badge-q { background-color: var(--accent-color); color: #fff; }
        .qa-badge-a { background-color: var(--check-color-on); color: #fff; }
        .message-state { text-align: center; padding: 48px; color: var(--text-sub); font-size: 14px; }
        .error-container { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .error-message { color: #DC2626; background: #FEF2F2; padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; border: 1px solid #FECACA; }
        .chat-widget { position: fixed; bottom: 24px; right: 24px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; font-family: inherit; }
        .chat-toggle-btn { height: 56px; padding: 0 24px 0 20px; border-radius: 30px; background-color: var(--chat-primary); color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.2s; font-weight: 700; font-size: 15px; font-family: inherit; }
        .chat-toggle-btn:hover { transform: scale(1.05); }
        .chat-toggle-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .chat-btn-text { display: block; }
        .chat-window { position: absolute; bottom: 72px; right: 0; width: 350px; height: 500px; background-color: var(--chat-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; transform-origin: bottom right; }
        .chat-window.active { display: flex; }
        .chat-header { padding: 14px 16px; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .chat-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .chat-close { background: none; border: none; cursor: pointer; color: var(--text-sub); width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: background 0.15s; font-size: 16px; }
        .chat-close:hover { background: var(--border-subtle); }
        .chat-messages { flex: 1; padding: 16px; overflow-y: auto; background-color: var(--card-bg); display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 85%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.6; word-wrap: break-word; }
        .chat-msg.bot { align-self: flex-start; background-color: var(--chat-bubble-bot); color: var(--chat-text-bot); border-bottom-left-radius: 2px; }
        .chat-msg.user { align-self: flex-end; background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 2px; }
        .chat-msg.system { align-self: center; background-color: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; font-size: 12px; text-align: left; max-width: 90%; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .chat-msg a { color: var(--link-color); text-decoration: underline; text-underline-offset: 2px; word-break: break-all; }
        .chat-msg a:hover { text-decoration: none; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; background-color: var(--card-bg); }
        .chat-input { flex: 1; padding: 9px 14px; border: 1px solid var(--border-color); border-radius: 20px; font-size: 13px; outline: none; transition: all 0.2s; font-family: inherit; }
        .chat-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .chat-input:disabled { background-color: var(--border-subtle); cursor: not-allowed; }
        .chat-send-btn { background: none; border: none; cursor: pointer; color: var(--accent-color); padding: 4px; }
        .chat-send-btn:disabled { color: var(--text-sub); cursor: not-allowed; }
        .typing-dots { display: flex; gap: 4px; padding: 4px 8px; }
        .typing-dot { width: 5px; height: 5px; background-color: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @media (max-width: 768px) {
            .container { padding: 0 16px; } header { padding: 12px 0; } .header-top { margin-bottom: 12px; } .logo-group img { height: 22px; } .header-title { font-size: 11px; } .tabs { margin-bottom: 12px; } .tab-btn { font-size: 12px; padding: 10px 6px; } .status-bar { display: none; } .main-layout { flex-direction: column; gap: 12px; padding-top: 4px; }
            .sidebar { position: sticky; z-index: 90; width: calc(100% + 32px); margin-left: -16px; padding: 8px 16px; border-bottom: 1px solid var(--border-color); max-height: none; overflow-x: auto; display: flex; align-items: center; gap: 6px; background: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
            .sidebar::-webkit-scrollbar { display: none; }
            .filter-section { flex-direction: row; margin: 0; padding: 0; border: none; padding-right: 6px; margin-right: 4px; border-right: 1px solid var(--border-color); }
            .filter-btn { padding: 5px 8px; width: auto; font-size: 11px; white-space: nowrap; } .sidebar-title { display: none; } .category-nav-list { display: flex; gap: 6px; }
            .category-nav-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 12px; font-size: 11px; }
            .drive-category-group { scroll-margin-top: 240px; }
            .chat-toggle-btn { width: 56px; height: 56px; border-radius: 50%; padding: 0; } .chat-btn-text { display: none; } .chat-window { width: calc(100vw - 32px); right: -8px; bottom: 80px; height: 60vh; }
        }
    </style>
</head>
<body>
<div class="container">
    <header id="mainHeader">
        <div class="header-top">
            <div class="logo-group">
                <img src="/eigyou-kakumei_logo.svg" alt="営業革命" onerror="this.style.display='none'">
                <div class="logo-divider"></div>
                <img src="/bakuapo-logo.svg" alt="BakuApo" onerror="this.style.display='none'">
            </div>
            <span class="header-title">パートナー様向けマニュアル</span>
        </div>
        <div class="tabs">
            <a class="tab-btn" href="/manual/videos/">動画カリキュラム</a>
            <a class="tab-btn" href="/manual/resources/">資料ドライブ</a>
            <a class="tab-btn active" href="/manual/faq/">Q&A</a>
        </div>
        <div class="controls-wrapper">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
            </div>
            <div id="errorContainer" class="error-container"></div>
            <div class="status-bar"><span id="countDisplay">0件</span><div class="loading-indicator" id="loadingIndicator"><div class="spinner"></div><span>更新中...</span></div></div>
        </div>
    </header>
    <div class="main-layout">
        <aside class="sidebar" id="stickySidebar">
            <div class="filter-section">
                <div class="filter-btn" id="starFilterBtn" onclick="toggleStarFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>スター付きのみ</span>
                </div>
                <div class="filter-btn" id="unwatchedFilterBtn" onclick="toggleUnwatchedFilter()">
                    <i class="fa-regular fa-eye filter-icon"></i>
                    <span>未確認のみ表示</span>
                </div>
            </div>
            <div class="sidebar-title">カテゴリー目次</div>
            <ul class="category-nav-list" id="categoryNav"></ul>
        </aside>
        <main class="content-area" id="contentArea">
            <div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>
        </main>
    </div>
    <div class="chat-widget">
        <button class="chat-toggle-btn" onclick="toggleChat()" title="AIアシスタントに質問">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6v-4h12v4zm0-6H6V7h12v6z"/><circle cx="8.5" cy="10.5" r="1.5"/><circle cx="15.5" cy="10.5" r="1.5"/></svg>
            <span class="chat-btn-text">AIに質問する</span>
        </button>
        <div class="chat-window" id="chatWindow">
            <div class="chat-header"><span class="chat-title">AIパートナーアシスタント</span><button class="chat-close" onclick="toggleChat()">✕</button></div>
            <div class="chat-messages" id="chatMessages"><div class="chat-msg bot">こんにちは！<br>動画カリキュラム、資料、Q&A、切り返しトークについて、ご質問があればお答えします。</div></div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn"><svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>
</div>
<script>
    const CURRENT_TAB = 'qa';
    const TAB_URLS = { video: '/manual/videos/', drive: '/manual/resources/', qa: '/manual/faq/' };
    const CONFIG = {
        geminiProxyUrl: "/api/gemini-proxy",
        videoSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=396280088&single=true&output=csv",
        driveSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=380310918&single=true&output=csv",
        qaSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1192474135&single=true&output=csv",
        rebuttalSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1328585848&single=true&output=csv",
        refreshInterval: 60000
    };
    const THRESHOLDS = { CONFIDENCE: 0.6, SUGGESTION: 0.25 };
    const state = { currentTab: CURRENT_TAB, searchText: '', showStarredOnly: false, showUnwatchedOnly: false, starredItems: new Set(), watchedItems: new Set(), data: { video: [], drive: [], qa: [], rebuttal: [] }, isLoaded: { video: false, drive: false, qa: false, rebuttal: false }, hasError: false, chatHistory: [], messageTimestamps: [], lockedUntil: 0 };
    const els = { input: document.getElementById('searchInput'), count: document.getElementById('countDisplay'), loading: document.getElementById('loadingIndicator'), errorContainer: document.getElementById('errorContainer'), categoryNav: document.getElementById('categoryNav'), header: document.getElementById('mainHeader'), sidebar: document.getElementById('stickySidebar'), starFilterBtn: document.getElementById('starFilterBtn'), unwatchedFilterBtn: document.getElementById('unwatchedFilterBtn'), contentArea: document.getElementById('contentArea'), chatWindow: document.getElementById('chatWindow'), chatMessages: document.getElementById('chatMessages'), chatInput: document.getElementById('chatInput'), chatSendBtn: document.getElementById('chatSendBtn') };

    function updateLayoutMetrics() {
        const headerHeight = els.header.offsetHeight; const isMobile = window.innerWidth <= 768;
        const topOffset = isMobile ? headerHeight : headerHeight + 20; els.sidebar.style.top = `${topOffset}px`;
        const totalStickyHeight = isMobile ? topOffset + els.sidebar.offsetHeight + 20 : topOffset;
        document.querySelectorAll('.drive-category-group').forEach(el => { el.style.scrollMarginTop = `${totalStickyHeight}px`; });
    }
    function loadUserPreferences() { try { const s = localStorage.getItem('partner_manual_stars_v2'); if (s) state.starredItems = new Set(JSON.parse(s)); const w = localStorage.getItem('partner_manual_watched_v2'); if (w) state.watchedItems = new Set(JSON.parse(w)); } catch(e){} }
    function saveUserPreferences() { localStorage.setItem('partner_manual_stars_v2', JSON.stringify([...state.starredItems])); localStorage.setItem('partner_manual_watched_v2', JSON.stringify([...state.watchedItems])); }
    function toggleStar(key) { if (state.starredItems.has(key)) state.starredItems.delete(key); else state.starredItems.add(key); saveUserPreferences(); renderView(); }
    function toggleWatched(key) { if (state.watchedItems.has(key)) state.watchedItems.delete(key); else state.watchedItems.add(key); saveUserPreferences(); renderView(); }
    function toggleStarFilter() { state.showStarredOnly = !state.showStarredOnly; els.starFilterBtn.classList.toggle('active-star', state.showStarredOnly); renderView(); }
    function toggleUnwatchedFilter() { state.showUnwatchedOnly = !state.showUnwatchedOnly; els.unwatchedFilterBtn.classList.toggle('active-unwatched', state.showUnwatchedOnly); renderView(); }

    function parseCSV(text) {
        const arr = []; let quote = false; let row = []; let col = ''; let c = 0;
        for (; c < text.length; c++) { let cc = text[c], nc = text[c+1]; if (quote) { if (cc === '"') { if (nc === '"') { col += '"'; c++; } else { quote = false; } } else { col += cc; } } else { if (cc === '"') { quote = true; } else if (cc === ',') { row.push(col); col = ''; } else if (cc === '\r' && nc === '\n') { row.push(col); col = ''; arr.push(row); row = []; c++; } else if (cc === '\n' || cc === '\r') { row.push(col); col = ''; arr.push(row); row = []; } else { col += cc; } } }
        if (col.length > 0 || row.length > 0) { row.push(col); arr.push(row); } return arr;
    }

    function createActionButtons(id, tab) {
        const div = document.createElement('div'); div.className = 'action-buttons';
        const isStarred = state.starredItems.has(id); const isWatched = state.watchedItems.has(id);
        div.innerHTML = `<button class="icon-btn star-btn ${isStarred?'active':''}" onclick="toggleStar('${id}')" title="${isStarred?'スター付きを外す':'スター付きにする'}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></button><button class="icon-btn check-btn ${isWatched?'active':''}" onclick="toggleWatched('${id}')" title="${isWatched?'確認済みを外す':'確認済みにする'}"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></button>`;
        return div;
    }

    function renderNav(categories, idMap) {
        const frag = document.createDocumentFragment();
        categories.forEach(cat => { const li = document.createElement('li'); li.className = 'category-nav-item'; li.textContent = cat; li.onclick = () => { const el = document.getElementById(idMap[cat]); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }; frag.appendChild(li); });
        els.categoryNav.appendChild(frag);
    }

    function renderQAList(items, container) {
        const categories = new Set(); const catMap = {}; const grouped = {};
        items.forEach(item => { const cat = item.category || '未分類'; if (!grouped[cat]) grouped[cat] = []; grouped[cat].push(item); });
        let idx = 0;
        Object.keys(grouped).forEach(cat => {
            categories.add(cat); const catId = `qa-cat-${idx++}`; catMap[cat] = catId;
            const section = document.createElement('div'); section.className = 'drive-category-group'; section.id = catId;
            section.innerHTML = `<h2 class="drive-category-title">${cat}</h2>`;
            grouped[cat].forEach(item => {
                const card = document.createElement('div'); card.className = 'qa-card';
                const actions = createActionButtons(item.id, 'qa');
                card.innerHTML = `<div class="qa-question"><span class="qa-badge qa-badge-q">Q</span><span>${item.question}</span></div><div class="qa-answer"><span class="qa-badge qa-badge-a">A</span><span>${item.answer}</span></div>`;
                card.querySelector('.qa-question').appendChild(actions);
                section.appendChild(card);
            });
            container.appendChild(section);
        });
        renderNav(categories, catMap);
    }

    function renderView() {
        const container = els.contentArea; container.innerHTML = ''; els.categoryNav.innerHTML = '';
        const sourceData = state.data[CURRENT_TAB]; const query = state.searchText.toLowerCase().trim();
        if (!state.isLoaded[CURRENT_TAB]) { container.innerHTML = `<div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>`; return; }
        const filtered = sourceData.filter(item => { if (state.showStarredOnly && !state.starredItems.has(item.id)) return false; if (state.showUnwatchedOnly && state.watchedItems.has(item.id)) return false; if (!query) return true; return JSON.stringify(item).toLowerCase().includes(query); });
        els.count.textContent = `${filtered.length}件`;
        if (filtered.length === 0) { container.innerHTML = `<div class="message-state">該当なし</div>`; return; }
        renderQAList(filtered, container);
        requestAnimationFrame(updateLayoutMetrics);
    }

    function loadCachedData() {
        try {
            const cached = sessionStorage.getItem('manual_cache_v1');
            if (cached) { const obj = JSON.parse(cached); state.data = obj.data; state.isLoaded = obj.isLoaded; renderView(); return true; }
        } catch (e) {}
        return false;
    }
    function saveCacheData() {
        try { sessionStorage.setItem('manual_cache_v1', JSON.stringify({ data: state.data, isLoaded: state.isLoaded })); } catch (e) {}
    }

    async function fetchAllData() {
        const isFirstLoad = !state.isLoaded[CURRENT_TAB];
        if (isFirstLoad) { els.loading.classList.add('active'); }
        els.errorContainer.style.display = 'none';
        try {
            const vRes = await fetch(`${CONFIG.videoSheetUrl}&t=${Date.now()}`); if (vRes.ok) { const t = await vRes.text(); const rows = parseCSV(t).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.video = rows.map(r => ({ sourceType: 'manual', id: r[2] || r[3], category: r[1] || '未分類', youtubeUrl: r[2], title: r[3], desc: r[4], materialUrl: r[5] })); state.isLoaded.video = true; }
            const dRes = await fetch(`${CONFIG.driveSheetUrl}&t=${Date.now()}`); if (dRes.ok) { const t = await dRes.text(); const rows = parseCSV(t).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.drive = rows.map(r => ({ sourceType: 'material', id: r[5] || '#', large: r[1] || 'その他', medium: r[2] || '', small: r[3] || '', detail: r[4] || '', url: r[5] || '#', desc: r[6] || '' })); state.isLoaded.drive = true; }
            const qRes = await fetch(`${CONFIG.qaSheetUrl}&t=${Date.now()}`); if (qRes.ok) { const t = await qRes.text(); const rows = parseCSV(t).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.qa = rows.map((r, i) => ({ sourceType: 'qa', id: `qa-${r[2] || i}`, category: r[1] || '未分類', question: r[2] || '', answer: r[3] || '' })); state.isLoaded.qa = true; }
            const rRes = await fetch(`${CONFIG.rebuttalSheetUrl}&t=${Date.now()}`); if (rRes.ok) { const t = await rRes.text(); const rows = parseCSV(t).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.rebuttal = rows.map((r, i) => ({ sourceType: 'qa', id: `rebuttal-${r[2] || i}`, category: r[1] || '未分類', question: r[2] || '', answer: r[3] || '' })); state.isLoaded.rebuttal = true; }
        } catch (e) { console.error(e); state.hasError = true; els.errorContainer.style.display = 'flex'; els.errorContainer.innerHTML = `<div class="error-message">データの更新に失敗しました。</div>`; }
        saveCacheData();
        renderView(); els.loading.classList.remove('active');
    }

    function toggleChat() { els.chatWindow.classList.toggle('active'); if (els.chatWindow.classList.contains('active')) { els.chatInput.focus(); scrollToBottom(); } }
    function handleChatKey(e) { if (e.key === 'Enter') sendChatMessage(); }
    function scrollToBottom() { els.chatMessages.scrollTop = els.chatMessages.scrollHeight; }
    function navigateToItem(tab, index) {
        els.chatWindow.classList.remove('active');
        if (tab === CURRENT_TAB) {
            requestAnimationFrame(() => { requestAnimationFrame(() => {
                const items = document.querySelectorAll('#contentArea .qa-card');
                let targetEl = items[index] || null;
                if (targetEl) { targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); targetEl.style.transition = 'box-shadow 0.3s, outline 0.3s'; targetEl.style.outline = '2px solid var(--accent-color)'; targetEl.style.boxShadow = '0 0 0 4px rgba(35,131,226,0.15)'; setTimeout(() => { targetEl.style.outline = 'none'; targetEl.style.boxShadow = ''; }, 2500); }
            }); });
        } else { window.location.href = TAB_URLS[tab]; }
    }
    function formatChatMessage(text) { if (!text) return ""; let f = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); f = f.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'); f = f.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">リンク</a>'); f = f.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>'); f = f.replace(/\n/g, '<br>'); return f; }
    function addMessage(text, type, appendHtml = "") { const div = document.createElement('div'); div.className = `chat-msg ${type}`; div.innerHTML = formatChatMessage(text) + appendHtml; els.chatMessages.appendChild(div); scrollToBottom(); }
    function addTypingIndicator() { const div = document.createElement('div'); div.className = 'chat-msg bot typing-indicator'; div.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`; els.chatMessages.appendChild(div); scrollToBottom(); return div; }
    function setInputLock(locked) { els.chatInput.disabled = locked; els.chatSendBtn.disabled = locked; els.chatInput.placeholder = locked ? "送信制限中です (3分間)" : "質問を入力..."; }
    function calculateSimilarity(str1, str2) { if (!str1 || !str2) return 0.0; const s1 = str1.toLowerCase().replace(/\s+/g, ""); const s2 = str2.toLowerCase().replace(/\s+/g, ""); if (s1 === s2) return 1.0; if (s1.length < 2 || s2.length < 2) return 0.0; const getBigrams = (str) => { const b = []; for (let i = 0; i < str.length - 1; i++) b.push(str.substring(i, i + 2)); return b; }; const bg1 = getBigrams(s1); const bg2 = getBigrams(s2); let intersection = 0; const bg2Copy = [...bg2]; for (const pair of bg1) { const idx = bg2Copy.indexOf(pair); if (idx !== -1) { intersection++; bg2Copy.splice(idx, 1); } } return (2.0 * intersection) / (bg1.length + bg2.length); }
    function findRelevantContents(query, maxResults = 5) {
        const taggedItems = [...state.data.video.map((item, i) => ({ ...item, _tab: 'video', _index: i })), ...state.data.drive.map((item, i) => ({ ...item, _tab: 'drive', _index: i })), ...state.data.qa.map((item, i) => ({ ...item, _tab: 'qa', _index: i })), ...state.data.rebuttal.map((item, i) => ({ ...item, _tab: 'rebuttal', _index: i }))];
        const scored = taggedItems.map(item => { let targetText = '', displayText = '', refLabel = ''; if (item.sourceType === 'manual') { targetText = `${item.category} ${item.title} ${item.desc || ''}`; displayText = `[動画: ${item.title}] 内容: ${item.desc}`; refLabel = item.title; } else if (item.sourceType === 'material') { targetText = `${item.large} ${item.medium} ${item.small} ${item.detail} ${item.desc}`; const name = item.detail || item.small || item.medium || item.large; displayText = `[資料: ${name}] 内容: ${item.desc}`; refLabel = name; } else { targetText = `${item.category} ${item.question} ${item.answer}`; const tabLabel = item._tab === 'rebuttal' ? '切り返し' : 'Q&A'; displayText = `[${tabLabel}] Q: ${item.question}\nA: ${item.answer}`; refLabel = item.question; } const queryWords = query.toLowerCase().replace(/[\s　]+/g, ' ').split(' ').filter(w => w.length > 1); let keywordScore = 0; queryWords.forEach(w => { if (targetText.toLowerCase().includes(w)) keywordScore += 0.15; }); const bigramScore = calculateSimilarity(query, targetText); return { item, score: Math.min(bigramScore + keywordScore, 1.0), displayText, refLabel, tab: item._tab, index: item._index }; });
        return scored.filter(s => s.score >= THRESHOLDS.SUGGESTION).sort((a, b) => b.score - a.score).slice(0, maxResults);
    }
    async function sendChatMessage() {
        const now = Date.now(); if (state.lockedUntil > now) return; const text = els.chatInput.value.trim(); if (!text) return;
        const LIMIT_COUNT = 8; const LIMIT_WINDOW = 3 * 60 * 1000; state.messageTimestamps = state.messageTimestamps.filter(t => t > now - LIMIT_WINDOW);
        if (state.messageTimestamps.length >= LIMIT_COUNT) { state.lockedUntil = now + LIMIT_WINDOW; addMessage('連続で質問をしすぎているようです。しばらく経ってから再度お試しください。<br>または、<a href="https://lin.ee/0rNANZ7" target="_blank" rel="noopener noreferrer">事務局へ連絡</a>', 'system'); els.chatInput.value = ''; setInputLock(true); setTimeout(() => { if (Date.now() >= state.lockedUntil) { setInputLock(false); state.lockedUntil = 0; } }, LIMIT_WINDOW); return; }
        state.messageTimestamps.push(now); addMessage(text, 'user'); els.chatInput.value = ''; const loadingDiv = addTypingIndicator();
        try {
            const relevantResults = findRelevantContents(text, 5); const topScore = relevantResults.length > 0 ? relevantResults[0].score : 0;
            const tabLabelMap = { video: '動画カリキュラム', drive: '資料ドライブ', qa: 'Q&A', rebuttal: '切り返し集' };
            const commonInstruction = `\n[AIの振る舞い・回答ルール]\n1. 機能に関する質問: 「パートナーQA、商談切り返し、動画・資料マニュアルの案内が可能です」と回答。\n2. 挨拶: 端的に返す。\n3. 不適切: 拒否する。\n4. フォーマット: **太字**使用。外部URLリンクは[こちら](URL)形式。\n5. 関連する参考情報がある場合は、回答内で「こちらの動画」「こちらのQ&A」「こちらの資料」「こちらの切り返し集」などの言葉で言及してください。具体的なリンクボタンは回答の後にシステムが自動で付与するため、回答文内にREF_LINKタグは書かないでください。`;
            const contextText = relevantResults.map((r, i) => `${i+1}. [${tabLabelMap[r.tab]}] ${r.displayText}`).join('\n');
            let prompt = '';
            if (topScore >= THRESHOLDS.CONFIDENCE) { prompt = `あなたは営業パートナー支援AIです。以下の[参考情報]を元に質問に回答してください。複数の参考情報がある場合は、関連するものすべてに言及してください。\n\n[参考情報]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            else if (topScore >= THRESHOLDS.SUGGESTION) { prompt = `あなたは営業パートナー支援AIです。完全一致しませんでしたが、近い資料が見つかりました。「もしかしてこちらですか？」と提案してください。\n\n[近い資料]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            else { prompt = `あなたは営業パートナー支援AIです。関連資料は見当たりませんでしたが、ルールに従って回答してください。業務的な質問で答えられない場合は謝罪してください。\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            const response = await fetch(CONFIG.geminiProxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            const data = await response.json(); loadingDiv.remove();
            if (data.error) { addMessage(`システムエラー: ${data.error.message}`, 'system'); }
            else {
                let answer = data.candidates?.[0]?.content?.parts?.[0]?.text || 'すみません、回答を生成できませんでした。';
                let refLinksHtml = '';
                if (relevantResults.length > 0 && topScore >= THRESHOLDS.SUGGESTION) {
                    const badgeClassMap = { video: 'badge-video', drive: 'badge-drive', qa: 'badge-qa', rebuttal: 'badge-rebuttal' };
                    const iconMap = { video: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>', drive: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>', qa: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', rebuttal: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' };
                    refLinksHtml = '<div class="chat-ref-links">';
                    relevantResults.forEach(r => { const label = r.refLabel.length > 30 ? r.refLabel.substring(0, 30) + '…' : r.refLabel; const badge = `<span class="ref-badge ${badgeClassMap[r.tab]}">${tabLabelMap[r.tab]}</span>`; const icon = iconMap[r.tab]; if (r.tab === 'drive' && r.item.url && r.item.url !== '#') { refLinksHtml += `<a class="chat-ref-btn" href="${r.item.url}" target="_blank" rel="noopener noreferrer">${icon}${badge}<span>${label}</span></a>`; } else { refLinksHtml += `<a class="chat-ref-btn" onclick="navigateToItem('${r.tab}', ${r.index})">${icon}${badge}<span>${label}</span></a>`; } });
                    refLinksHtml += '</div>';
                }
                addMessage(answer, 'bot', refLinksHtml + '<div style="display:block; margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:11px; color:#888; line-height:1.4;">※回答は必ずしも正しいとは限りません。重要な情報は事務局まで確認するようにしてください。</div>');
            }
        } catch (err) { loadingDiv.remove(); console.error(err); addMessage("通信エラーが発生しました。", 'system'); }
    }
    function init() { loadUserPreferences(); els.input.addEventListener('input', (e) => { state.searchText = e.target.value; renderView(); }); window.addEventListener('resize', updateLayoutMetrics); loadCachedData(); fetchAllData(); setInterval(fetchAllData, CONFIG.refreshInterval); }
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>


================================================================
FILE: public/manual/videos/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画カリキュラム｜パートナー様向けマニュアル｜営業革命｜BakuApo</title>
    <meta name="description" content="パートナー（正規代理店）様向けの動画カリキュラムです。営業ノウハウや製品知識を動画で学べます。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="動画カリキュラム｜パートナー様向けマニュアル｜営業革命｜BakuApo">
    <meta property="og:description" content="パートナー（正規代理店）様向けの動画カリキュラムです。営業ノウハウや製品知識を動画で学べます。">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/ogp-manual.png">
    <meta property="og:site_name" content="営業革命｜BakuApo">
    <link rel="icon" href="/bakuapo-logo.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #F7F7F5; --card-bg: #FFFFFF; --text-main: #1A1A1A; --text-sub: #787774;
            --border-color: #E9E9E7; --border-subtle: #F3F4F6; --accent-color: #2383E2;
            --star-color-on: #F2C94C; --check-color-on: #27AE60; --link-color: #2563EB;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
            --sidebar-width: 220px; --max-width: 1200px;
            --chat-primary: #2383E2; --chat-bg: #fff; --chat-bubble-bot: #F7F7F5;
            --chat-bubble-user: #2383E2; --chat-text-bot: #1A1A1A; --chat-text-user: #FFFFFF;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; -webkit-font-smoothing: antialiased; }
        .container { max-width: var(--max-width); margin: 0 auto; padding: 0 24px; }

        header {
            position: sticky; top: 0; z-index: 100; padding: 16px 0 12px;
            background: rgba(250, 250, 250, 0.88); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-color);
        }
        .header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .logo-group { display: flex; align-items: center; gap: 10px; }
        .logo-group img { height: 26px; }
        .logo-divider { width: 1px; height: 20px; background-color: var(--border-color); }
        .header-title { font-size: 12px; font-weight: 600; color: var(--text-sub); letter-spacing: 0.02em; }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; overflow-x: auto; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            flex: 1; padding: 12px; cursor: pointer;
            font-size: 14px; font-weight: 600; color: var(--text-sub);
            border-bottom: 3px solid transparent; transition: all 0.2s;
            font-family: inherit; background: none;
            border-top: none; border-left: none; border-right: none;
            text-decoration: none; display: inline-block; text-align: center;
            white-space: nowrap;
        }
        .tab-btn:hover { background-color: rgba(0,0,0,0.03); color: var(--text-main); }
        .tab-btn.active { color: var(--text-main); border-bottom-color: var(--text-main); }

        .controls-wrapper { display: flex; flex-direction: column; gap: 8px; }
        .search-container { position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none; }
        .search-input {
            width: 100%; padding: 10px 14px 10px 38px; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 14px; outline: none;
            transition: all 0.2s; font-family: inherit; background-color: var(--card-bg);
        }
        .search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .status-bar { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-sub); padding-left: 2px; }
        .loading-indicator { display: none; align-items: center; gap: 6px; font-size: 12px; color: var(--text-sub); }
        .loading-indicator.active { display: inline-flex; }
        .spinner { width: 14px; height: 14px; border: 2px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Chatbot Reference Links --- */
        .chat-ref-links { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
        .chat-ref-btn {
            display: flex; align-items: center; gap: 6px; padding: 6px 10px;
            background: var(--border-subtle); border-radius: var(--radius-sm); text-decoration: none; color: var(--text-main);
            font-size: 12px; cursor: pointer; transition: background 0.15s; border: 1px solid var(--border-color);
        }
        .chat-ref-btn:hover { background: #E5E7EB; }
        .ref-icon { width: 14px; height: 14px; flex-shrink: 0; }
        .ref-badge { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }
        .badge-video { background: #DBEAFE; color: #1D4ED8; }
        .badge-drive { background: #D1FAE5; color: #065F46; }
        .badge-qa { background: #FEF3C7; color: #92400E; }
        .badge-rebuttal { background: #FCE7F3; color: #9D174D; }
        .badge-site { background: #E0E7FF; color: #3730A3; }

        /* --- Loading Overlay & Skeleton --- */
        .initial-loading { display: flex; flex-direction: column; align-items: center; padding: 48px 0; gap: 16px; }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.7s linear infinite; }
        .loading-text { font-size: 13px; color: var(--text-sub); }
        .skeleton-list { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
        .skeleton-card { background: var(--card-bg); border-radius: var(--radius-md); padding: 20px; border: 1px solid var(--border-color); }
        .skeleton-line { height: 12px; border-radius: 6px; background: linear-gradient(90deg, var(--border-subtle) 25%, #e5e7eb 50%, var(--border-subtle) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .skeleton-line.title { width: 40%; height: 14px; margin-bottom: 12px; }
        .skeleton-line.long { width: 90%; margin-bottom: 8px; }
        .skeleton-line.medium { width: 70%; margin-bottom: 8px; }
        .skeleton-line.short { width: 50%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* --- Main Layout --- */
        .main-layout { display: flex; gap: 24px; padding-top: 20px; padding-bottom: 80px; }
        .sidebar {
            position: sticky; width: var(--sidebar-width); flex-shrink: 0;
            max-height: calc(100vh - 200px); overflow-y: auto;
            display: flex; flex-direction: column; gap: 4px;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }

        .filter-section {
            display: flex; flex-direction: column; gap: 4px;
            margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
        }
        .filter-btn {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
            color: var(--text-main); transition: all 0.2s; user-select: none; width: 100%;
        }
        .filter-btn:hover { background: #F0F0EF; }
        .filter-icon { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }
        i.filter-icon { width: auto; height: auto; font-size: 14px; color: currentColor; fill: none; }
        .filter-btn.active-star { background: #FFF9E6; border-color: var(--star-color-on); color: #946F00; }
        .filter-btn.active-star .filter-icon { fill: var(--star-color-on); }
        .filter-btn.active-unwatched { background: #E8F5E9; border-color: var(--check-color-on); color: #1E8449; }

        .sidebar-title { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; padding-left: 4px; }
        .category-nav-list { list-style: none; display: flex; flex-direction: column; gap: 1px; }
        .category-nav-item {
            font-size: 13px; padding: 7px 10px; border-radius: var(--radius-sm);
            cursor: pointer; color: var(--text-sub); transition: all 0.15s; font-weight: 500;
        }
        .category-nav-item:hover { background-color: var(--border-subtle); color: var(--text-main); }

        .content-area { flex: 1; min-width: 0; }
        .list-section { display: none; }
        .list-section.active { display: block; }

        /* --- Video Card Design --- */
        .card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px;
            position: relative; transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .category-badge {
            display: inline-block; font-size: 11px; font-weight: 600; color: var(--text-sub);
            background-color: var(--border-subtle); padding: 3px 10px; border-radius: 20px;
            margin-bottom: 10px; letter-spacing: 0.02em;
        }
        .video-title { font-size: 17px; font-weight: 700; line-height: 1.5; margin-bottom: 14px; padding-right: 70px; }
        .video-embed-container {
            position: relative; width: 100%; padding-bottom: 56.25%;
            border-radius: var(--radius-md); overflow: hidden; margin-bottom: 14px;
            background-color: #000;
        }
        .video-embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* --- Drive File List --- */
        .drive-category-group { margin-bottom: 24px; }
        .drive-category-title {
            font-size: 22px; font-weight: 700; margin-bottom: 24px; padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color); color: var(--text-main);
        }
        .drive-medium-block { margin-left: 8px; margin-bottom: 24px; padding-left: 20px; border-left: 3px solid var(--border-color); }
        .drive-medium-header { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; padding: 4px 0; }
        .folder-icon { width: 18px; height: 18px; fill: none; stroke: var(--text-sub); stroke-width: 1.5; }
        .drive-small-group { margin-left: 8px; margin-bottom: 12px; }
        .drive-small-header { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .small-icon { width: 10px; height: 10px; }
        .drive-file-list { list-style: none; display: flex; flex-direction: column; gap: 2px; }
        .drive-file-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 14px;
            border-radius: var(--radius-sm); text-decoration: none; color: var(--text-main);
            transition: background-color 0.15s; border: 1px solid transparent;
        }
        .drive-file-item:hover { background-color: var(--border-subtle); border-color: var(--border-color); }
        .file-content-wrapper { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
        .file-thumbnail {
            width: 44px; height: 44px; border-radius: var(--radius-sm); overflow: hidden;
            background-color: var(--border-subtle); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .file-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .icon-svg { width: 24px; height: 24px; }
        .icon-svg.type-sheet { stroke: #0F9D58; }
        .icon-svg.type-doc { stroke: #4285F4; }
        .icon-svg.type-slide { stroke: #F4B400; }
        .icon-svg.type-pdf { stroke: #DB4437; }
        .icon-svg.type-web { stroke: var(--text-sub); }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-desc { font-size: 12px; color: var(--text-sub); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Action Buttons --- */
        .action-buttons { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: none; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.15s; color: var(--text-sub);
        }
        .icon-btn:hover { background-color: var(--border-subtle); }
        .icon-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
        .star-btn.active { color: var(--star-color-on); }
        .star-btn.active svg { fill: var(--star-color-on); stroke: var(--star-color-on); }
        .check-btn.active { color: var(--check-color-on); }
        .check-btn.active svg { fill: var(--check-color-on); stroke: var(--check-color-on); }

        .video-duration-chip {
            display: none; position: absolute; top: 20px; right: 80px;
            background-color: var(--border-subtle); color: var(--text-sub);
            font-size: 11px; font-weight: 600;
            padding: 3px 10px; border-radius: 20px;
            margin-left: 6px; vertical-align: middle;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.01em;
        }
        .description { font-size: 14px; white-space: pre-wrap; margin-bottom: 14px; word-wrap: break-word; color: var(--text-sub); line-height: 1.7; }
        .material-btn {
            display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sub);
            background-color: var(--border-subtle); padding: 7px 12px; border-radius: var(--radius-sm); text-decoration: none;
            font-weight: 500; transition: all 0.15s; border: 1px solid var(--border-color);
        }
        .material-btn:hover { background-color: #E5E7EB; color: var(--text-main); }

        /* --- Q&A Card Design --- */
        .qa-card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--radius-lg); padding: 0; margin-bottom: 12px;
            overflow: hidden; transition: box-shadow 0.2s;
        }
        .qa-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .qa-question {
            display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px;
            font-weight: 600; font-size: 14px; line-height: 1.6;
            background-color: var(--border-subtle); border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .qa-question .action-buttons { position: absolute; top: 14px; right: 14px; }
        .qa-answer {
            display: flex; align-items: flex-start; gap: 12px; padding: 18px 20px;
            font-size: 14px; line-height: 1.8; white-space: pre-wrap; color: var(--text-main);
        }
        .qa-badge {
            flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; border-radius: 50%; font-size: 13px; font-weight: 700;
            margin-top: 1px;
        }
        .qa-badge-q { background-color: var(--accent-color); color: #fff; }
        .qa-badge-a { background-color: var(--check-color-on); color: #fff; }

        /* --- Rebuttal Card Design --- */
        .rebuttal-card { border-left: 3px solid #EF4444; }
        .rebuttal-objection { background-color: #FEF2F2; }
        .rebuttal-badge-obj { background-color: #EF4444; color: #fff; font-size: 10px; width: auto; padding: 3px 8px; border-radius: 6px; }
        .rebuttal-badge-res { background-color: var(--accent-color); color: #fff; font-size: 10px; width: auto; padding: 3px 8px; border-radius: 6px; }

        .message-state { text-align: center; padding: 48px; color: var(--text-sub); font-size: 14px; }
        .error-container { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .error-message { color: #DC2626; background: #FEF2F2; padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; border: 1px solid #FECACA; }

        /* --- Chatbot Widget Styles --- */
        .chat-widget {
            position: fixed; bottom: 24px; right: 24px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end;
            font-family: inherit;
        }
        .chat-toggle-btn {
            height: 56px; padding: 0 24px 0 20px; border-radius: 30px;
            background-color: var(--chat-primary); color: white; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.2s; font-weight: 700; font-size: 15px; font-family: inherit;
        }
        .chat-toggle-btn:hover { transform: scale(1.05); }
        .chat-toggle-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .chat-btn-text { display: block; }

        .chat-window {
            position: absolute; bottom: 72px; right: 0; width: 350px; height: 500px;
            background-color: var(--chat-bg); border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none; flex-direction: column; overflow: hidden;
            transform-origin: bottom right;
        }
        .chat-window.active { display: flex; }

        .chat-header {
            padding: 14px 16px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .chat-close {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; font-size: 16px;
        }
        .chat-close:hover { background: var(--border-subtle); }

        .chat-messages {
            flex: 1; padding: 16px; overflow-y: auto; background-color: var(--card-bg);
            display: flex; flex-direction: column; gap: 10px;
        }
        .chat-msg {
            max-width: 85%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.6; word-wrap: break-word;
        }
        .chat-msg.bot { align-self: flex-start; background-color: var(--chat-bubble-bot); color: var(--chat-text-bot); border-bottom-left-radius: 2px; }
        .chat-msg.user { align-self: flex-end; background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 2px; }
        .chat-msg.system { align-self: center; background-color: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; font-size: 12px; text-align: left; max-width: 90%; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .chat-msg a { color: var(--link-color); text-decoration: underline; text-underline-offset: 2px; word-break: break-all; }
        .chat-msg a:hover { text-decoration: none; }

        .chat-input-area {
            padding: 12px; border-top: 1px solid var(--border-color);
            display: flex; gap: 8px; background-color: var(--card-bg);
        }
        .chat-input {
            flex: 1; padding: 9px 14px; border: 1px solid var(--border-color); border-radius: 20px;
            font-size: 13px; outline: none; transition: all 0.2s; font-family: inherit;
        }
        .chat-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .chat-input:disabled { background-color: var(--border-subtle); cursor: not-allowed; }
        .chat-send-btn { background: none; border: none; cursor: pointer; color: var(--accent-color); padding: 4px; }
        .chat-send-btn:disabled { color: var(--text-sub); cursor: not-allowed; }

        .typing-dots { display: flex; gap: 4px; padding: 4px 8px; }
        .typing-dot { width: 5px; height: 5px; background-color: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            header { padding: 12px 0; }
            .header-top { margin-bottom: 12px; }
            .logo-group img { height: 22px; }
            .header-title { font-size: 11px; }
            .tabs { margin-bottom: 12px; }
            .tab-btn { font-size: 12px; padding: 10px 6px; }
            .status-bar { display: none; }
            .main-layout { flex-direction: column; gap: 12px; padding-top: 4px; }
            .sidebar {
                position: sticky; z-index: 90; width: calc(100% + 32px); margin-left: -16px;
                padding: 8px 16px; border-bottom: 1px solid var(--border-color);
                max-height: none; overflow-x: auto; display: flex; align-items: center; gap: 6px;
                background: rgba(250, 250, 250, 0.9);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .sidebar::-webkit-scrollbar { display: none; }
            .filter-section {
                flex-direction: row; margin: 0; padding: 0; border: none;
                padding-right: 6px; margin-right: 4px; border-right: 1px solid var(--border-color);
            }
            .filter-btn { padding: 5px 8px; width: auto; font-size: 11px; white-space: nowrap; }
            .sidebar-title { display: none; }
            .category-nav-list { display: flex; gap: 6px; }
            .category-nav-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 12px; font-size: 11px; }
            .card { scroll-margin-top: 240px; padding: 18px; }
            .drive-category-group { scroll-margin-top: 240px; }
            .drive-medium-block { margin-left: 0; padding-left: 12px; }
            .drive-file-list { margin-left: 0; }
            .file-thumbnail { width: 38px; height: 38px; }
            .file-name { font-size: 13px; }
            .icon-svg { width: 20px; height: 20px; }
            .video-title { font-size: 15px; padding-right: 60px; }
            .chat-toggle-btn { width: 56px; height: 56px; border-radius: 50%; padding: 0; }
            .chat-btn-text { display: none; }
            .chat-window { width: calc(100vw - 32px); right: -8px; bottom: 80px; height: 60vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <header id="mainHeader">
        <div class="header-top">
            <div class="logo-group">
                <img src="/eigyou-kakumei_logo.svg" alt="営業革命" onerror="this.style.display='none'">
                <div class="logo-divider"></div>
                <img src="/bakuapo-logo.svg" alt="BakuApo" onerror="this.style.display='none'">
            </div>
            <span class="header-title">パートナー様向けマニュアル</span>
        </div>

        <div class="tabs">
            <a class="tab-btn active" href="/manual/videos/">動画カリキュラム</a>
            <a class="tab-btn" href="/manual/resources/">資料ドライブ</a>
            <a class="tab-btn" href="/manual/faq/">Q&A</a>
        </div>

        <div class="controls-wrapper">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
            </div>
            <div id="errorContainer" class="error-container"></div>
            <div class="status-bar">
                <span id="countDisplay">0件</span>
                <div class="loading-indicator" id="loadingIndicator"><div class="spinner"></div><span>更新中...</span></div>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar" id="stickySidebar">
            <div class="filter-section">
                <div class="filter-btn" id="starFilterBtn" onclick="toggleStarFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>スター付きのみ</span>
                </div>
                <div class="filter-btn" id="unwatchedFilterBtn" onclick="toggleUnwatchedFilter()">
                    <i class="fa-regular fa-eye filter-icon"></i>
                    <span>未視聴のみ表示</span>
                </div>
            </div>
            <div class="sidebar-title">カテゴリー目次</div>
            <ul class="category-nav-list" id="categoryNav"></ul>
        </aside>

        <main class="content-area" id="contentArea">
            <div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line medium"></div><div class="skeleton-line long"></div></div></div></div>
        </main>
    </div>

    <div class="chat-widget">
        <button class="chat-toggle-btn" onclick="toggleChat()" title="AIアシスタントに質問">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6v-4h12v4zm0-6H6V7h12v6z"/><circle cx="8.5" cy="10.5" r="1.5"/><circle cx="15.5" cy="10.5" r="1.5"/></svg>
            <span class="chat-btn-text">AIに質問する</span>
        </button>

        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">AIパートナーアシスタント</span>
                <button class="chat-close" onclick="toggleChat()">✕</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg bot">
                    こんにちは！<br>動画カリキュラム、資料、Q&A、切り返しトークについて、ご質問があればお答えします。
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const CURRENT_TAB = 'video';
    const TAB_URLS = { video: '/manual/videos/', drive: '/manual/resources/', qa: '/manual/faq/' };

    const CONFIG = {
        geminiProxyUrl: "/api/gemini-proxy",
        videoSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=396280088&single=true&output=csv",
        driveSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=380310918&single=true&output=csv",
        qaSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1192474135&single=true&output=csv",
        rebuttalSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1328585848&single=true&output=csv",
        refreshInterval: 60000,
        sitePages: [
            { url: '/', label: 'BakuApoトップページ', section: 'サービス紹介' },
            { url: '/001/', label: 'キャンペーン記事（トーク力）', section: 'キャンペーン' },
            { url: '/002/', label: 'キャンペーン記事（フォーム営業）', section: 'キャンペーン' },
            { url: '/user-guide/', label: 'ユーザーガイド', section: 'ユーザーガイド' },
            { url: '/user-guide/quick-start/', label: 'クイックスタートガイド', section: 'ユーザーガイド' },
            { url: '/checkout/', label: 'BakuApo決済・料金情報', section: '料金・購入' },
            { url: '/contract/', label: 'BakuApo利用契約書', section: '契約' },
            { url: '/conversion-report/', label: '成果レポート', section: 'レポート' },
            { url: '/links/', label: 'リンク集', section: 'リンク' },
            { url: '/list-purchase/contract/', label: 'BakuApoリスト購入契約', section: '料金・購入' },
            { url: '/list-purchase/checkout/', label: 'BakuApoリスト決済情報', section: '料金・購入' },
            { url: '/feedback/', label: 'フィードバック', section: 'サポート' }
        ]
    };

    const THRESHOLDS = { CONFIDENCE: 0.6, SUGGESTION: 0.25 };

    const state = {
        currentTab: CURRENT_TAB,
        searchText: '',
        showStarredOnly: false,
        showUnwatchedOnly: false,
        starredItems: new Set(),
        watchedItems: new Set(),
        data: { video: [], drive: [], qa: [], rebuttal: [] },
        isLoaded: { video: false, drive: false, qa: false, rebuttal: false },
        hasError: false,
        chatHistory: [],
        messageTimestamps: [],
        lockedUntil: 0,
        siteContent: []
    };

    const els = {
        input: document.getElementById('searchInput'),
        count: document.getElementById('countDisplay'),
        loading: document.getElementById('loadingIndicator'),
        errorContainer: document.getElementById('errorContainer'),
        categoryNav: document.getElementById('categoryNav'),
        header: document.getElementById('mainHeader'),
        sidebar: document.getElementById('stickySidebar'),
        starFilterBtn: document.getElementById('starFilterBtn'),
        unwatchedFilterBtn: document.getElementById('unwatchedFilterBtn'),
        contentArea: document.getElementById('contentArea'),
        chatWindow: document.getElementById('chatWindow'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        chatSendBtn: document.getElementById('chatSendBtn')
    };

    function updateLayoutMetrics() {
        const headerHeight = els.header.offsetHeight;
        const isMobile = window.innerWidth <= 768;
        const topOffset = isMobile ? headerHeight : headerHeight + 20;
        els.sidebar.style.top = `${topOffset}px`;
        const totalStickyHeight = isMobile ? topOffset + els.sidebar.offsetHeight + 20 : topOffset;
        document.querySelectorAll('.card, .drive-category-group').forEach(el => {
            el.style.scrollMarginTop = `${totalStickyHeight}px`;
        });
    }

    function loadUserPreferences() {
        try {
            const stars = localStorage.getItem('partner_manual_stars_v2');
            if (stars) state.starredItems = new Set(JSON.parse(stars));
            const watched = localStorage.getItem('partner_manual_watched_v2');
            if (watched) state.watchedItems = new Set(JSON.parse(watched));
        } catch (e) {}
    }

    function saveUserPreferences() {
        localStorage.setItem('partner_manual_stars_v2', JSON.stringify([...state.starredItems]));
        localStorage.setItem('partner_manual_watched_v2', JSON.stringify([...state.watchedItems]));
    }

    function toggleStar(key) {
        if (state.starredItems.has(key)) state.starredItems.delete(key);
        else state.starredItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleWatched(key) {
        if (state.watchedItems.has(key)) state.watchedItems.delete(key);
        else state.watchedItems.add(key);
        saveUserPreferences();
        renderView();
    }

    function toggleStarFilter() {
        state.showStarredOnly = !state.showStarredOnly;
        els.starFilterBtn.classList.toggle('active-star', state.showStarredOnly);
        renderView();
    }

    function toggleUnwatchedFilter() {
        state.showUnwatchedOnly = !state.showUnwatchedOnly;
        els.unwatchedFilterBtn.classList.toggle('active-unwatched', state.showUnwatchedOnly);
        renderView();
    }

    function parseCSV(text) {
        const arr = []; let quote = false; let row = []; let col = ''; let c = 0;
        for (; c < text.length; c++) {
            let cc = text[c], nc = text[c+1];
            if (quote) {
                if (cc === '"') { if (nc === '"') { col += '"'; c++; } else { quote = false; } } else { col += cc; }
            } else {
                if (cc === '"') { quote = true; }
                else if (cc === ',') { row.push(col); col = ''; }
                else if (cc === '\r' && nc === '\n') { row.push(col); col = ''; arr.push(row); row = []; c++; }
                else if (cc === '\n' || cc === '\r') { row.push(col); col = ''; arr.push(row); row = []; }
                else { col += cc; }
            }
        }
        if (col.length > 0 || row.length > 0) { row.push(col); arr.push(row); }
        return arr;
    }

    /* --- YouTube IFrame Player API --- */
    let ytApiReady = false;
    let ytApiCallbacks = [];
    function loadYTApi() {
        if (window.YT && window.YT.Player) { ytApiReady = true; return; }
        if (document.getElementById('yt-iframe-api')) return;
        const tag = document.createElement('script');
        tag.id = 'yt-iframe-api';
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);
    }
    window.onYouTubeIframeAPIReady = function() {
        ytApiReady = true;
        ytApiCallbacks.forEach(fn => fn());
        ytApiCallbacks = [];
    };
    function whenYTReady(fn) {
        if (ytApiReady) fn(); else ytApiCallbacks.push(fn);
    }
    function formatDuration(seconds) {
        const s = Math.round(seconds);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        if (m >= 60) {
            const h = Math.floor(m / 60);
            const rm = m % 60;
            return `${h}:${String(rm).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }
        return `${m}:${String(sec).padStart(2,'0')}`;
    }
    function fetchVideoDurations() {
        loadYTApi();
        whenYTReady(function() {
            document.querySelectorAll('.video-embed-container[data-vid]').forEach(container => {
                const vidId = container.dataset.vid;
                const chip = document.getElementById('dur-' + vidId);
                if (!chip) return;
                const iframe = container.querySelector('iframe');
                if (!iframe) return;
                try {
                    const player = new YT.Player(iframe, {
                        events: {
                            onReady: function(e) {
                                const dur = e.target.getDuration();
                                if (dur > 0) {
                                    chip.innerHTML = '<i class="fa-regular fa-clock" style="margin-right:4px;font-size:10px;opacity:.7"></i>' + formatDuration(dur);
                                    chip.style.display = 'inline-block';
                                } else {
                                    chip.style.display = 'none';
                                }
                            }
                        }
                    });
                } catch(ex) {
                    chip.style.display = 'none';
                }
            });
        });
    }

    function extractYoutubeId(url) {
        if (!url) return null;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function createActionButtons(id, tab) {
        const div = document.createElement('div');
        div.className = 'action-buttons';
        const isStarred = state.starredItems.has(id);
        const isWatched = state.watchedItems.has(id);
        const starTitle = isStarred ? 'スター付きを外す' : 'スター付きにする';
        const checkLabel = tab === 'video' ? '試聴済み' : '確認済み';
        const checkTitle = isWatched ? `${checkLabel}を外す` : `${checkLabel}にする`;
        div.innerHTML = `
            <button class="icon-btn star-btn ${isStarred?'active':''}" onclick="toggleStar('${id}')" title="${starTitle}">
                <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            </button>
            <button class="icon-btn check-btn ${isWatched?'active':''}" onclick="toggleWatched('${id}')" title="${checkTitle}">
                <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </button>
        `;
        return div;
    }

    function renderNav(categories, idMap) {
        const frag = document.createDocumentFragment();
        categories.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'category-nav-item';
            li.textContent = cat;
            li.onclick = () => {
                const el = document.getElementById(idMap[cat]);
                if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
            };
            frag.appendChild(li);
        });
        els.categoryNav.appendChild(frag);
    }

    function renderVideoList(items, container) {
        const categories = new Set();
        const catMap = {};
        items.forEach((item, idx) => {
            const card = document.createElement('article');
            card.className = 'card';
            card.id = `video-${idx}`;
            if (!categories.has(item.category)) {
                categories.add(item.category);
                catMap[item.category] = card.id;
            }
            card.innerHTML += `<div class="category-badge">${item.category}</div>`;
            const vidId = extractYoutubeId(item.youtubeUrl);
            if (vidId) {
                card.innerHTML += `<span class="video-duration-chip" id="dur-${vidId}"></span>`;
            }
            const actions = createActionButtons(item.id, 'video');
            card.appendChild(actions);
            const h3 = document.createElement('h3');
            h3.className = 'video-title';
            h3.textContent = item.title;
            card.appendChild(h3);
            if (vidId) {
                card.innerHTML += `<div class="video-embed-container" data-vid="${vidId}"><iframe src="https://www.youtube.com/embed/${vidId}?enablejsapi=1" loading="lazy" allowfullscreen></iframe></div>`;
            }
            if (item.desc) card.innerHTML += `<div class="description">${item.desc}</div>`;
            if (item.materialUrl) {
                card.innerHTML += `<a href="${item.materialUrl}" target="_blank" class="material-btn"><svg viewBox="0 0 24 24" class="filter-icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg><span>テキスト資料</span></a>`;
            }
            container.appendChild(card);
        });
        renderNav(categories, catMap);
        fetchVideoDurations();
    }

    function renderView() {
        const container = els.contentArea;
        container.innerHTML = '';
        els.categoryNav.innerHTML = '';
        const sourceData = state.data[CURRENT_TAB];
        const query = state.searchText.toLowerCase().trim();

        if (!state.isLoaded[CURRENT_TAB]) {
            container.innerHTML = `<div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>`;
            return;
        }

        const filtered = sourceData.filter(item => {
            if (state.showStarredOnly && !state.starredItems.has(item.id)) return false;
            if (state.showUnwatchedOnly && state.watchedItems.has(item.id)) return false;
            if (!query) return true;
            return JSON.stringify(item).toLowerCase().includes(query);
        });

        els.count.textContent = `${filtered.length}件`;

        if (filtered.length === 0) {
            container.innerHTML = `<div class="message-state">該当なし</div>`;
            return;
        }

        renderVideoList(filtered, container);
        requestAnimationFrame(updateLayoutMetrics);
    }

    function loadCachedData() {
        try {
            const cached = sessionStorage.getItem('manual_cache_v1');
            if (cached) { const obj = JSON.parse(cached); state.data = obj.data; state.isLoaded = obj.isLoaded; renderView(); return true; }
        } catch (e) {}
        return false;
    }
    function saveCacheData() {
        try { sessionStorage.setItem('manual_cache_v1', JSON.stringify({ data: state.data, isLoaded: state.isLoaded })); } catch (e) {}
    }

    async function fetchAllData() {
        const isFirstLoad = !state.isLoaded[CURRENT_TAB];
        if (isFirstLoad) { els.loading.classList.add('active'); }
        els.errorContainer.style.display = 'none';
        try {
            const vRes = await fetch(`${CONFIG.videoSheetUrl}&t=${Date.now()}`);
            if (vRes.ok) {
                const vText = await vRes.text();
                const vRows = parseCSV(vText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.video = vRows.map(r => ({
                    sourceType: 'manual', id: r[2] || r[3], category: r[1] || '未分類',
                    youtubeUrl: r[2], title: r[3], desc: r[4], materialUrl: r[5]
                }));
                state.isLoaded.video = true;
            }
            const dRes = await fetch(`${CONFIG.driveSheetUrl}&t=${Date.now()}`);
            if (dRes.ok) {
                const dText = await dRes.text();
                const dRows = parseCSV(dText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.drive = dRows.map(r => ({
                    sourceType: 'material', id: r[5] || '#',
                    large: r[1] || 'その他', medium: r[2] || '', small: r[3] || '', detail: r[4] || '',
                    url: r[5] || '#', desc: r[6] || ''
                }));
                state.isLoaded.drive = true;
            }
            const qRes = await fetch(`${CONFIG.qaSheetUrl}&t=${Date.now()}`);
            if (qRes.ok) {
                const qText = await qRes.text();
                const qRows = parseCSV(qText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.qa = qRows.map((r, i) => ({
                    sourceType: 'qa', id: `qa-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.qa = true;
            }
            const rRes = await fetch(`${CONFIG.rebuttalSheetUrl}&t=${Date.now()}`);
            if (rRes.ok) {
                const rText = await rRes.text();
                const rRows = parseCSV(rText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON');
                state.data.rebuttal = rRows.map((r, i) => ({
                    sourceType: 'qa', id: `rebuttal-${r[2] || i}`,
                    category: r[1] || '未分類', question: r[2] || '', answer: r[3] || ''
                }));
                state.isLoaded.rebuttal = true;
            }
        } catch (e) {
            console.error(e);
            state.hasError = true;
            els.errorContainer.style.display = 'flex';
            els.errorContainer.innerHTML = `<div class="error-message">データの更新に失敗しました。</div>`;
        }
        saveCacheData();
        renderView();
        els.loading.classList.remove('active');
    }

    /* --- Chatbot Functions --- */
    function toggleChat() {
        els.chatWindow.classList.toggle('active');
        if (els.chatWindow.classList.contains('active')) {
            els.chatInput.focus();
            scrollToBottom();
        }
    }
    function handleChatKey(e) { if (e.key === 'Enter') sendChatMessage(); }
    function scrollToBottom() { els.chatMessages.scrollTop = els.chatMessages.scrollHeight; }

    function navigateToItem(tab, index) {
        els.chatWindow.classList.remove('active');
        if (tab === CURRENT_TAB) {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    let targetEl = document.getElementById(`video-${index}`);
                    if (targetEl) {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetEl.style.transition = 'box-shadow 0.3s, outline 0.3s';
                        targetEl.style.outline = '2px solid var(--accent-color)';
                        targetEl.style.boxShadow = '0 0 0 4px rgba(35,131,226,0.15)';
                        setTimeout(() => { targetEl.style.outline = 'none'; targetEl.style.boxShadow = ''; }, 2500);
                    }
                });
            });
        } else {
            window.location.href = TAB_URLS[tab];
        }
    }

    function formatChatMessage(text) {
        if (!text) return "";
        let formatted = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        formatted = formatted.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        formatted = formatted.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">リンク</a>');
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>');
        formatted = formatted.replace(/\n/g, '<br>');
        return formatted;
    }

    function addMessage(text, type, appendHtml = "") {
        const div = document.createElement('div');
        div.className = `chat-msg ${type}`;
        div.innerHTML = formatChatMessage(text) + appendHtml;
        els.chatMessages.appendChild(div);
        scrollToBottom();
    }

    function addTypingIndicator() {
        const div = document.createElement('div');
        div.className = 'chat-msg bot typing-indicator';
        div.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
        els.chatMessages.appendChild(div);
        scrollToBottom();
        return div;
    }

    function setInputLock(locked) {
        els.chatInput.disabled = locked;
        els.chatSendBtn.disabled = locked;
        els.chatInput.placeholder = locked ? "送信制限中です (3分間)" : "質問を入力...";
    }

    function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return 0.0;
        const s1 = str1.toLowerCase().replace(/\s+/g, "");
        const s2 = str2.toLowerCase().replace(/\s+/g, "");
        if (s1 === s2) return 1.0;
        if (s1.length < 2 || s2.length < 2) return 0.0;
        const getBigrams = (str) => { const bigrams = []; for (let i = 0; i < str.length - 1; i++) { bigrams.push(str.substring(i, i + 2)); } return bigrams; };
        const bg1 = getBigrams(s1); const bg2 = getBigrams(s2);
        let intersection = 0; const bg2Copy = [...bg2];
        for (const pair of bg1) { const idx = bg2Copy.indexOf(pair); if (idx !== -1) { intersection++; bg2Copy.splice(idx, 1); } }
        return (2.0 * intersection) / (bg1.length + bg2.length);
    }

    async function fetchSiteContent() {
        const results = [];
        const fetches = CONFIG.sitePages.map(async (page) => {
            try {
                const res = await fetch(page.url, { cache: 'force-cache' });
                if (!res.ok) return;
                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                doc.querySelectorAll('script,style,noscript,nav,footer,header').forEach(el => el.remove());
                let text = (doc.body?.innerText || doc.body?.textContent || '').replace(/\s+/g, ' ').trim();
                if (text.length > 1500) text = text.substring(0, 1500);
                if (text.length > 50) results.push({ label: page.label, section: page.section, url: page.url, text: text });
            } catch(e) { /* skip */ }
        });
        await Promise.allSettled(fetches);
        state.siteContent = results;
        console.log(`[AI] サイトコンテンツ ${results.length}ページ取得完了`);
    }

    function findRelevantContents(query, maxResults = 5) {
        const taggedItems = [
            ...state.data.video.map((item, i) => ({ ...item, _tab: 'video', _index: i })),
            ...state.data.drive.map((item, i) => ({ ...item, _tab: 'drive', _index: i })),
            ...state.data.qa.map((item, i) => ({ ...item, _tab: 'qa', _index: i })),
            ...state.data.rebuttal.map((item, i) => ({ ...item, _tab: 'rebuttal', _index: i })),
            ...state.siteContent.map((item, i) => ({ ...item, sourceType: 'site', _tab: 'site', _index: i }))
        ];
        const scored = taggedItems.map(item => {
            let targetText = '', displayText = '', refLabel = '';
            if (item.sourceType === 'site') {
                targetText = `${item.label} ${item.section} ${item.text}`;
                displayText = `[サイト: ${item.label}] ${item.text.substring(0, 300)}`;
                refLabel = item.label;
            } else if (item.sourceType === 'manual') {
                targetText = `${item.category} ${item.title} ${item.desc || ''}`;
                displayText = `[動画: ${item.title}] 内容: ${item.desc}`;
                refLabel = item.title;
            } else if (item.sourceType === 'material') {
                targetText = `${item.large} ${item.medium} ${item.small} ${item.detail} ${item.desc}`;
                const name = item.detail || item.small || item.medium || item.large;
                displayText = `[資料: ${name}] 内容: ${item.desc}`;
                refLabel = name;
            } else {
                targetText = `${item.category} ${item.question} ${item.answer}`;
                const tabLabel = item._tab === 'rebuttal' ? '切り返し' : 'Q&A';
                displayText = `[${tabLabel}] Q: ${item.question}\nA: ${item.answer}`;
                refLabel = item.question;
            }
            const queryWords = query.toLowerCase().replace(/[\s　]+/g, ' ').split(' ').filter(w => w.length > 1);
            let keywordScore = 0;
            queryWords.forEach(w => { if (targetText.toLowerCase().includes(w)) keywordScore += 0.15; });
            const bigramScore = calculateSimilarity(query, targetText);
            const score = Math.min(bigramScore + keywordScore, 1.0);
            return { item, score, displayText, refLabel, tab: item._tab, index: item._index };
        });
        return scored.filter(s => s.score >= THRESHOLDS.SUGGESTION).sort((a, b) => b.score - a.score).slice(0, maxResults);
    }

    async function sendChatMessage() {
        const now = Date.now();
        if (state.lockedUntil > now) return;
        const text = els.chatInput.value.trim();
        if (!text) return;
        const LIMIT_COUNT = 8;
        const LIMIT_WINDOW = 3 * 60 * 1000;
        state.messageTimestamps = state.messageTimestamps.filter(t => t > now - LIMIT_WINDOW);
        if (state.messageTimestamps.length >= LIMIT_COUNT) {
            state.lockedUntil = now + LIMIT_WINDOW;
            addMessage('連続で質問をしすぎているようです。しばらく経ってから再度お試しください。<br>または、<a href="https://lin.ee/0rNANZ7" target="_blank" rel="noopener noreferrer">事務局へ連絡</a>', 'system');
            els.chatInput.value = '';
            setInputLock(true);
            setTimeout(() => { if (Date.now() >= state.lockedUntil) { setInputLock(false); state.lockedUntil = 0; } }, LIMIT_WINDOW);
            return;
        }
        state.messageTimestamps.push(now);
        addMessage(text, 'user');
        els.chatInput.value = '';
        const loadingDiv = addTypingIndicator();
        try {
            const relevantResults = findRelevantContents(text, 5);
            const topScore = relevantResults.length > 0 ? relevantResults[0].score : 0;
            let prompt = '';
            const commonInstruction = `\n[AIの振る舞い・回答ルール]\n1. 機能に関する質問: 「パートナーQA、商談切り返し、動画・資料マニュアル、およびBakuApoサイト全体の情報を参照して案内が可能です」と回答。\n2. 挨拶: 端的に返す。\n3. 不適切: 拒否する。\n4. フォーマット: **太字**使用。外部URLリンクは[こちら](URL)形式。\n5. 関連する参考情報がある場合は、回答内で「こちらの動画」「こちらのQ&A」「こちらの資料」「こちらの切り返し集」「こちらのページ」などの言葉で言及してください。具体的なリンクボタンは回答の後にシステムが自動で付与するため、回答文内にREF_LINKタグは書かないでください。\n6. サイトコンテンツの情報源がある場合は、該当ページの内容を活用して正確に回答してください。`;
            const tabLabelMap = { video: '動画カリキュラム', drive: '資料ドライブ', qa: 'Q&A', rebuttal: '切り返し集', site: 'サイトページ' };
            const contextText = relevantResults.map((r, i) => `${i+1}. [${tabLabelMap[r.tab]}] ${r.displayText}`).join('\n');
            if (topScore >= THRESHOLDS.CONFIDENCE) {
                prompt = `あなたは営業パートナー支援AIです。以下の[参考情報]を元に質問に回答してください。複数の参考情報がある場合は、関連するものすべてに言及してください。\n\n[参考情報]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else if (topScore >= THRESHOLDS.SUGGESTION) {
                prompt = `あなたは営業パートナー支援AIです。完全一致しませんでしたが、近い資料が見つかりました。「もしかしてこちらですか？」と提案してください。\n\n[近い資料]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            } else {
                prompt = `あなたは営業パートナー支援AIです。関連資料は見当たりませんでしたが、ルールに従って回答してください。業務的な質問で答えられない場合は謝罪してください。\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`;
            }
            const response = await fetch(CONFIG.geminiProxyUrl, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            loadingDiv.remove();
            if (data.error) {
                addMessage(`システムエラー: ${data.error.message}`, 'system');
            } else {
                let answer = data.candidates?.[0]?.content?.parts?.[0]?.text || 'すみません、回答を生成できませんでした。';
                let refLinksHtml = '';
                if (relevantResults.length > 0 && topScore >= THRESHOLDS.SUGGESTION) {
                    const badgeClassMap = { video: 'badge-video', drive: 'badge-drive', qa: 'badge-qa', rebuttal: 'badge-rebuttal', site: 'badge-site' };
                    const iconMap = {
                        video: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
                        drive: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
                        qa: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                        rebuttal: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
                        site: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>'
                    };
                    refLinksHtml = '<div class="chat-ref-links">';
                    relevantResults.forEach(r => {
                        const label = r.refLabel.length > 30 ? r.refLabel.substring(0, 30) + '…' : r.refLabel;
                        const badge = `<span class="ref-badge ${badgeClassMap[r.tab]}">${tabLabelMap[r.tab]}</span>`;
                        const icon = iconMap[r.tab];
                        if (r.tab === 'site') {
                            refLinksHtml += `<a class="chat-ref-btn" href="${r.item.url}" target="_blank" rel="noopener noreferrer">${icon}${badge}<span>${label}</span></a>`;
                        } else if (r.tab === 'drive' && r.item.url && r.item.url !== '#') {
                            refLinksHtml += `<a class="chat-ref-btn" href="${r.item.url}" target="_blank" rel="noopener noreferrer">${icon}${badge}<span>${label}</span></a>`;
                        } else {
                            refLinksHtml += `<a class="chat-ref-btn" onclick="navigateToItem('${r.tab}', ${r.index})">${icon}${badge}<span>${label}</span></a>`;
                        }
                    });
                    refLinksHtml += '</div>';
                }
                const disclaimer = '<div style="display:block; margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:11px; color:#888; line-height:1.4;">※回答は必ずしも正しいとは限りません。重要な情報は事務局まで確認するようにしてください。</div>';
                addMessage(answer, 'bot', refLinksHtml + disclaimer);
            }
        } catch (err) {
            loadingDiv.remove();
            console.error(err);
            addMessage("通信エラーが発生しました。", 'system');
        }
    }

    function init() {
        loadUserPreferences();
        els.input.addEventListener('input', (e) => { state.searchText = e.target.value; renderView(); });
        window.addEventListener('resize', updateLayoutMetrics);
        loadCachedData();
        fetchAllData();
        fetchSiteContent();
        setInterval(fetchAllData, CONFIG.refreshInterval);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>


================================================================
FILE: public/manual/resources/index.html
================================================================
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料ドライブ｜パートナー様向けマニュアル｜営業革命｜BakuApo</title>
    <meta name="description" content="パートナー（正規代理店）様向けの資料ドライブです。営業資料やテキスト資料をまとめて閲覧できます。">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="資料ドライブ｜パートナー様向けマニュアル｜営業革命｜BakuApo">
    <meta property="og:description" content="パートナー（正規代理店）様向けの資料ドライブです。営業資料やテキスト資料をまとめて閲覧できます。">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/ogp-manual.png">
    <meta property="og:site_name" content="営業革命｜BakuApo">
    <link rel="icon" href="/bakuapo-logo.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #F7F7F5; --card-bg: #FFFFFF; --text-main: #1A1A1A; --text-sub: #787774;
            --border-color: #E9E9E7; --border-subtle: #F3F4F6; --accent-color: #2383E2;
            --star-color-on: #F2C94C; --check-color-on: #27AE60; --link-color: #2563EB;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
            --sidebar-width: 220px; --max-width: 1200px;
            --chat-primary: #2383E2; --chat-bg: #fff; --chat-bubble-bot: #F7F7F5;
            --chat-bubble-user: #2383E2; --chat-text-bot: #1A1A1A; --chat-text-user: #FFFFFF;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); line-height: 1.6; -webkit-font-smoothing: antialiased; }
        .container { max-width: var(--max-width); margin: 0 auto; padding: 0 24px; }
        header {
            position: sticky; top: 0; z-index: 100; padding: 16px 0 12px;
            background: rgba(250, 250, 250, 0.88); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-color);
        }
        .header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .logo-group { display: flex; align-items: center; gap: 10px; }
        .logo-group img { height: 26px; }
        .logo-divider { width: 1px; height: 20px; background-color: var(--border-color); }
        .header-title { font-size: 12px; font-weight: 600; color: var(--text-sub); letter-spacing: 0.02em; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; overflow-x: auto; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn {
            flex: 1; padding: 12px; cursor: pointer;
            font-size: 14px; font-weight: 600; color: var(--text-sub);
            border-bottom: 3px solid transparent; transition: all 0.2s;
            font-family: inherit; background: none;
            border-top: none; border-left: none; border-right: none;
            text-decoration: none; display: inline-block; text-align: center;
            white-space: nowrap;
        }
        .tab-btn:hover { background-color: rgba(0,0,0,0.03); color: var(--text-main); }
        .tab-btn.active { color: var(--text-main); border-bottom-color: var(--text-main); }
        .controls-wrapper { display: flex; flex-direction: column; gap: 8px; }
        .search-container { position: relative; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; fill: var(--text-sub); pointer-events: none; }
        .search-input {
            width: 100%; padding: 10px 14px 10px 38px; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 14px; outline: none;
            transition: all 0.2s; font-family: inherit; background-color: var(--card-bg);
        }
        .search-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .status-bar { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-sub); padding-left: 2px; }
        .loading-indicator { display: none; align-items: center; gap: 6px; font-size: 12px; color: var(--text-sub); }
        .loading-indicator.active { display: inline-flex; }
        .spinner { width: 14px; height: 14px; border: 2px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .chat-ref-links { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
        .chat-ref-btn {
            display: flex; align-items: center; gap: 6px; padding: 6px 10px;
            background: var(--border-subtle); border-radius: var(--radius-sm); text-decoration: none; color: var(--text-main);
            font-size: 12px; cursor: pointer; transition: background 0.15s; border: 1px solid var(--border-color);
        }
        .chat-ref-btn:hover { background: #E5E7EB; }
        .ref-icon { width: 14px; height: 14px; flex-shrink: 0; }
        .ref-badge { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 600; flex-shrink: 0; }
        .badge-video { background: #DBEAFE; color: #1D4ED8; }
        .badge-drive { background: #D1FAE5; color: #065F46; }
        .badge-qa { background: #FEF3C7; color: #92400E; }
        .badge-rebuttal { background: #FCE7F3; color: #9D174D; }
        .initial-loading { display: flex; flex-direction: column; align-items: center; padding: 48px 0; gap: 16px; }
        .loading-spinner { width: 32px; height: 32px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.7s linear infinite; }
        .loading-text { font-size: 13px; color: var(--text-sub); }
        .skeleton-list { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 12px; margin-top: 8px; }
        .skeleton-card { background: var(--card-bg); border-radius: var(--radius-md); padding: 20px; border: 1px solid var(--border-color); }
        .skeleton-line { height: 12px; border-radius: 6px; background: linear-gradient(90deg, var(--border-subtle) 25%, #e5e7eb 50%, var(--border-subtle) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        .skeleton-line.title { width: 40%; height: 14px; margin-bottom: 12px; }
        .skeleton-line.long { width: 90%; margin-bottom: 8px; }
        .skeleton-line.medium { width: 70%; margin-bottom: 8px; }
        .skeleton-line.short { width: 50%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .main-layout { display: flex; gap: 24px; padding-top: 20px; padding-bottom: 80px; }
        .sidebar {
            position: sticky; width: var(--sidebar-width); flex-shrink: 0;
            max-height: calc(100vh - 200px); overflow-y: auto;
            display: flex; flex-direction: column; gap: 4px;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .filter-section {
            display: flex; flex-direction: column; gap: 4px;
            margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
        }
        .filter-btn {
            display: flex; align-items: center; gap: 8px; padding: 8px 12px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;
            color: var(--text-main); transition: all 0.2s; user-select: none; width: 100%;
        }
        .filter-btn:hover { background: #F0F0EF; }
        .filter-icon { width: 14px; height: 14px; fill: currentColor; flex-shrink: 0; }
        i.filter-icon { width: auto; height: auto; font-size: 14px; color: currentColor; fill: none; }
        .filter-btn.active-star { background: #FFF9E6; border-color: var(--star-color-on); color: #946F00; }
        .filter-btn.active-star .filter-icon { fill: var(--star-color-on); }
        .filter-btn.active-unwatched { background: #E8F5E9; border-color: var(--check-color-on); color: #1E8449; }
        .sidebar-title { font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; padding-left: 4px; }
        .category-nav-list { list-style: none; display: flex; flex-direction: column; gap: 1px; }
        .category-nav-item {
            font-size: 13px; padding: 7px 10px; border-radius: var(--radius-sm);
            cursor: pointer; color: var(--text-sub); transition: all 0.15s; font-weight: 500;
        }
        .category-nav-item:hover { background-color: var(--border-subtle); color: var(--text-main); }
        .content-area { flex: 1; min-width: 0; }
        .drive-category-group { margin-bottom: 24px; }
        .drive-category-title {
            font-size: 22px; font-weight: 700; margin-bottom: 24px; padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color); color: var(--text-main);
        }
        .drive-medium-block { margin-left: 8px; margin-bottom: 24px; padding-left: 20px; border-left: 3px solid var(--border-color); }
        .drive-medium-header { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; padding: 4px 0; }
        .folder-icon { width: 18px; height: 18px; fill: none; stroke: var(--text-sub); stroke-width: 1.5; }
        .drive-small-group { margin-left: 8px; margin-bottom: 12px; }
        .drive-small-header { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .small-icon { width: 10px; height: 10px; }
        .drive-file-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .drive-file-item {
            display: flex; align-items: flex-start; justify-content: space-between;
            gap: 16px; padding: 14px 16px;
            border-radius: 8px; text-decoration: none; color: var(--text-main);
            transition: all 0.2s; border: 1px solid var(--border-color);
            background: var(--card-bg);
        }
        .drive-file-item:hover { background-color: #FAFAFA; border-color: var(--accent-color); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .drive-file-item:hover .file-name { color: var(--accent-color); }
        .file-content-wrapper { display: flex; align-items: center; gap: 16px; flex: 1; min-width: 0; }
        .file-thumbnail {
            width: 120px; height: 80px; border-radius: 6px; overflow: hidden;
            background-color: #f9f9f9; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-color);
        }
        .file-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .icon-svg { width: 32px; height: 32px; }
        .icon-svg.type-sheet { stroke: #0F9D58; }
        .icon-svg.type-doc { stroke: #4285F4; }
        .icon-svg.type-slide { stroke: #F4B400; }
        .icon-svg.type-pdf { stroke: #DB4437; }
        .icon-svg.type-web { stroke: var(--text-sub); }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-desc { font-size: 12px; color: var(--text-sub); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .action-buttons { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: none; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.15s; color: var(--text-sub);
        }
        .icon-btn:hover { background-color: var(--border-subtle); }
        .icon-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
        .star-btn.active { color: var(--star-color-on); }
        .star-btn.active svg { fill: var(--star-color-on); stroke: var(--star-color-on); }
        .check-btn.active { color: var(--check-color-on); }
        .check-btn.active svg { fill: var(--check-color-on); stroke: var(--check-color-on); }
        .message-state { text-align: center; padding: 48px; color: var(--text-sub); font-size: 14px; }
        .error-container { display: none; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .error-message { color: #DC2626; background: #FEF2F2; padding: 12px 16px; border-radius: var(--radius-md); font-size: 13px; border: 1px solid #FECACA; }
        .chat-widget {
            position: fixed; bottom: 24px; right: 24px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end; font-family: inherit;
        }
        .chat-toggle-btn {
            height: 56px; padding: 0 24px 0 20px; border-radius: 30px;
            background-color: var(--chat-primary); color: white; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.2s; font-weight: 700; font-size: 15px; font-family: inherit;
        }
        .chat-toggle-btn:hover { transform: scale(1.05); }
        .chat-toggle-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .chat-btn-text { display: block; }
        .chat-window {
            position: absolute; bottom: 72px; right: 0; width: 350px; height: 500px;
            background-color: var(--chat-bg); border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: none; flex-direction: column; overflow: hidden; transform-origin: bottom right;
        }
        .chat-window.active { display: flex; }
        .chat-header {
            padding: 14px 16px; background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .chat-title { font-weight: 600; font-size: 14px; color: var(--text-main); }
        .chat-close {
            background: none; border: none; cursor: pointer; color: var(--text-sub);
            width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; font-size: 16px;
        }
        .chat-close:hover { background: var(--border-subtle); }
        .chat-messages {
            flex: 1; padding: 16px; overflow-y: auto; background-color: var(--card-bg);
            display: flex; flex-direction: column; gap: 10px;
        }
        .chat-msg {
            max-width: 85%; padding: 10px 14px; border-radius: var(--radius-md); font-size: 13px; line-height: 1.6; word-wrap: break-word;
        }
        .chat-msg.bot { align-self: flex-start; background-color: var(--chat-bubble-bot); color: var(--chat-text-bot); border-bottom-left-radius: 2px; }
        .chat-msg.user { align-self: flex-end; background-color: var(--chat-bubble-user); color: var(--chat-text-user); border-bottom-right-radius: 2px; }
        .chat-msg.system { align-self: center; background-color: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; font-size: 12px; text-align: left; max-width: 90%; }
        .chat-msg b, .chat-msg strong { font-weight: 700; }
        .chat-msg a { color: var(--link-color); text-decoration: underline; text-underline-offset: 2px; word-break: break-all; }
        .chat-msg a:hover { text-decoration: none; }
        .chat-input-area {
            padding: 12px; border-top: 1px solid var(--border-color);
            display: flex; gap: 8px; background-color: var(--card-bg);
        }
        .chat-input {
            flex: 1; padding: 9px 14px; border: 1px solid var(--border-color); border-radius: 20px;
            font-size: 13px; outline: none; transition: all 0.2s; font-family: inherit;
        }
        .chat-input:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0,0,0,0.04); }
        .chat-input:disabled { background-color: var(--border-subtle); cursor: not-allowed; }
        .chat-send-btn { background: none; border: none; cursor: pointer; color: var(--accent-color); padding: 4px; }
        .chat-send-btn:disabled { color: var(--text-sub); cursor: not-allowed; }
        .typing-dots { display: flex; gap: 4px; padding: 4px 8px; }
        .typing-dot { width: 5px; height: 5px; background-color: #9CA3AF; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            header { padding: 12px 0; }
            .header-top { margin-bottom: 12px; }
            .logo-group img { height: 22px; }
            .header-title { font-size: 11px; }
            .tabs { margin-bottom: 12px; }
            .tab-btn { font-size: 12px; padding: 10px 6px; }
            .status-bar { display: none; }
            .main-layout { flex-direction: column; gap: 12px; padding-top: 4px; }
            .sidebar {
                position: sticky; z-index: 90; width: calc(100% + 32px); margin-left: -16px;
                padding: 8px 16px; border-bottom: 1px solid var(--border-color);
                max-height: none; overflow-x: auto; display: flex; align-items: center; gap: 6px;
                background: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            }
            .sidebar::-webkit-scrollbar { display: none; }
            .filter-section {
                flex-direction: row; margin: 0; padding: 0; border: none;
                padding-right: 6px; margin-right: 4px; border-right: 1px solid var(--border-color);
            }
            .filter-btn { padding: 5px 8px; width: auto; font-size: 11px; white-space: nowrap; }
            .sidebar-title { display: none; }
            .category-nav-list { display: flex; gap: 6px; }
            .category-nav-item { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 5px 12px; font-size: 11px; }
            .drive-category-group { scroll-margin-top: 240px; }
            .drive-medium-block { margin-left: 0; padding-left: 12px; }
            .drive-file-list { margin-left: 0; }
            .file-thumbnail { width: 80px; height: 56px; }
            .file-name { font-size: 13px; }
            .icon-svg { width: 24px; height: 24px; }
            .chat-toggle-btn { width: 56px; height: 56px; border-radius: 50%; padding: 0; }
            .chat-btn-text { display: none; }
            .chat-window { width: calc(100vw - 32px); right: -8px; bottom: 80px; height: 60vh; }
        }
    </style>
</head>
<body>

<div class="container">
    <header id="mainHeader">
        <div class="header-top">
            <div class="logo-group">
                <img src="/eigyou-kakumei_logo.svg" alt="営業革命" onerror="this.style.display='none'">
                <div class="logo-divider"></div>
                <img src="/bakuapo-logo.svg" alt="BakuApo" onerror="this.style.display='none'">
            </div>
            <span class="header-title">パートナー様向けマニュアル</span>
        </div>
        <div class="tabs">
            <a class="tab-btn" href="/manual/videos/">動画カリキュラム</a>
            <a class="tab-btn active" href="/manual/resources/">資料ドライブ</a>
            <a class="tab-btn" href="/manual/faq/">Q&A</a>
        </div>
        <div class="controls-wrapper">
            <div class="search-container">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
            </div>
            <div id="errorContainer" class="error-container"></div>
            <div class="status-bar">
                <span id="countDisplay">0件</span>
                <div class="loading-indicator" id="loadingIndicator"><div class="spinner"></div><span>更新中...</span></div>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar" id="stickySidebar">
            <div class="filter-section">
                <div class="filter-btn" id="starFilterBtn" onclick="toggleStarFilter()">
                    <svg class="filter-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    <span>スター付きのみ</span>
                </div>
                <div class="filter-btn" id="unwatchedFilterBtn" onclick="toggleUnwatchedFilter()">
                    <i class="fa-regular fa-eye filter-icon"></i>
                    <span>未確認のみ表示</span>
                </div>
            </div>
            <div class="sidebar-title">カテゴリー目次</div>
            <ul class="category-nav-list" id="categoryNav"></ul>
        </aside>

        <main class="content-area" id="contentArea">
            <div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>
        </main>
    </div>

    <div class="chat-widget">
        <button class="chat-toggle-btn" onclick="toggleChat()" title="AIアシスタントに質問">
            <svg viewBox="0 0 24 24"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zm-2 10H6v-4h12v4zm0-6H6V7h12v6z"/><circle cx="8.5" cy="10.5" r="1.5"/><circle cx="15.5" cy="10.5" r="1.5"/></svg>
            <span class="chat-btn-text">AIに質問する</span>
        </button>
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">AIパートナーアシスタント</span>
                <button class="chat-close" onclick="toggleChat()">✕</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-msg bot">こんにちは！<br>動画カリキュラム、資料、Q&A、切り返しトークについて、ご質問があればお答えします。</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力..." onkeypress="handleChatKey(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()" id="chatSendBtn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const CURRENT_TAB = 'drive';
    const TAB_URLS = { video: '/manual/videos/', drive: '/manual/resources/', qa: '/manual/faq/' };

    const CONFIG = {
        geminiProxyUrl: "/api/gemini-proxy",
        videoSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=396280088&single=true&output=csv",
        driveSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=380310918&single=true&output=csv",
        qaSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1192474135&single=true&output=csv",
        rebuttalSheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBVuXb-cTydLU-CMFwHyYnsJfg9e2AsTEa4TU1G9nYQlShkZHv3wGM2a1X5ww81o5v8HZNS9IXUI1b/pub?gid=1328585848&single=true&output=csv",
        refreshInterval: 60000
    };

    const THRESHOLDS = { CONFIDENCE: 0.6, SUGGESTION: 0.25 };

    const state = {
        currentTab: CURRENT_TAB,
        searchText: '', showStarredOnly: false, showUnwatchedOnly: false,
        starredItems: new Set(), watchedItems: new Set(),
        data: { video: [], drive: [], qa: [], rebuttal: [] },
        isLoaded: { video: false, drive: false, qa: false, rebuttal: false },
        hasError: false, chatHistory: [], messageTimestamps: [], lockedUntil: 0
    };

    const els = {
        input: document.getElementById('searchInput'),
        count: document.getElementById('countDisplay'),
        loading: document.getElementById('loadingIndicator'),
        errorContainer: document.getElementById('errorContainer'),
        categoryNav: document.getElementById('categoryNav'),
        header: document.getElementById('mainHeader'),
        sidebar: document.getElementById('stickySidebar'),
        starFilterBtn: document.getElementById('starFilterBtn'),
        unwatchedFilterBtn: document.getElementById('unwatchedFilterBtn'),
        contentArea: document.getElementById('contentArea'),
        chatWindow: document.getElementById('chatWindow'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        chatSendBtn: document.getElementById('chatSendBtn')
    };

    function updateLayoutMetrics() {
        const headerHeight = els.header.offsetHeight;
        const isMobile = window.innerWidth <= 768;
        const topOffset = isMobile ? headerHeight : headerHeight + 20;
        els.sidebar.style.top = `${topOffset}px`;
        const totalStickyHeight = isMobile ? topOffset + els.sidebar.offsetHeight + 20 : topOffset;
        document.querySelectorAll('.drive-category-group').forEach(el => { el.style.scrollMarginTop = `${totalStickyHeight}px`; });
    }

    function loadUserPreferences() {
        try {
            const stars = localStorage.getItem('partner_manual_stars_v2');
            if (stars) state.starredItems = new Set(JSON.parse(stars));
            const watched = localStorage.getItem('partner_manual_watched_v2');
            if (watched) state.watchedItems = new Set(JSON.parse(watched));
        } catch (e) {}
    }
    function saveUserPreferences() {
        localStorage.setItem('partner_manual_stars_v2', JSON.stringify([...state.starredItems]));
        localStorage.setItem('partner_manual_watched_v2', JSON.stringify([...state.watchedItems]));
    }
    function toggleStar(key) { if (state.starredItems.has(key)) state.starredItems.delete(key); else state.starredItems.add(key); saveUserPreferences(); renderView(); }
    function toggleWatched(key) { if (state.watchedItems.has(key)) state.watchedItems.delete(key); else state.watchedItems.add(key); saveUserPreferences(); renderView(); }
    function toggleStarFilter() { state.showStarredOnly = !state.showStarredOnly; els.starFilterBtn.classList.toggle('active-star', state.showStarredOnly); renderView(); }
    function toggleUnwatchedFilter() { state.showUnwatchedOnly = !state.showUnwatchedOnly; els.unwatchedFilterBtn.classList.toggle('active-unwatched', state.showUnwatchedOnly); renderView(); }

    function parseCSV(text) {
        const arr = []; let quote = false; let row = []; let col = ''; let c = 0;
        for (; c < text.length; c++) {
            let cc = text[c], nc = text[c+1];
            if (quote) { if (cc === '"') { if (nc === '"') { col += '"'; c++; } else { quote = false; } } else { col += cc; } }
            else { if (cc === '"') { quote = true; } else if (cc === ',') { row.push(col); col = ''; } else if (cc === '\r' && nc === '\n') { row.push(col); col = ''; arr.push(row); row = []; c++; } else if (cc === '\n' || cc === '\r') { row.push(col); col = ''; arr.push(row); row = []; } else { col += cc; } }
        }
        if (col.length > 0 || row.length > 0) { row.push(col); arr.push(row); }
        return arr;
    }

    function extractYoutubeId(url) {
        if (!url) return null;
        const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function getFileType(url) {
        if (!url) return 'web';
        const lower = url.toLowerCase();
        if (extractYoutubeId(url)) return 'youtube';
        if (lower.includes('spreadsheets')) return 'sheet';
        if (lower.includes('document')) return 'doc';
        if (lower.includes('presentation')) return 'slide';
        if (lower.endsWith('.pdf') || lower.includes('drive.google.com')) return 'pdf';
        return 'web';
    }

    function getFileIconSvg(type) {
        let className = 'icon-svg'; let svgPath = '';
        switch(type) {
            case 'sheet': className += ' type-sheet'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>'; break;
            case 'doc': className += ' type-doc'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>'; break;
            case 'slide': className += ' type-slide'; svgPath = '<rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>'; break;
            case 'pdf': className += ' type-pdf'; svgPath = '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13v-1h3v1"/><path d="M12 18v-6"/><path d="M9 17h3"/>'; break;
            default: className += ' type-web'; svgPath = '<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>'; break;
        }
        return `<svg class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">${svgPath}</svg>`;
    }

    function extractGoogleFileId(url) {
        if (!url) return null;
        const patterns = [
            /\/d\/([a-zA-Z0-9_-]{10,})/,
            /[?&]id=([a-zA-Z0-9_-]{10,})/
        ];
        for (const p of patterns) {
            const m = url.match(p);
            if (m) return m[1];
        }
        return null;
    }

    function getFileThumbnailUrl(url, fileId) {
        if (!fileId) return null;
        if (url.includes('/presentation/')) {
            return `https://docs.google.com/presentation/d/${fileId}/export/png?pageid=p`;
        }
        if (url.includes('/spreadsheets/')) {
            return `https://docs.google.com/spreadsheets/d/${fileId}/export?format=png&gid=0&size=400`;
        }
        return `https://lh3.googleusercontent.com/d/${fileId}=w400`;
    }

    function createActionButtons(id, tab) {
        const div = document.createElement('div'); div.className = 'action-buttons';
        const isStarred = state.starredItems.has(id); const isWatched = state.watchedItems.has(id);
        const starTitle = isStarred ? 'スター付きを外す' : 'スター付きにする';
        const checkTitle = isWatched ? '確認済みを外す' : '確認済みにする';
        div.innerHTML = `
            <button class="icon-btn star-btn ${isStarred?'active':''}" onclick="toggleStar('${id}')" title="${starTitle}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></button>
            <button class="icon-btn check-btn ${isWatched?'active':''}" onclick="toggleWatched('${id}')" title="${checkTitle}"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></button>
        `;
        return div;
    }

    function renderNav(categories, idMap) {
        const frag = document.createDocumentFragment();
        categories.forEach(cat => {
            const li = document.createElement('li'); li.className = 'category-nav-item'; li.textContent = cat;
            li.onclick = () => { const el = document.getElementById(idMap[cat]); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); };
            frag.appendChild(li);
        });
        els.categoryNav.appendChild(frag);
    }

    function createFileList(files) {
        const ul = document.createElement('ul'); ul.className = 'drive-file-list';
        files.forEach(file => {
            const li = document.createElement('a'); li.href = file.url; li.target = "_blank"; li.rel = "noopener noreferrer"; li.className = 'drive-file-item';
            const wrapper = document.createElement('div'); wrapper.className = 'file-content-wrapper';
            const type = getFileType(file.url);
            const thumbDiv = document.createElement('div'); thumbDiv.className = 'file-thumbnail';
            const fileId = extractGoogleFileId(file.url);
            const thumbnailUrl = getFileThumbnailUrl(file.url, fileId);
            if (type === 'youtube') {
                const ytId = extractYoutubeId(file.url);
                const img = document.createElement('img'); img.src = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
                img.onerror = () => { thumbDiv.innerHTML = getFileIconSvg('web'); }; thumbDiv.appendChild(img);
            } else if (thumbnailUrl) {
                const img = document.createElement('img'); img.src = thumbnailUrl; img.alt = file.displayName;
                img.referrerPolicy = 'no-referrer';
                img.onerror = () => { thumbDiv.innerHTML = getFileIconSvg(type); };
                thumbDiv.appendChild(img);
            } else { thumbDiv.innerHTML = getFileIconSvg(type); }
            wrapper.appendChild(thumbDiv);
            const info = document.createElement('div'); info.className = 'file-info';
            info.innerHTML = `<div class="file-name">${file.displayName}</div>`;
            if(file.desc) info.innerHTML += `<div class="file-desc">${file.desc}</div>`;
            wrapper.appendChild(info); li.appendChild(wrapper);
            const actions = createActionButtons(file.id, 'drive');
            actions.onclick = (e) => { e.preventDefault(); e.stopPropagation(); };
            li.appendChild(actions); ul.appendChild(li);
        });
        return ul;
    }

    function renderDriveList(items, container) {
        const tree = {}; const largeCategories = new Set(); const catFirstId = {};
        items.forEach(item => {
            const large = item.large || 'その他'; let nameToDisplay = '';
            if (!tree[large]) tree[large] = { _files_: [], mediums: {} };
            largeCategories.add(large);
            if (item.detail && item.detail.trim() !== "") {
                const medium = item.medium || '未分類'; const small = item.small || '未分類'; nameToDisplay = item.detail;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                if (!tree[large].mediums[medium].smalls[small]) tree[large].mediums[medium].smalls[small] = [];
                tree[large].mediums[medium].smalls[small].push({ ...item, displayName: nameToDisplay });
            } else if (item.small && item.small.trim() !== "") {
                const medium = item.medium || '未分類'; nameToDisplay = item.small;
                if (!tree[large].mediums[medium]) tree[large].mediums[medium] = { _files_: [], smalls: {} };
                tree[large].mediums[medium]._files_.push({ ...item, displayName: nameToDisplay });
            } else if (item.medium && item.medium.trim() !== "") {
                nameToDisplay = item.medium; tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            } else {
                nameToDisplay = large; tree[large]._files_.push({ ...item, displayName: nameToDisplay });
            }
        });
        let idx = 0;
        largeCategories.forEach(large => {
            const groupDiv = document.createElement('div'); groupDiv.className = 'drive-category-group';
            const catId = `drive-cat-${idx++}`; groupDiv.id = catId; catFirstId[large] = catId;
            const title = document.createElement('h2'); title.className = 'drive-category-title'; title.textContent = large; groupDiv.appendChild(title);
            const largeData = tree[large];
            if (largeData._files_.length > 0) { const ul = createFileList(largeData._files_); ul.classList.add('direct-list'); groupDiv.appendChild(ul); }
            Object.keys(largeData.mediums).forEach(med => {
                const medData = largeData.mediums[med];
                const medBlock = document.createElement('div'); medBlock.className = 'drive-medium-block';
                medBlock.innerHTML = `<div class="drive-medium-header"><svg class="folder-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span>${med}</span></div>`;
                if (medData._files_.length > 0) { const ul = createFileList(medData._files_); ul.classList.add('direct-list'); medBlock.appendChild(ul); }
                Object.keys(medData.smalls).forEach(small => {
                    const files = medData.smalls[small];
                    if (files.length > 0) {
                        const smallGroup = document.createElement('div'); smallGroup.className = 'drive-small-group';
                        const smallHeader = document.createElement('div'); smallHeader.className = 'drive-small-header';
                        smallHeader.innerHTML = `<svg class="small-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>${small}`;
                        smallGroup.appendChild(smallHeader); smallGroup.appendChild(createFileList(files)); medBlock.appendChild(smallGroup);
                    }
                });
                groupDiv.appendChild(medBlock);
            });
            container.appendChild(groupDiv);
        });
        renderNav(largeCategories, catFirstId);
    }

    function renderView() {
        const container = els.contentArea; container.innerHTML = ''; els.categoryNav.innerHTML = '';
        const sourceData = state.data[CURRENT_TAB];
        const query = state.searchText.toLowerCase().trim();
        if (!state.isLoaded[CURRENT_TAB]) {
            container.innerHTML = `<div class="initial-loading"><div class="loading-spinner"></div><div class="loading-text">データを読み込んでいます...</div><div class="skeleton-list"><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line medium"></div></div><div class="skeleton-card"><div class="skeleton-line title"></div><div class="skeleton-line long"></div><div class="skeleton-line short"></div></div></div></div>`;
            return;
        }
        const filtered = sourceData.filter(item => {
            if (state.showStarredOnly && !state.starredItems.has(item.id)) return false;
            if (state.showUnwatchedOnly && state.watchedItems.has(item.id)) return false;
            if (!query) return true;
            return JSON.stringify(item).toLowerCase().includes(query);
        });
        els.count.textContent = `${filtered.length}件`;
        if (filtered.length === 0) { container.innerHTML = `<div class="message-state">該当なし</div>`; return; }
        renderDriveList(filtered, container);
        requestAnimationFrame(updateLayoutMetrics);
    }

    function loadCachedData() {
        try {
            const cached = sessionStorage.getItem('manual_cache_v1');
            if (cached) { const obj = JSON.parse(cached); state.data = obj.data; state.isLoaded = obj.isLoaded; renderView(); return true; }
        } catch (e) {}
        return false;
    }
    function saveCacheData() {
        try { sessionStorage.setItem('manual_cache_v1', JSON.stringify({ data: state.data, isLoaded: state.isLoaded })); } catch (e) {}
    }

    async function fetchAllData() {
        const isFirstLoad = !state.isLoaded[CURRENT_TAB];
        if (isFirstLoad) { els.loading.classList.add('active'); }
        els.errorContainer.style.display = 'none';
        try {
            const vRes = await fetch(`${CONFIG.videoSheetUrl}&t=${Date.now()}`);
            if (vRes.ok) { const vText = await vRes.text(); const vRows = parseCSV(vText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.video = vRows.map(r => ({ sourceType: 'manual', id: r[2] || r[3], category: r[1] || '未分類', youtubeUrl: r[2], title: r[3], desc: r[4], materialUrl: r[5] })); state.isLoaded.video = true; }
            const dRes = await fetch(`${CONFIG.driveSheetUrl}&t=${Date.now()}`);
            if (dRes.ok) { const dText = await dRes.text(); const dRows = parseCSV(dText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.drive = dRows.map(r => ({ sourceType: 'material', id: r[5] || '#', large: r[1] || 'その他', medium: r[2] || '', small: r[3] || '', detail: r[4] || '', url: r[5] || '#', desc: r[6] || '' })); state.isLoaded.drive = true; }
            const qRes = await fetch(`${CONFIG.qaSheetUrl}&t=${Date.now()}`);
            if (qRes.ok) { const qText = await qRes.text(); const qRows = parseCSV(qText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.qa = qRows.map((r, i) => ({ sourceType: 'qa', id: `qa-${r[2] || i}`, category: r[1] || '未分類', question: r[2] || '', answer: r[3] || '' })); state.isLoaded.qa = true; }
            const rRes = await fetch(`${CONFIG.rebuttalSheetUrl}&t=${Date.now()}`);
            if (rRes.ok) { const rText = await rRes.text(); const rRows = parseCSV(rText).slice(1).filter(r => (r[0]||'').toUpperCase() === 'ON'); state.data.rebuttal = rRows.map((r, i) => ({ sourceType: 'qa', id: `rebuttal-${r[2] || i}`, category: r[1] || '未分類', question: r[2] || '', answer: r[3] || '' })); state.isLoaded.rebuttal = true; }
        } catch (e) { console.error(e); state.hasError = true; els.errorContainer.style.display = 'flex'; els.errorContainer.innerHTML = `<div class="error-message">データの更新に失敗しました。</div>`; }
        saveCacheData();
        renderView(); els.loading.classList.remove('active');
    }

    /* --- Chatbot --- */
    function toggleChat() { els.chatWindow.classList.toggle('active'); if (els.chatWindow.classList.contains('active')) { els.chatInput.focus(); scrollToBottom(); } }
    function handleChatKey(e) { if (e.key === 'Enter') sendChatMessage(); }
    function scrollToBottom() { els.chatMessages.scrollTop = els.chatMessages.scrollHeight; }

    function navigateToItem(tab, index) {
        els.chatWindow.classList.remove('active');
        if (tab === CURRENT_TAB) {
            requestAnimationFrame(() => { requestAnimationFrame(() => {
                const allFileItems = document.querySelectorAll('#contentArea .drive-file-item');
                let targetEl = allFileItems[index] || null;
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetEl.style.transition = 'box-shadow 0.3s, outline 0.3s';
                    targetEl.style.outline = '2px solid var(--accent-color)';
                    targetEl.style.boxShadow = '0 0 0 4px rgba(35,131,226,0.15)';
                    setTimeout(() => { targetEl.style.outline = 'none'; targetEl.style.boxShadow = ''; }, 2500);
                }
            }); });
        } else { window.location.href = TAB_URLS[tab]; }
    }

    function formatChatMessage(text) {
        if (!text) return "";
        let f = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        f = f.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        f = f.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">リンク</a>');
        f = f.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold">$1</b>'); f = f.replace(/\n/g, '<br>'); return f;
    }
    function addMessage(text, type, appendHtml = "") { const div = document.createElement('div'); div.className = `chat-msg ${type}`; div.innerHTML = formatChatMessage(text) + appendHtml; els.chatMessages.appendChild(div); scrollToBottom(); }
    function addTypingIndicator() { const div = document.createElement('div'); div.className = 'chat-msg bot typing-indicator'; div.innerHTML = `<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`; els.chatMessages.appendChild(div); scrollToBottom(); return div; }
    function setInputLock(locked) { els.chatInput.disabled = locked; els.chatSendBtn.disabled = locked; els.chatInput.placeholder = locked ? "送信制限中です (3分間)" : "質問を入力..."; }

    function calculateSimilarity(str1, str2) {
        if (!str1 || !str2) return 0.0; const s1 = str1.toLowerCase().replace(/\s+/g, ""); const s2 = str2.toLowerCase().replace(/\s+/g, "");
        if (s1 === s2) return 1.0; if (s1.length < 2 || s2.length < 2) return 0.0;
        const getBigrams = (str) => { const b = []; for (let i = 0; i < str.length - 1; i++) b.push(str.substring(i, i + 2)); return b; };
        const bg1 = getBigrams(s1); const bg2 = getBigrams(s2); let intersection = 0; const bg2Copy = [...bg2];
        for (const pair of bg1) { const idx = bg2Copy.indexOf(pair); if (idx !== -1) { intersection++; bg2Copy.splice(idx, 1); } }
        return (2.0 * intersection) / (bg1.length + bg2.length);
    }

    function findRelevantContents(query, maxResults = 5) {
        const taggedItems = [
            ...state.data.video.map((item, i) => ({ ...item, _tab: 'video', _index: i })),
            ...state.data.drive.map((item, i) => ({ ...item, _tab: 'drive', _index: i })),
            ...state.data.qa.map((item, i) => ({ ...item, _tab: 'qa', _index: i })),
            ...state.data.rebuttal.map((item, i) => ({ ...item, _tab: 'rebuttal', _index: i }))
        ];
        const scored = taggedItems.map(item => {
            let targetText = '', displayText = '', refLabel = '';
            if (item.sourceType === 'manual') { targetText = `${item.category} ${item.title} ${item.desc || ''}`; displayText = `[動画: ${item.title}] 内容: ${item.desc}`; refLabel = item.title; }
            else if (item.sourceType === 'material') { targetText = `${item.large} ${item.medium} ${item.small} ${item.detail} ${item.desc}`; const name = item.detail || item.small || item.medium || item.large; displayText = `[資料: ${name}] 内容: ${item.desc}`; refLabel = name; }
            else { targetText = `${item.category} ${item.question} ${item.answer}`; const tabLabel = item._tab === 'rebuttal' ? '切り返し' : 'Q&A'; displayText = `[${tabLabel}] Q: ${item.question}\nA: ${item.answer}`; refLabel = item.question; }
            const queryWords = query.toLowerCase().replace(/[\s　]+/g, ' ').split(' ').filter(w => w.length > 1);
            let keywordScore = 0; queryWords.forEach(w => { if (targetText.toLowerCase().includes(w)) keywordScore += 0.15; });
            const bigramScore = calculateSimilarity(query, targetText);
            return { item, score: Math.min(bigramScore + keywordScore, 1.0), displayText, refLabel, tab: item._tab, index: item._index };
        });
        return scored.filter(s => s.score >= THRESHOLDS.SUGGESTION).sort((a, b) => b.score - a.score).slice(0, maxResults);
    }

    async function sendChatMessage() {
        const now = Date.now(); if (state.lockedUntil > now) return;
        const text = els.chatInput.value.trim(); if (!text) return;
        const LIMIT_COUNT = 8; const LIMIT_WINDOW = 3 * 60 * 1000;
        state.messageTimestamps = state.messageTimestamps.filter(t => t > now - LIMIT_WINDOW);
        if (state.messageTimestamps.length >= LIMIT_COUNT) { state.lockedUntil = now + LIMIT_WINDOW; addMessage('連続で質問をしすぎているようです。しばらく経ってから再度お試しください。<br>または、<a href="https://lin.ee/0rNANZ7" target="_blank" rel="noopener noreferrer">事務局へ連絡</a>', 'system'); els.chatInput.value = ''; setInputLock(true); setTimeout(() => { if (Date.now() >= state.lockedUntil) { setInputLock(false); state.lockedUntil = 0; } }, LIMIT_WINDOW); return; }
        state.messageTimestamps.push(now); addMessage(text, 'user'); els.chatInput.value = '';
        const loadingDiv = addTypingIndicator();
        try {
            const relevantResults = findRelevantContents(text, 5);
            const topScore = relevantResults.length > 0 ? relevantResults[0].score : 0;
            const tabLabelMap = { video: '動画カリキュラム', drive: '資料ドライブ', qa: 'Q&A', rebuttal: '切り返し集' };
            const commonInstruction = `\n[AIの振る舞い・回答ルール]\n1. 機能に関する質問: 「パートナーQA、商談切り返し、動画・資料マニュアルの案内が可能です」と回答。\n2. 挨拶: 端的に返す。\n3. 不適切: 拒否する。\n4. フォーマット: **太字**使用。外部URLリンクは[こちら](URL)形式。\n5. 関連する参考情報がある場合は、回答内で「こちらの動画」「こちらのQ&A」「こちらの資料」「こちらの切り返し集」などの言葉で言及してください。具体的なリンクボタンは回答の後にシステムが自動で付与するため、回答文内にREF_LINKタグは書かないでください。`;
            const contextText = relevantResults.map((r, i) => `${i+1}. [${tabLabelMap[r.tab]}] ${r.displayText}`).join('\n');
            let prompt = '';
            if (topScore >= THRESHOLDS.CONFIDENCE) { prompt = `あなたは営業パートナー支援AIです。以下の[参考情報]を元に質問に回答してください。複数の参考情報がある場合は、関連するものすべてに言及してください。\n\n[参考情報]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            else if (topScore >= THRESHOLDS.SUGGESTION) { prompt = `あなたは営業パートナー支援AIです。完全一致しませんでしたが、近い資料が見つかりました。「もしかしてこちらですか？」と提案してください。\n\n[近い資料]\n${contextText}\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            else { prompt = `あなたは営業パートナー支援AIです。関連資料は見当たりませんでしたが、ルールに従って回答してください。業務的な質問で答えられない場合は謝罪してください。\n\n[ユーザーの質問]\n${text}\n${commonInstruction}`; }
            const response = await fetch(CONFIG.geminiProxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            const data = await response.json(); loadingDiv.remove();
            if (data.error) { addMessage(`システムエラー: ${data.error.message}`, 'system'); }
            else {
                let answer = data.candidates?.[0]?.content?.parts?.[0]?.text || 'すみません、回答を生成できませんでした。';
                let refLinksHtml = '';
                if (relevantResults.length > 0 && topScore >= THRESHOLDS.SUGGESTION) {
                    const badgeClassMap = { video: 'badge-video', drive: 'badge-drive', qa: 'badge-qa', rebuttal: 'badge-rebuttal' };
                    const iconMap = { video: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>', drive: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>', qa: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', rebuttal: '<svg class="ref-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' };
                    refLinksHtml = '<div class="chat-ref-links">';
                    relevantResults.forEach(r => { const label = r.refLabel.length > 30 ? r.refLabel.substring(0, 30) + '…' : r.refLabel; const badge = `<span class="ref-badge ${badgeClassMap[r.tab]}">${tabLabelMap[r.tab]}</span>`; const icon = iconMap[r.tab]; if (r.tab === 'drive' && r.item.url && r.item.url !== '#') { refLinksHtml += `<a class="chat-ref-btn" href="${r.item.url}" target="_blank" rel="noopener noreferrer">${icon}${badge}<span>${label}</span></a>`; } else { refLinksHtml += `<a class="chat-ref-btn" onclick="navigateToItem('${r.tab}', ${r.index})">${icon}${badge}<span>${label}</span></a>`; } });
                    refLinksHtml += '</div>';
                }
                const disclaimer = '<div style="display:block; margin-top:10px; padding-top:8px; border-top:1px solid rgba(0,0,0,0.1); font-size:11px; color:#888; line-height:1.4;">※回答は必ずしも正しいとは限りません。重要な情報は事務局まで確認するようにしてください。</div>';
                addMessage(answer, 'bot', refLinksHtml + disclaimer);
            }
        } catch (err) { loadingDiv.remove(); console.error(err); addMessage("通信エラーが発生しました。", 'system'); }
    }

    function init() {
        loadUserPreferences();
        els.input.addEventListener('input', (e) => { state.searchText = e.target.value; renderView(); });
        window.addEventListener('resize', updateLayoutMetrics);
        loadCachedData();
        fetchAllData(); setInterval(fetchAllData, CONFIG.refreshInterval);
    }
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>


